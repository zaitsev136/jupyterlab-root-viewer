(function(e){if("function"===typeof define&&define.amd)define("JSRootPainter d3 threejs dat.gui JSRoot3DPainter JSRootGeoBase".split(" "),e);else if("object"===typeof exports&&"undefined"!==typeof module){var v=require("./JSRootCore.js");v.nodejs||"undefined"==typeof window||require("./dat.gui.min.js");e(v,require("d3"),require("three"),require("./JSRoot3DPainter.js"),require("./JSRootGeoBase.js"),v.nodejs||"undefined"==typeof document?v.nodejs_document:document)}else{if("undefined"==typeof JSROOT)throw Error("JSROOT is not defined",
"JSRootGeoPainter.js");if("object"!=typeof JSROOT.Painter)throw Error("JSROOT.Painter is not defined","JSRootGeoPainter.js");if("undefined"==typeof d3)throw Error("d3 is not defined","JSRootGeoPainter.js");if("undefined"==typeof THREE)throw Error("THREE is not defined","JSRootGeoPainter.js");if("undefined"==typeof dat)throw Error("dat.gui is not defined","JSRootGeoPainter.js");e(JSROOT,d3,THREE)}})(function(e,v,h,C,D,z){function A(a,b,c){this.bright=c;void 0!==a&&"function"==typeof a.append&&(this.element=
a.append("div").attr("class","jsroot"),this.addButtons(b))}function f(a){a&&"TGeoManager"===a._typename&&(this.geo_manager=a,a=a.fMasterVolume);a&&0===a._typename.indexOf("TGeoVolume")&&(a={_typename:"TGeoNode",fVolume:a,fName:a.fName,$geoh:a.$geoh,_proxy:!0});e.TObjectPainter.call(this,a);this.mode3d=this.no_default_title=!0;this.drawing_stage=0;this.Cleanup(!0)}function B(a){e.Painter.InteractiveControl.call(this);this.mesh=a&&a.material?a:null}e.sources.push("geom");"undefined"==typeof z&&"object"==
typeof window&&(z=window.document);"function"===typeof define&&define.amd&&e.loadScript("$$$style/JSRootGeoPainter.css");"object"!==typeof e.GEO&&console.error("JSROOT.GEO namespace is not defined");A.prototype.addButtons=function(a){var b=this;this.buttonsNames=[];a.forEach(function(a){var c=b.element.append("div").attr("class","toolbar-group");a.forEach(function(a){var d=a.name;if(!d)throw Error("must provide button 'name' in button config");if(-1!==b.buttonsNames.indexOf(d))throw Error("button name '"+
d+"' is taken");b.buttonsNames.push(d);b.createButton(c,a)})})};A.prototype.createButton=function(a,b){var c=b.title;void 0===c&&(c=b.name);if("function"!==typeof b.click)throw Error("must provide button 'click' function in button config");a=a.append("a").attr("class",this.bright?"toolbar-btn-bright":"toolbar-btn").attr("rel","tooltip").attr("data-title",c).on("click",b.click);this.createIcon(a,b.icon||e.ToolbarIcons.question)};A.prototype.changeBrightness=function(a){this.bright=a;this.element&&
this.element.selectAll(a?".toolbar-btn":".toolbar-btn-bright").attr("class",a?"toolbar-btn-bright":"toolbar-btn")};A.prototype.createIcon=function(a,b){var c=b.size?b.size.split(" "):[512,512],d=c[0],k=c[1]||c[0];c=b.scale||1;a=a.append("svg:svg").attr("height","1em").attr("width","1em").attr("viewBox",[0,0,d,k].join(" "));if("recs"in b)for(c={},d=0;d<b.recs.length;++d)e.extend(c,b.recs[d]),a.append("rect").attr("x",c.x).attr("y",c.y).attr("width",c.w).attr("height",c.h).attr("fill",c.f);else b=a.append("svg:path").attr("d",
b.path),1!==c&&b.attr("transform","scale("+c+" "+c+")")};A.prototype.removeAllButtons=function(){this.element.remove()};f.prototype=Object.create(e.TObjectPainter.prototype);f.prototype.CreateToolbar=function(a){if(!(this._toolbar||this._usesvg||this._usesvgimg)){var b=this;a=[{name:"toImage",title:"Save as PNG",icon:e.ToolbarIcons.camera,click:function(){b.Render3D(0);var a=b._renderer.domElement.toDataURL("image/png");a.replace("image/png","image/octet-stream");var c=z.createElement("a");"string"===
typeof c.download&&(z.body.appendChild(c),c.download="geometry.png",c.href=a,c.click(),z.body.removeChild(c))}}];a.push({name:"control",title:"Toggle control UI",icon:e.ToolbarIcons.rect,click:function(){b.showControlOptions("toggle")}});a.push({name:"enlarge",title:"Enlarge geometry drawing",icon:e.ToolbarIcons.circle,click:function(){b.ToggleEnlarge()}});navigator.getVRDisplays&&(a.push({name:"entervr",title:"Enter VR (It requires a VR Headset connected)",icon:e.ToolbarIcons.vrgoggles,click:function(){b.ToggleVRMode()}}),
this.InitVRMode());e.gStyle.ContextMenu&&a.push({name:"menu",title:"Show context menu",icon:e.ToolbarIcons.question,click:function(){v.event.preventDefault();v.event.stopPropagation();var a=v.event;e.Painter.closeMenu()||e.Painter.createMenu(b,function(b){b.painter.FillContextMenu(b);b.show(a)})}});var c=new h.Color(this.options.background);this._toolbar=new A(this.select_main(),[a],1>c.r+c.g+c.b)}};f.prototype.InitVRMode=function(){var a=this;this._dolly=new h.Group;this._scene.add(this._dolly);
this._standingMatrix=new h.Matrix4;this._raycasterEnd=new h.Vector3;this._raycasterOrigin=new h.Vector3;navigator.getVRDisplays().then(function(b){if(b=b[0])a._renderer.vr.setDevice(b),a._vrDisplay=b,a._standingMatrix.fromArray(b.stageParameters.sittingToStandingTransform),a.InitVRControllersGeometry()})};f.prototype.InitVRControllersGeometry=function(){var a=new h.SphereGeometry(.025,18,36),b=new h.MeshBasicMaterial({color:"grey"}),c=new h.MeshBasicMaterial({color:"fuchsia"}),d=new h.BoxBufferGeometry(.001,
.001,2),e=new h.Mesh(d,c);c=new h.Mesh(d,c);d=new h.Mesh(a,b);a=new h.Mesh(a,b);this._controllersMeshes=[];this._controllersMeshes.push(d);this._controllersMeshes.push(a);--e.position.z;--c.position.z;d.add(e);a.add(c);this._dolly.add(d);this._dolly.add(a);d.visible=!1;a.visible=!1};f.prototype.UpdateVRControllersList=function(){var a=navigator.getGamepads&&navigator.getGamepads();if(!this.vrControllers||a.length!==this.vrControllers.length){this._controllersMeshes.forEach(function(a){a.visible=!1});
this._vrControllers=[];for(var b=0;b<a.length;++b)a[b].pose&&(this._vrControllers.push({gamepad:a[b],mesh:this._controllersMeshes[b]}),this._controllersMeshes[b].visible=!0)}};f.prototype.ProcessVRControllerIntersections=function(){for(var a=[],b=0;b<this._vrControllers.length;++b){var c=this._vrControllers[b].mesh,d=c.localToWorld(this._raycasterEnd.set(0,0,-1));c=c.localToWorld(this._raycasterOrigin.set(0,0,0));d.sub(c).normalize();a=a.concat(this._controls.GetOriginDirectionIntersects(c,d))}a=
a.filter(function(b,c){return a.indexOf(b)===c});this._controls.ProcessMouseMove(a)};f.prototype.UpdateVRControllers=function(){this.UpdateVRControllersList();for(var a=0;a<this._vrControllers.length;++a){var b=this._vrControllers[a],c=b.gamepad.pose.orientation,d=b.gamepad.pose.position;b=b.mesh;c&&b.quaternion.fromArray(c);d&&b.position.fromArray(d);b.updateMatrix();b.applyMatrix(this._standingMatrix);b.matrixWorldNeedsUpdate=!0}this.ProcessVRControllerIntersections()};f.prototype.ToggleVRMode=
function(){var a=this;this._vrDisplay&&(this._vrDisplay.isPresenting?this.ExitVRMode():(this._previousCameraPosition=this._camera.position.clone(),this._previousCameraRotation=this._camera.rotation.clone(),this._vrDisplay.requestPresent([{source:this._renderer.domElement}]).then(function(){a._previousCameraNear=a._camera.near;a._dolly.add(a._camera);a._camera.near=.1;a._camera.updateProjectionMatrix();a._renderer.vr.enabled=!0;a._renderer.setAnimationLoop(function(){a.UpdateVRControllers();a.Render3D(0)})}),
this._renderer.vr.enabled=!0,window.addEventListener("keydown",function(b){27===b.keyCode&&a.ExitVRMode()})))};f.prototype.ExitVRMode=function(){this._vrDisplay.isPresenting&&(this._renderer.vr.enabled=!1,this._dolly.remove(this._camera),this._scene.add(this._camera),this._camera.position.copy(this._previousCameraPosition),this._previousCameraPosition=void 0,this._camera.rotation.copy(this._previousCameraRotation),this._previousCameraRotation=void 0,this._camera.near=this._previousCameraNear,this._camera.updateProjectionMatrix(),
this._vrDisplay.exitPresent())};f.prototype.GetGeometry=function(){return this.GetObject()};f.prototype.ModifyVisisbility=function(a,b){if(0===e.GEO.NodeKind(this.GetGeometry())){if(""==a)return e.GEO.SetBit(this.GetGeometry().fVolume,e.GEO.BITS.kVisThis,"+"===b);var c=!1;0>a.indexOf("*")?(a=new RegExp("^"+a+"$"),c=!0):(a=new RegExp("^"+a.split("*").join(".*")+"$"),c=!1);this.FindNodeWithVolume(a,function(a){e.GEO.InvisibleAll.call(a.node.fVolume,"+"!==b);return c?a:null})}};f.prototype.decodeOptions=
function(a){"string"!=typeof a&&(a="");var b={_grid:!1,_bound:!1,_debug:!1,_full:!1,_axis:!1,_axis_center:!1,_count:!1,wireframe:!1,scale:new h.Vector3(1,1,1),zoom:1,more:1,maxlimit:1E5,maxnodeslimit:3E3,use_worker:!1,update_browser:!0,show_controls:!1,highlight:!1,highlight_scene:!1,select_in_view:!1,project:"",is_main:!1,tracks:!1,ortho_camera:!1,clipx:!1,clipy:!1,clipz:!1,ssao:!1,script_name:"",transparency:0,autoRotate:!1,background:"#FFFFFF",depthMethod:"ray"},c=e.GetUrlOption("_grid");null!==
c&&"true"==c&&(b._grid=!0);c=e.GetUrlOption("_debug");null!==c&&"true"==c&&(b._debug=!0,b._grid=!0);null!==c&&"bound"==c&&(b._debug=!0,b._grid=!0,b._bound=!0);null!==c&&"full"==c&&(b._debug=!0,b._grid=!0,b._full=!0,b._bound=!0);c=a.indexOf("macro:");if(0<=c){var d=a.indexOf(";",c+6);0>d&&(d=a.length);b.script_name=a.substr(c+6,d-c-6);a=a.substr(0,c)+a.substr(d+1);console.log("script",b.script_name,"rest",a)}for(;;){var k=a.indexOf("+"),g=a.indexOf("-");if(0>k&&0>g)break;c=k;d="+";if(0>c||0<=g&&g<
k)c=g,d="-";k=c+1;for(g=/[,; .]/;k<a.length&&!g.test(a[k])&&"+"!=a[k]&&"-"!=a[k];)k++;g=a.substring(c+1,k);a=a.substr(0,c)+a.substr(k);this.ModifyVisisbility(g,d)}a=new e.DrawOptions(a);a.check("MAIN")&&(b.is_main=!0);a.check("TRACKS")&&(b.tracks=!0);a.check("ORTHO_CAMERA")&&(b.ortho_camera=!0);if(a.check("DEPTHRAY")||a.check("DRAY"))b.depthMethod="ray";if(a.check("DEPTHBOX")||a.check("DBOX"))b.depthMethod="box";if(a.check("DEPTHPNT")||a.check("DPNT"))b.depthMethod="pnt";if(a.check("DEPTHSIZE")||
a.check("DSIZE"))b.depthMethod="size";if(a.check("DEPTHDFLT")||a.check("DDFLT"))b.depthMethod="dflt";a.check("ZOOM",!0)&&(b.zoom=a.partAsInt(0,100)/100);a.check("BLACK")&&(b.background="#000000");a.check("WHITE")&&(b.background="#FFFFFF");if(a.check("BKGR_",!0)){c=null;if(0<a.partAsInt(1))c=e.Painter.root_colors[a.partAsInt()];else for(d=0;8>d;++d)e.Painter.root_colors[d].toUpperCase()===a.part&&(c=e.Painter.root_colors[d]);c&&(b.background="#"+(new h.Color(c)).getHexString())}a.check("MORE3")&&(b.more=
3);a.check("MORE")&&(b.more=2);a.check("ALL")&&(b.more=100);if(a.check("CONTROLS")||a.check("CTRL"))b.show_controls=!0;a.check("CLIPXYZ")&&(b.clipx=b.clipy=b.clipz=!0);a.check("CLIPX")&&(b.clipx=!0);a.check("CLIPY")&&(b.clipy=!0);a.check("CLIPZ")&&(b.clipz=!0);a.check("CLIP")&&(b.clipx=b.clipy=b.clipz=!0);a.check("PROJX",!0)&&(b.project="x",0<a.partAsInt(1)&&(b.projectPos=a.partAsInt()));a.check("PROJY",!0)&&(b.project="y",0<a.partAsInt(1)&&(b.projectPos=a.partAsInt()));a.check("PROJZ",!0)&&(b.project=
"z",0<a.partAsInt(1)&&(b.projectPos=a.partAsInt()));(a.check("DFLT_COLORS")||a.check("DFLT"))&&this.SetRootDefaultColors();a.check("SSAO")&&(b.ssao=!0);a.check("NOWORKER")&&(b.use_worker=-1);a.check("WORKER")&&(b.use_worker=1);if(a.check("NOHIGHLIGHT")||a.check("NOHIGH"))b.highlight=b.highlight_scene=0;a.check("HIGHLIGHT")&&(b.highlight_scene=b.highlight=!0);a.check("HSCENEONLY")&&(b.highlight_scene=!0,b.highlight=0);a.check("NOHSCENE")&&(b.highlight_scene=0);a.check("HSCENE")&&(b.highlight_scene=
!0);a.check("WIRE")&&(b.wireframe=!0);a.check("ROTATE")&&(b.autoRotate=!0);if(a.check("INVX")||a.check("INVERTX"))b.scale.x=-1;if(a.check("INVY")||a.check("INVERTY"))b.scale.y=-1;if(a.check("INVZ")||a.check("INVERTZ"))b.scale.z=-1;a.check("COUNT")&&(b._count=!0);a.check("TRANSP",!0)&&(b.transparency=a.partAsInt(0,100)/100);a.check("OPACITY",!0)&&(b.transparency=1-a.partAsInt(0,100)/100);if(a.check("AXISCENTER")||a.check("AC"))b._axis=!0,b._axis_center=!0;if(a.check("AXIS")||a.check("A"))b._axis=!0;
a.check("D")&&(b._debug=!0);a.check("G")&&(b._grid=!0);a.check("B")&&(b._bound=!0);a.check("W")&&(b.wireframe=!0);a.check("F")&&(b._full=!0);a.check("Y")&&(b._yup=!0);a.check("Z")&&(b._yup=!1);void 0===b._yup&&(b._yup=this.svg_canvas().empty());return b};f.prototype.ActivateInBrowser=function(a,b){"string"==typeof a&&(a=[a]);this._hpainter&&(this._hpainter.activate(a,b),this.options.update_browser||setTimeout(this._hpainter.activate.bind(this._hpainter,[]),2E3))};f.prototype.TestMatrixes=function(){var a=
this,b=0,c=0,d=0;tm1=(new Date).getTime();this._clones.ScanVisible({domatrix:!0,func:function(e){e=this.getmatrix();var k=this.CopyStack(),l=a._clones.CreateObject3D(k.stack,a._toplevel,"mesh");if(!l)return!0;c++;l=l.matrixWorld;if(l.equals(e))return!0;if(0<l.determinant()&&-.9>e.determinant()){var m=h.Vector3(1,1,-1);e=e.clone().scale(m);if(l.equals(e))return!0}for(var r=m=0;16>r;++r)m=Math.max(m,Math.abs(l.elements[r]-e.elements[r]));d=Math.max(m,d);if(1E-4>m)return!0;console.log(a._clones.ResolveStack(k.stack).name,
"maxdiff",m,"determ",l.determinant(),e.determinant());b++;return!1}});tm2=(new Date).getTime();console.log("Compare matrixes total",c,"errors",b,"takes",tm2-tm1,"maxdiff",d)};f.prototype.FillContextMenu=function(a){a.add("header: Draw options");a.addchk(this.options.update_browser,"Browser update",function(){this.options.update_browser=!this.options.update_browser;this.options.update_browser||this.ActivateInBrowser([])});a.addchk(this.options.show_controls,"Show Controls",function(){this.showControlOptions("toggle")});
a.addchk(this.TestAxisVisibility,"Show axes",function(){this.toggleAxisDraw()});a.addchk(this.options.wireframe,"Wire frame",function(){this.options.wireframe=!this.options.wireframe;this.changeWireFrame(this._scene,this.options.wireframe)});a.addchk(this.options.highlight,"Highlight volumes",function(){this.options.highlight=!this.options.highlight});a.addchk(this.options.highlight_scene,"Highlight scene",function(){this.options.highlight_scene=!this.options.highlight_scene});a.add("Reset camera position",
function(){this.focusCamera();this.Render3D()});this.options.project||a.addchk(this.options.autoRotate,"Autorotate",function(){this.options.autoRotate=!this.options.autoRotate;this.autorotate(2.5)});a.addchk(this.options.select_in_view,"Select in view",function(){this.options.select_in_view=!this.options.select_in_view;this.options.select_in_view&&this.startDrawGeometry()})};f.prototype.changeGlobalTransparency=function(a,b){var c="function"==typeof a?a:null;c&&(a=this.options.transparency);this._toplevel.traverse(function(b){if(b&&
b.material&&void 0!==b.material.inherentOpacity){var d=c?c(b):void 0;b.material.opacity=void 0!==d?1-d:Math.min(1-(a||0),b.material.inherentOpacity);b.material.transparent=1>b.material.opacity}});b||this.Render3D(-1)};f.prototype.showControlOptions=function(a){function b(a){a?c._datgui._ssao||(c._datgui._ssao=c._datgui.addFolder("SSAO"),c._datgui._ssao.add(c._ssaoPass,"output",{Default:h.SSAOPass.OUTPUT.Default,"SSAO Only":h.SSAOPass.OUTPUT.SSAO,"SSAO Only + Blur":h.SSAOPass.OUTPUT.Blur,Beauty:h.SSAOPass.OUTPUT.Beauty,
Depth:h.SSAOPass.OUTPUT.Depth,Normal:h.SSAOPass.OUTPUT.Normal}).onChange(function(a){c._ssaoPass.output=parseInt(a);c.Render3D()}),c._datgui._ssao.add(c._ssaoPass,"kernelRadius",0,32).listen().onChange(function(){c.Render3D()}),c._datgui._ssao.add(c._ssaoPass,"minDistance",.001,.02).listen().onChange(function(){c.Render3D()}),c._datgui._ssao.add(c._ssaoPass,"maxDistance",.01,.3).listen().onChange(function(){c.Render3D()})):(c._datgui._ssao&&(a=c._datgui._ssao.domElement,a.parentNode.removeChild(a),
c._datgui._ssao.destroy(),c._datgui.__folders&&c._datgui.__folders.SSAO&&(c._datgui.__folders.SSAO=void 0)),delete c._datgui._ssao)}"toggle"===a&&(a=!this._datgui);this.options.show_controls=a;if(this._datgui)a||(v.select(this._datgui.domElement).remove(),this._datgui.destroy(),delete this._datgui);else if(a){var c=this;this._datgui=new dat.GUI({autoPlace:!1,width:Math.min(650,c._renderer.domElement.width/2)});a=this.select_main();"static"==a.style("position")&&a.style("position","relative");v.select(this._datgui.domElement).style("position",
"absolute").style("top",0).style("right",0);a.node().appendChild(this._datgui.domElement);if(this.options.project){a=this.getGeomBoundingBox(this.getProjectionSource(),.01);var d=this.options.project;void 0===this.options.projectPos&&(this.options.projectPos=(a.min[d]+a.max[d])/2);this._datgui.add(this.options,"projectPos",a.min[d],a.max[d]).name(d.toUpperCase()+" projection").onChange(function(a){c.startDrawGeometry()})}else{a=this.getGeomBoundingBox(this._toplevel,.01);for(var e=this._datgui.addFolder("Clipping"),
g=0;3>g;++g){d=g?1===g?"y":"z":"x";var l=d.toUpperCase();e.add(this,"enable"+l).name("Enable "+l).listen().onChange(function(a){a&&(b(!1),c._enableSSAO=!1,c._enableClipping=!0);c.updateClipping()});var m="clip"+l;0===this[m]&&(this[m]=(a.min[d]+a.max[d])/2);e.add(this,m,a.min[d],a.max[d]).name(l+" Position").onChange(function(a){c[this.enbale_flag]&&c.updateClipping()}).enbale_flag="enable"+l}}a=this._datgui.addFolder("Appearance");a.add(this.options,"highlight").name("Highlight Selection").listen().onChange(function(a){a||
c.HighlightMesh(null)});a.add(this.options,"transparency",0,1,.001).listen().onChange(this.changeGlobalTransparency.bind(this));a.add(this.options,"wireframe").name("Wireframe").listen().onChange(function(a){c.changeWireFrame(c._scene,c.options.wireframe)});a.addColor(this.options,"background").name("Background").onChange(function(){c._renderer.setClearColor(c.options.background,1);c.Render3D(0);var a=new h.Color(c.options.background);c._toolbar.changeBrightness(1>a.r+a.g+a.b)});a.add(this,"focusCamera").name("Reset camera position");
this._webgl&&(a=this._datgui.addFolder("Advanced"),a.add(this,"_enableSSAO").name("Smooth Lighting (SSAO)").onChange(function(a){c._enableSSAO&&c.createSSAO();b(c._enableSSAO);c._enableClipping=!c._enableSSAO;c.updateClipping()}).listen(),a.add(this,"_clipIntersection").name("Clip intersection").listen().onChange(function(a){c.updateClipping()}),a.add(this,"_depthTest").name("Depth test").onChange(function(a){c._toplevel.traverse(function(b){b instanceof h.Mesh&&(b.material.depthTest=a)});c.Render3D(0)}).listen(),
a.add(this.options,"depthMethod",{Default:"dflt",Raytraicing:"ray","Boundary box":"box","Mesh size":"size","Central point":"pnt"}).name("Rendering order").onChange(function(a){delete c._last_camera_position;c.Render3D()}),a.add(this,"resetAdvanced").name("Reset"));b(this._enableSSAO&&this._ssaoPass)}};f.prototype.createSSAO=function(){this._webgl&&!this._ssaoPass&&(this._ssaoPass=new h.SSAOPass(this._scene,this._camera,this._scene_width,this._scene_height),this._ssaoPass.kernelRadius=16,this._ssaoPass.renderToScreen=
!0,this._effectComposer=new h.EffectComposer(this._renderer),this._effectComposer.addPass(this._ssaoPass))};f.prototype.OrbitContext=function(a,b){e.Painter.createMenu(this,function(c){var d=0,k=0,g=0;if(b)for(var l=0;l<b.length;++l)b[l].object.stack&&k++,b[l].object.geo_name&&d++;if(0===k+d)c.painter.FillContextMenu(c);else for((k=1<k+d)&&c.add("header:"+(0<d?"Items":"Nodes")),l=0;l<b.length;++l){d=b[l].object;var m;if(d.geo_name){var h=d.geo_name;0==h.indexOf("<prnt>")&&(h=(this.GetItemName()||
"top")+h.substr(6));(m=h.substr(h.lastIndexOf("/")+1))||(m=h);var f=m}else if(d.stack)m=c.painter._clones.ResolveStack(d.stack).name,h=c.painter.GetStackFullName(d.stack),f=c.painter.GetItemName(),0===m.indexOf("Nodes/")?f=m.substr(6):0<m.length?f=m:f||(f="header");else continue;c.add((k?"sub:":"header:")+f,h,function(a){this.ActivateInBrowser([a],!0)});c.add("Browse",h,function(a){this.ActivateInBrowser([a],!0)});c.painter._hpainter&&c.add("Inspect",h,function(a){this._hpainter.display(h,"inspect")});
d.geo_name?c.add("Hide",l,function(a){a=b[a].object;a.visible=!1;a.geo_object&&(a.geo_object.$hidden_via_menu=!0);c.painter.Render3D()}):(d=c.painter.accessObjectWireFrame(d),void 0!==d&&c.addchk(d,"Wireframe",l,function(a){a=b[a].object.material;a.wireframe=!a.wireframe;this.Render3D()}),1<++g&&c.add("Manifest",l,function(a){this._last_manifest&&(this._last_manifest.wireframe=!this._last_manifest.wireframe);this._last_hidden&&this._last_hidden.forEach(function(a){a.visible=!0});this._last_hidden=
[];for(var c=0;c<a;++c)this._last_hidden.push(b[c].object);this._last_hidden.forEach(function(a){a.visible=!1});this._last_manifest=b[a].object.material;this._last_manifest.wireframe=!this._last_manifest.wireframe;this.Render3D()}),c.add("Focus",l,function(a){this.focusCamera(b[a].object)}),c.painter._geom_viewer||c.add("Hide",l,function(a){a=c.painter._clones.ResolveStack(b[a].object.stack);a.obj&&0===a.node.kind&&a.obj.fVolume?(e.GEO.SetBit(a.obj.fVolume,e.GEO.BITS.kVisThis,!1),e.GEO.updateBrowserIcons(a.obj.fVolume,
this._hpainter)):a.obj&&1===a.node.kind&&(a.obj.fRnrSelf=!1,e.GEO.updateBrowserIcons(a.obj,this._hpainter));this.testGeomChanges()}));k&&c.add("endsub:")}c.show(a)})};f.prototype.FilterIntersects=function(a){if(!a.length)return a;for(var b=0;b<a.length;++b)a[b].object.geo_highlight&&(a[b].object=a[b].object.geo_highlight);for(b=a.length-1;0<=b;--b){var c=a[b].object,d=void 0!==c.stack||void 0!==c.geo_name;d&&c.material&&void 0!==c.material.opacity&&(d=.1<=c.material.opacity);c.jsroot_special&&(d=
!1);for(var e=0;e<b&&d;++e)a[e].object===c&&(d=!1);d||a.splice(b,1)}if(this.enableX||this.enableY||this.enableZ){b=[];for(c=0;c<a.length;++c){d=a[c].point;e="Points"==a[c].object.type;var g=!0,l;if(l=this.enableX)l=(l=this._clipPlanes[0].normal.dot(d)>this._clipPlanes[0].constant)&&!e||!l&&e;l&&(g=!1);if(l=this.enableY)l=(l=this._clipPlanes[1].normal.dot(d)>this._clipPlanes[1].constant)&&!e||!l&&e;l&&(g=!1);this.enableZ&&this._clipPlanes[2].normal.dot(d)>this._clipPlanes[2].constant&&(g=!1);g||b.push(a[c])}a=
b}return a};f.prototype.testCameraPositionChange=function(){if(this.options.select_in_view&&!this._draw_all_nodes){var a=e.GEO.CreateProjectionMatrix(this._camera);e.GEO.CreateFrustum(a).CheckBox(this.getGeomBoundingBox(this._toplevel))||this.startDrawGeometry()}};f.prototype.ResolveStack=function(a){return this._clones&&a?this._clones.ResolveStack(a):null};f.prototype.GetStackFullName=function(a){var b=this.GetItemName();return(a=this.ResolveStack(a))&&a.name?b?b+"/"+a.name:a.name:b};f.prototype.AddHighlightHandler=
function(a){a&&"function"==typeof a.HighlightMesh&&(this._highlight_handlers||(this._highlight_handlers=[]),this._highlight_handlers.push(a))};B.prototype=Object.create(e.Painter.InteractiveControl.prototype);B.prototype.setHighlight=function(a,b){return this.drawSpecial(a,b)};B.prototype.drawSpecial=function(a,b){if((b=this.mesh)&&b.material){if(a)return b.origin||(b.origin={color:b.material.color,opacity:b.material.opacity,width:b.material.linewidth,size:b.material.size}),b.material.color=new h.Color(a),
b.material.opacity=1,b.hightlightWidthScale&&!e.browser.isWin&&(b.material.linewidth=b.origin.width*b.hightlightWidthScale),b.highlightScale&&(b.material.size=b.origin.size*b.highlightScale),!0;if(b.origin)return b.material.color=b.origin.color,b.material.opacity=b.origin.opacity,b.hightlightWidthScale&&(b.material.linewidth=b.origin.width),b.highlightScale&&(b.material.size=b.origin.size),!0}};f.prototype.HighlightMesh=function(a,b,c,d,k,g){function l(a){return a.get_ctrl?a.get_ctrl():new B(a)}if(c){a=
a?[a]:[];var m=this.getExtrasContainer();m&&m.traverse(function(b){b.geo_object===c&&0>a.indexOf(b)&&a.push(b)})}else k&&this._toplevel?(a=[],this._toplevel.traverse(function(b){b instanceof h.Mesh&&e.GEO.IsSameStack(b.stack,k)&&a.push(b)})):a=a?[a]:[];a.length||(a=null);a&&(a[0].geo_object?this.options.highlight_scene||(a=null):this.options.highlight||(a=null));if(!g)for(a&&(c||(c=a[0].geo_object),k||(k=a[0].stack)),m=this._highlight_handlers||(this._main_painter?this._main_painter._slave_painters.concat([this._main_painter]):
this._slave_painters),g=0;g<m.length;++g)m[g]!==this&&m[g].HighlightMesh(null,b,c,d,k,!0);m=this._selected_mesh;if(!m&&!a)return!1;var f=!1;if(m&&a&&m.length==a.length)for(f=!0,g=0;g<m.length&&f;++g)if(m[g]!==a[g]||l(m[g]).checkHighlightIndex(d))f=!1;if(f)return!!m;if(m)for(g=0;g<m.length;++g)l(m[g]).setHighlight();if(this._selected_mesh=a)for(g=0;g<a.length;++g)l(a[g]).setHighlight(b||16755251,d);this.Render3D(0);return!!a};f.prototype.ProcessMouseClick=function(a,b,c){b.length&&(a=b[0].object,a.get_ctrl&&
(a=a.get_ctrl(),b=a.extractIndex(b[0]),a.evnt=c,a.setSelected("blue",b)&&this.Render3D(),a.evnt=null))};f.prototype.addOrbitControls=function(){if(!(this._controls||this._usesvg||e.BatchMode)){var a=this;this.SetTooltipAllowed(0<e.gStyle.Tooltip);this._controls=e.Painter.CreateOrbitControl(this,this._camera,this._scene,this._renderer,this._lookat);if(this.options.project||this.options.ortho_camera)this._controls.enableRotate=!1;this._controls.ContextMenu=this.OrbitContext.bind(this);this._controls.ProcessMouseMove=
function(b){for(var c=null,d=null,k=null,g=[],l,m,h=0;h<b.length;++h){var f=b[h].object,p=null;f&&(f.geo_object?p=f.geo_name:f.stack&&(p=a.GetStackFullName(f.stack)),p&&(0==p.indexOf("<prnt>")&&(p=a.GetItemName()+p.substr(6)),g.push(p),c||(c=f,d=p,l=f.geo_object,f.get_ctrl&&(m=f.get_ctrl().extractIndex(b[h]),void 0!==m&&"string"==typeof d&&(d+=" indx:"+JSON.stringify(m))),c.stack&&(k=a.ResolveStack(c.stack)))))}a.HighlightMesh(c,void 0,l,m);a.options.update_browser&&(a.options.highlight&&d&&(g=[d]),
a.ActivateInBrowser(g));if(!k||!k.obj)return d;b=e.GEO.provideInfo(k.obj);b.unshift(d);return{name:k.obj.fName,title:k.obj.fTitle||k.obj._typename,lines:b}};this._controls.ProcessMouseLeave=function(){this.ProcessMouseMove([])};this._controls.ProcessDblClick=function(){a._last_manifest?(a._last_manifest.wireframe=!a._last_manifest.wireframe,a._last_hidden&&a._last_hidden.forEach(function(a){a.visible=!0}),delete a._last_hidden,delete a._last_manifest,a.Render3D()):a.adjustCameraPosition()}}};f.prototype.addTransformControl=
function(){if(!this._tcontrols&&(this.options._debug||this.options._grid)){this._tcontrols=new h.TransformControls(this._camera,this._renderer.domElement);this._scene.add(this._tcontrols);this._tcontrols.attach(this._toplevel);var a=this;window.addEventListener("keydown",function(b){switch(b.keyCode){case 81:a._tcontrols.setSpace("local"===a._tcontrols.space?"world":"local");break;case 17:a._tcontrols.setTranslationSnap(Math.ceil(a._overall_size)/50);a._tcontrols.setRotationSnap(h.Math.degToRad(15));
break;case 84:a._tcontrols.setMode("translate");break;case 82:a._tcontrols.setMode("rotate");break;case 83:a._tcontrols.setMode("scale");break;case 187:case 107:a._tcontrols.setSize(a._tcontrols.size+.1);break;case 189:case 109:a._tcontrols.setSize(Math.max(a._tcontrols.size-.1,.1))}});window.addEventListener("keyup",function(b){switch(b.keyCode){case 17:a._tcontrols.setTranslationSnap(null),a._tcontrols.setRotationSnap(null)}});this._tcontrols.addEventListener("change",function(){a.Render3D(0)})}};
f.prototype.nextDrawAction=function(){if(!this._clones||0==this.drawing_stage)return!1;if(1==this.drawing_stage){if(this._geom_viewer)return this._draw_all_nodes=!1,this.drawing_stage=3,!0;if(0<this.options.use_worker){if(!this._worker)return this.startWorker(),1;if(!this._worker_ready)return 1}var a=this._clones.MarkVisisble(),b=null,c=null;this.options.select_in_view&&!this._first_drawing&&(b=e.GEO.CreateProjectionMatrix(this._camera),c=e.GEO.CreateFrustum(b),c.CheckBox(this.getGeomBoundingBox(this._toplevel))&&
(c=b=null));this._current_face_limit=this.options.maxlimit;this._current_nodes_limit=this.options.maxnodeslimit;b&&(this._current_face_limit*=1.25,this._current_nodes_limit*=1.25);(a=!e.BatchMode&&(1E4<a||b&&1E5<this._clones.ScanVisible()))&&0==e.source_dir.indexOf("file://")&&(console.log("disable worker for jsroot from file system"),a=!1);a&&!this._worker&&0<=this.options.use_worker&&this.startWorker();if(!a||!this._worker_ready)return b=this._clones.CollectVisibles(this._current_face_limit,c,this._current_nodes_limit),
this._new_draw_nodes=b.lst,this._draw_all_nodes=b.complete,this.drawing_stage=3,!0;c={collect:this._current_face_limit,collect_nodes:this._current_nodes_limit,visible:this._clones.GetVisibleFlags(),matrix:b?b.elements:null};this.submitToWorker(c);this.drawing_stage=2;this.drawing_log="Worker select visibles";return 2}if(2==this.drawing_stage)return this.drawing_log="Worker select visibles",2;if(3==this.drawing_stage){this.drawing_log="Analyse visibles";if(this._new_append_nodes)this._new_draw_nodes=
this._draw_nodes.concat(this._new_append_nodes),delete this._new_append_nodes;else if(this._draw_nodes){c=this._geom_viewer?this._draw_nodes:this._clones.MergeVisibles(this._new_draw_nodes,this._draw_nodes);for(b=0;b<c.length;++b)this._clones.CreateObject3D(c[b].stack,this._toplevel,"delete_mesh");0<c.length&&(this.drawing_log="Delete "+c.length+" nodes")}this._draw_nodes=this._new_draw_nodes;delete this._new_draw_nodes;this.drawing_stage=4;return!0}if(4===this.drawing_stage)return this.drawing_log=
"Collect shapes",b=this._clones.CollectShapes(this._draw_nodes),this._build_shapes=this._clones.MergeShapesLists(this._build_shapes,b),this.drawing_stage=5,!0;if(5===this.drawing_stage){if(this.canSubmitToWorker()){c={limit:this._current_face_limit,shapes:[]};for(b=a=0;b<this._build_shapes.length;++b){var d=this._build_shapes[b];d.ready||d.geom?d={id:d.id,ready:!0,nfaces:e.GEO.numGeometryFaces(d.geom),refcnt:d.refcnt}:(d=e.clone(d,null,!0),a++);c.shapes.push(d)}if(0<a)return this.submitToWorker(c),
this.drawing_log="Worker build shapes",this.drawing_stage=6,2}this.drawing_stage=7}if(6===this.drawing_stage)return 2;if(7===this.drawing_stage||8===this.drawing_stage){if(7===this.drawing_stage)if(b=this._clones.BuildShapes(this._build_shapes,this._current_face_limit,500),b.done)this.drawing_stage=8;else if(this.drawing_log="Creating: "+b.shapes+" / "+this._build_shapes.length+" shapes,  "+b.faces+" faces",30>b.notusedshapes)return!0;c=(new Date).getTime();a=!0;d=this.options.project?this._full_geom:
this._toplevel;for(b=0;b<this._draw_nodes.length;++b){var k=this._draw_nodes[b];if(!k.done){var g=k.server_shape||this._build_shapes[k.shapeid];if(g.ready){if(k.done=!0,g.used=!0,this.createEntryMesh(k,g,d)&&(this._num_meshes++,this._num_faces+=g.nfaces),500<(new Date).getTime()-c){a=!1;break}}else 8===this.drawing_stage&&console.warn("shape marked as not ready when should"),a=!1}}if(a){if(this.options.project)return this.drawing_log="Build projection",this.drawing_stage=10,!0;this.drawing_log="Building done";
this.drawing_stage=0;return!1}7<this.drawing_stage&&(this.drawing_log="Building meshes "+this._num_meshes+" / "+this._num_faces);return!0}if(9===this.drawing_stage){if(!this._main_painter)return console.warn("MAIN PAINTER DISAPPER"),this.drawing_stage=0,!1;if(!this._main_painter._drawing_ready)return 1;this.drawing_stage=10}if(10===this.drawing_stage)return this.doProjection(),this.drawing_log="Building done",this.drawing_stage=0,!1;console.error("never come here stage = "+this.drawing_stage);return!1};
f.prototype.createEntryMesh=function(a,b,c){if(!b.geom||0===b.nfaces)return this._clones.CreateObject3D(a.stack,c,"delete_mesh"),!1;this._splitColors&&a.stack&&(0===a.stack[0]?a.custom_color="green":1===a.stack[0]&&(a.custom_color="blue"));var d=this._clones.getDrawEntryProperties(a);c=this._clones.CreateObject3D(a.stack,c,this.options);d.material.wireframe=this.options.wireframe;d.material.side=this.bothSides?h.DoubleSide:h.FrontSide;b=-.9<c.matrixWorld.determinant()?new h.Mesh(b.geom,d.material):
e.GEO.createFlippedMesh(c,b,d.material);c.add(b);b.stack=a.stack;b.renderOrder=this._clones.maxdepth-a.stack.length;b.$jsroot_order=c.$jsroot_depth;if(this.options._debug||this.options._full)a=new h.WireframeGeometry(b.geometry),d=new h.LineBasicMaterial({color:d.fillcolor,linewidth:d.linewidth||1}),d=new h.LineSegments(a,d),c.add(d);if(this.options._bound||this.options._full)d=new h.BoxHelper(b),c.add(d);return!0};f.prototype.appendMoreNodes=function(a,b){if(this.drawing_stage&&!b)this._provided_more_nodes=
a;else{if(this._more_nodes)for(var c=0;c<this._more_nodes.length;++c){var d=this._more_nodes[c],k=this._clones.CreateObject3D(d.stack,this._toplevel,"delete_mesh");e.Painter.DisposeThreejsObject(k);e.GEO.cleanupShape(d.server_shape);delete d.server_shape}delete this._more_nodes;if(a){c=[];for(k=0;k<a.length;++k){d=a[k];var g=d.server_shape;g&&g.ready&&(d.done=!0,g.used=!0,this.createEntryMesh(d,g,this._toplevel)&&c.push(d))}c&&(this._more_nodes=c);b||this.Render3D()}}};f.prototype.getProjectionSource=
function(){return this._clones_owner?this._full_geom:this._main_painter?this._main_painter._drawing_ready?this._main_painter._toplevel:(console.warn("MAIN PAINTER NOT READY WHEN DO PROJECTION"),null):(console.warn("MAIN PAINTER DISAPPER"),null)};f.prototype.getGeomBoundingBox=function(a,b){var c=new h.Box3,d=!this._clones;if(!a)return c.min.x=c.min.y=c.min.z=-1,c.max.x=c.max.y=c.max.z=1,c;c.makeEmpty();a.traverse(function(a){(d||a instanceof h.Mesh&&a.stack)&&e.GEO.getBoundingBox(a,c)});void 0!==
b&&c.expandByVector(c.getSize(new h.Vector3).multiplyScalar(b));return c};f.prototype.doProjection=function(){var a=this.getProjectionSource(),b=this;if(!a)return!1;e.Painter.DisposeThreejsObject(this._toplevel,!0);if(void 0===this.options.projectPos){var c=this.getGeomBoundingBox(a),d=c.min[this.options.project];c=c.max[this.options.project];var k=(d+c)/2;0>d&&0<c&&Math.abs(k)<.2*Math.max(-d,c)&&(k=0);this.options.projectPos=k}a.traverse(function(a){if(a instanceof h.Mesh&&a.stack){var c=e.GEO.projectGeometry(a.geometry,
a.parent.matrixWorld,b.options.project,b.options.projectPos,a._flippedMesh);c&&(c=new h.Mesh(c,a.material.clone()),b._toplevel.add(c),c.stack=a.stack)}});return!0};f.prototype.SameMaterial=function(a,b){if(null===a||null===b)return a===b;if(0<=a.fVolume.fLineColor)return a.fVolume.fLineColor===b.fVolume.fLineColor;a=null!==a.fVolume.fMedium?a.fVolume.fMedium.fMaterial:null;b=null!==b.fVolume.fMedium?b.fVolume.fMedium.fMaterial:null;return a===b?!0:null===a||null===b?!1:a.fFillStyle===b.fFillStyle&&
a.fFillColor===b.fFillColor};f.prototype.createScene=function(a,b){this._scene=new h.Scene;this._scene.fog=new h.Fog(16777215,1,1E4);this._scene.overrideMaterial=new h.MeshLambertMaterial({color:7340287,transparent:!0,opacity:.2,depthTest:!1});this._scene_width=a;this._scene_height=b;this.options.ortho_camera?this._camera=new h.OrthographicCamera(-600,600,-600,600,1,1E4):(this._camera=new h.PerspectiveCamera(25,a/b,1,1E4),this._camera.up=this.options._yup?new h.Vector3(0,1,0):new h.Vector3(0,0,1));
this._scene.add(this._camera);this._selected_mesh=null;this._overall_size=10;this._toplevel=new h.Object3D;this._scene.add(this._toplevel);var c=e.Painter.Create3DRenderer(a,b,this._usesvg,this._usesvgimg,this._webgl,{antialias:!0,logarithmicDepthBuffer:!1,preserveDrawingBuffer:!0});this._webgl=c.usewebgl;this._renderer=c.renderer;this._renderer.setPixelRatio&&!e.nodejs&&this._renderer.setPixelRatio(window.devicePixelRatio);this._renderer.setSize(a,b,!this._fit_main_area);this._renderer.localClippingEnabled=
!0;this._renderer.setClearColor(this.options.background,1);this._fit_main_area&&!this._usesvg&&(this._renderer.domElement.style.width="100%",this._renderer.domElement.style.height="100%",a=this.select_main(),"static"==a.style("position")&&a.style("position","relative"));this._animating=!1;this._clipIntersection=!0;this.enableX=this.enableY=this.enableZ=this.bothSides=!1;this.clipX=this.clipY=this.clipZ=0;this._clipPlanes=[new h.Plane(new h.Vector3(1,0,0),this.clipX),new h.Plane(new h.Vector3(0,this.options._yup?
-1:1,0),this.clipY),new h.Plane(new h.Vector3(0,0,this.options._yup?1:-1),this.clipZ)];this._pointLight=new h.PointLight(15724527,1);this._camera.add(this._pointLight);this._pointLight.position.set(10,10,10);this._depthTest=!0;this._enableSSAO=this.options.ssao;this._enableClipping=!this._enableSSAO;this._enableSSAO&&this.createSSAO();return this._fit_main_area&&(this._usesvg||this._usesvgimg)?(a=z.createElementNS("http://www.w3.org/2000/svg","svg"),a.appendChild(c.dom),a):c.dom};f.prototype.startDrawGeometry=
function(a){a||0===this.drawing_stage?(this._last_render_tm=this._startm=(new Date).getTime(),this._last_render_meshes=0,this.drawing_stage=1,this._drawing_ready=!1,this.drawing_log="collect visible",this._num_faces=this._num_meshes=0,this._selected_mesh=null,this.options.project&&(this._clones_owner?this._full_geom?(this.drawing_stage=10,this.drawing_log="build projection"):this._full_geom=new h.Object3D:(this.drawing_stage=9,this.drawing_log="wait for main painter")),delete this._last_manifest,
delete this._last_hidden,delete this._draw_nodes_again,this.continueDraw()):this._draw_nodes_again=!0};f.prototype.resetAdvanced=function(){this._ssaoPass&&(this._ssaoPass.kernelRadius=16,this._ssaoPass.output=h.SSAOPass.OUTPUT.Default);this._clipIntersection=this._depthTest=!0;this.options.depthMethod="ray";var a=this;this._toplevel.traverse(function(b){b instanceof h.Mesh&&(b.material.depthTest=a._depthTest)});this.Render3D(0)};f.prototype.updateClipping=function(a){if(this._webgl){this._clipPlanes[0].constant=
this.clipX;this._clipPlanes[1].constant=-this.clipY;this._clipPlanes[2].constant=this.options._yup?-this.clipZ:this.clipZ;var b=[];this._enableClipping&&(this.enableX&&b.push(this._clipPlanes[0]),this.enableY&&b.push(this._clipPlanes[1]),this.enableZ&&b.push(this._clipPlanes[2]));0==b.length&&(b=null);var c=!!b,d=this._clipIntersection,e=c?h.DoubleSide:h.FrontSide;this._scene.traverse(function(a){a.hasOwnProperty("material")&&a.material&&void 0!==a.material.clippingPlanes&&(a.material.clippingPlanes!==
b&&(a.material.clipIntersection=d,a.material.clippingPlanes=b,a.material.needsUpdate=!0),void 0!==a.material.emissive&&a.material.side!=e&&(a.material.side=e,a.material.needsUpdate=!0))});this.bothSides=c;a||this.Render3D(0)}};f.prototype.getGeomBox=function(){var a=this.getExtrasContainer("collect"),b=this.getGeomBoundingBox(this._toplevel);if(a)for(var c=0;c<a.length;++c)this._toplevel.add(a[c]);return b};f.prototype.getOverallSize=function(a){if(!this._overall_size||a){a=this.getGeomBoundingBox(this._toplevel);
if(isNaN(a.min.x))return 1E3;this._overall_size=2*Math.max(a.max.x-a.min.x,a.max.y-a.min.y,a.max.z-a.min.z)}return this._overall_size};f.prototype.adjustCameraPosition=function(a){if(this._toplevel){var b=this.getGeomBoundingBox(this._toplevel);if(!isNaN(b.min.x)){var c=b.max.x-b.min.x,d=b.max.y-b.min.y,e=b.max.z-b.min.z,g=(b.max.x+b.min.x)/2,l=(b.max.y+b.min.y)/2,m=(b.max.z+b.min.z)/2;this._overall_size=2*Math.max(c,d,e);this._scene.fog.near=2*this._overall_size;this._camera.near=this._overall_size/
350;this._scene.fog.far=12*this._overall_size;this._camera.far=12*this._overall_size;a&&(this.clipX=g,this.clipY=l,this.clipZ=m);this.options.ortho_camera&&(this._camera.left=b.min.x,this._camera.right=b.max.x,this._camera.top=b.max.y,this._camera.bottom=b.min.y);this._camera.updateProjectionMatrix();a=2*this.options.zoom;if(this.options.ortho_camera)this._camera.position.set(g,l,Math.max(c,d));else if(this.options.project)switch(this.options.project){case "x":this._camera.position.set(1.5*a*Math.max(d,
e),0,0);break;case "y":this._camera.position.set(0,1.5*a*Math.max(c,e),0);break;case "z":this._camera.position.set(0,0,1.5*a*Math.max(c,d))}else this.options._yup?this._camera.position.set(g-a*Math.max(c,e),l+a*d,m-a*Math.max(c,e)):this._camera.position.set(g-a*Math.max(c,d),l-a*Math.max(c,d),m+a*e);this._lookat=new h.Vector3(g,l,m);this._camera.lookAt(this._lookat);this._pointLight.position.set(c/5,d/5,e/5);this._controls&&(this._controls.target.copy(this._lookat),this._controls.update());this.options.select_in_view&&
this.startDrawGeometry()}}};f.prototype.focusOnItem=function(a){a&&this._clones&&(a=this._clones.FindStackByName(a))&&(a=this._clones.ResolveStack(a,!0),this.focusCamera(a,!1))};f.prototype.focusCamera=function(a,b){function c(){if(void 0!==w._animating){w._animating?requestAnimationFrame(c):w._geom_viewer||w.startDrawGeometry();var a=-Math.cos(2*Math.PI*t/p)+1;w._camera.position.add(v.clone().multiplyScalar(a));x.add(u.clone().multiplyScalar(a));w._lookat=x;w._camera.lookAt(w._lookat);w._camera.updateProjectionMatrix();
var b=(new Date).getTime();d?(w.clipX+=y*a,w.clipY+=q*a,w.clipZ+=n*a,w.updateClipping()):w.Render3D(0);a=(new Date).getTime();0==t&&200<a-b&&(p=20);t++;w._animating=t<p}}if(this.options.project)return this.adjustCameraPosition();var d=void 0===b?!1:b;b=new h.Box3;if(void 0===a)b=this.getGeomBoundingBox(this._toplevel);else if(a instanceof h.Mesh)b.setFromObject(a);else{var e=(new h.Vector3).setFromMatrixPosition(a.matrix);a=a.node;a=(new h.Vector3(a.fDX,a.fDY,a.fDZ)).multiplyScalar(.5);b.min=e.clone().sub(a);
b.max=e.clone().add(a)}var g=b.max.x-b.min.x,l=b.max.y-b.min.y,m=b.max.z-b.min.z;e=(b.max.x+b.min.x)/2;a=(b.max.y+b.min.y)/2;var f=(b.max.z+b.min.z)/2;g=this.options._yup?new h.Vector3(e-2*Math.max(g,m),a+2*l,f-2*Math.max(g,m)):new h.Vector3(e-2*Math.max(g,l),a-2*Math.max(g,l),f+2*m);e=new h.Vector3(e,a,f);this._camera.position.distanceTo(e);var x=this._controls.target,p=50,t=0,v=g.sub(this._camera.position).divideScalar(p),u=e.sub(x).divideScalar(p);if(d){e=this.getGeomBoundingBox(this._toplevel);
this.clipX=this.enableX?this.clipX:e.min.x;this.clipY=this.enableY?this.clipY:e.min.y;this.clipZ=this.enableZ?this.clipZ:e.min.z;this.enableX=this.enableY=this.enableZ=!0;var y=((b.max.x+b.min.x)/2-this.clipX)/p,q=((b.max.y+b.min.y)/2-this.clipY)/p,n=((b.max.z+b.min.z)/2-this.clipZ)/p;this.updateClipping()}var w=this;this._animating=!0;c()};f.prototype.autorotate=function(a){function b(){if(d._renderer&&d.options){var a=new Date;d.options.autoRotate&&requestAnimationFrame(b);d._controls&&(d._controls.autoRotate=
d.options.autoRotate,d._controls.autoRotateSpeed=c*(a.getTime()-e.getTime())/16.6666,d._controls.update());e=new Date;d.Render3D(0)}}var c=void 0===a?2:a,d=this,e=new Date;this._webgl&&b()};f.prototype.completeScene=function(){if(this.options._debug||this.options._grid){if(this.options._full){var a=new h.BoxHelper(this._toplevel);this._scene.add(a)}this._scene.add(new h.AxesHelper(2*this._overall_size));this._scene.add(new h.GridHelper(Math.ceil(this._overall_size),Math.ceil(this._overall_size)/50));
this.helpText("<font face='verdana' size='1' color='red'><center>Transform Controls<br>'T' translate | 'R' rotate | 'S' scale<br>'+' increase size | '-' decrease size<br>'W' toggle wireframe/solid display<br>keep 'Ctrl' down to snap to grid</center></font>")}};f.prototype.drawCount=function(a,b){a="Unique nodes: "+this._clones.nodes.length+"<br/>Unique visible: "+a+"<br/>Time to clone: "+b+"ms <br/>";this._clones.ScanVisible();var c=this,d=0,k={cnt:[],func:function(a){void 0===this.cnt[this.last]?
this.cnt[this.last]=1:this.cnt[this.last]++;d+=e.GEO.CountNumShapes(c._clones.GetNodeShape(a.id));return!0}},g=(new Date).getTime(),l=this._clones.ScanVisible(k),f=(new Date).getTime();a=a+("Total visible nodes: "+l+"<br/>")+("Total shapes: "+d+"<br/>");for(b=0;b<k.cnt.length;++b)void 0!==k.cnt[b]&&(a+="  lvl"+b+": "+k.cnt[b]+"<br/>");a=a+("Time to scan: "+(f-g)+"ms <br/>")+"<br/><br/>Check timing for matrix calculations ...<br/>";var h=this.select_main().style("overflow","auto").html(a);setTimeout(function(){k.domatrix=
!0;g=(new Date).getTime();l=c._clones.ScanVisible(k);f=(new Date).getTime();h.append("p").text("Time to scan with matrix: "+(f-g)+"ms");c.DrawingReady()},100);return this};f.prototype.PerformDrop=function(a,b,c,d,k){if(a&&"TTree"===a.$kind){b="extract_geo_tracks";d&&0<d.indexOf("$")&&(b=d.substr(0,d.indexOf("$")),d=d.substr(d.indexOf("$")+1));b=e.findFunction(b);if(!b)return e.CallBack(k);var g=this;return b(a,d,function(a){a&&(g.drawExtras(a,"",!1),this.updateClipping(!0),g.Render3D(100));e.CallBack(k)})}this.drawExtras(a,
b)&&c&&(c._painter=this);e.CallBack(k)};f.prototype.MouseOverHierarchy=function(a,b,c){this.options&&(c=c._obj,this.options._debug&&console.log("Mouse over",a,b,c?c._typename:"---"),!c||"TEveTrack"!==c._typename&&"TEvePointSet"!==c._typename&&"TPolyMarker3D"!==c._typename||this.HighlightMesh(null,65280,a?c:null))};f.prototype.clearExtras=function(){this.getExtrasContainer("delete");delete this._extraObjects;this.Render3D()};f.prototype.addExtra=function(a,b){void 0===this._extraObjects&&(this._extraObjects=
e.Create("TList"));if(0<=this._extraObjects.arr.indexOf(a))return!1;this._extraObjects.Add(a,b);delete a.$hidden_via_menu;return!0};f.prototype.ExtraObjectVisible=function(a,b,c){if(this._extraObjects){a=a.itemFullName(b);var d=this._extraObjects.opt.indexOf(a);0>d&&b._obj&&(d=this._extraObjects.arr.indexOf(b._obj),0<=d&&(this._extraObjects.opt[d]=a));if(!(0>d)){var e=this._extraObjects.arr[d];b=e.$hidden_via_menu?!1:!0;if(c){e.$hidden_via_menu=b;b=!b;var g=null;this._toplevel.traverse(function(a){a.geo_object===
e&&(g=a)});g?g.visible=b:b&&(this.drawExtras(e,"",!1),this.updateClipping(!0));(g||b)&&this.Render3D()}return b}}};f.prototype.drawExtras=function(a,b,c){if(!a||void 0===a._typename||!c&&a.$hidden_via_menu)return!1;var d=!1,e=!1;void 0===c&&(e=c=!0);if("TList"===a._typename||"TObjArray"===a._typename){if(!a.arr)return!1;for(var g=0;g<a.arr.length;++g){var l=a.arr[g],f=a.opt[g];f||(f=(b||"<prnt>")+"/["+g+"]");this.drawExtras(l,f,c)&&(d=!0)}}else if("THREE.Mesh"===a._typename)this.getExtrasContainer().add(a),
d=!0;else if("TGeoTrack"===a._typename){if(c&&!this.addExtra(a,b))return!1;d=this.drawGeoTrack(a,b)}else if("TEveTrack"===a._typename||"ROOT::Experimental::TEveTrack"===a._typename){if(c&&!this.addExtra(a,b))return!1;d=this.drawEveTrack(a,b)}else if("TEvePointSet"===a._typename||"ROOT::Experimental::TEvePointSet"===a._typename||"TPolyMarker3D"===a._typename){if(c&&!this.addExtra(a,b))return!1;d=this.drawHit(a,b)}else if("TEveGeoShapeExtract"===a._typename||"ROOT::Experimental::TEveGeoShapeExtract"===
a._typename){if(c&&!this.addExtra(a,b))return!1;d=this.drawExtraShape(a,b)}d&&e&&(this.updateClipping(!0),this.Render3D(100));return d};f.prototype.getExtrasContainer=function(a,b){if(!this._toplevel)return null;b||(b="tracks");for(var c=null,d=[],k=0;k<this._toplevel.children.length;++k){var g=this._toplevel.children[k];if(g._extras)if("collect"===a)d.push(g);else if(g._extras===b){c=g;break}}if("collect"===a){for(a=0;a<d.length;++a)this._toplevel.remove(d[a]);return d}if("delete"===a)return c&&
this._toplevel.remove(c),e.Painter.DisposeThreejsObject(c),null;"get"===a||c||(c=new h.Object3D,c._extras=b,this._toplevel.add(c));return c};f.prototype.drawGeoTrack=function(a,b){if(!a||!a.fNpoints)return!1;var c=a.fLineWidth||1,d=e.Painter.root_colors[a.fLineColor]||"rgb(255,0,255)";e.browser.isWin&&(c=1);for(var k=Math.round(a.fNpoints/4),g=new Float32Array(6*(k-1)),f=0,m=this.options.projectPos,r="x"===this.options.project,x="y"===this.options.project,p="z"===this.options.project,t=0;t<k-1;++t)g[f]=
r?m:a.fPoints[4*t],g[f+1]=x?m:a.fPoints[4*t+1],g[f+2]=p?m:a.fPoints[4*t+2],g[f+3]=r?m:a.fPoints[4*t+4],g[f+4]=x?m:a.fPoints[4*t+5],g[f+5]=p?m:a.fPoints[4*t+6],f+=6;c=new h.LineBasicMaterial({color:d,linewidth:c});g=e.Painter.createLineSegments(g,c);g.geo_name=b;g.geo_object=a;g.hightlightWidthScale=2;this.getExtrasContainer().add(g);return!0};f.prototype.drawEveTrack=function(a,b){if(!a||0>=a.fN)return!1;var c=a.fLineWidth||1,d=e.Painter.root_colors[a.fLineColor]||"rgb(255,0,255)";e.browser.isWin&&
(c=1);for(var k=new Float32Array(6*(a.fN-1)),g=0,f=this.options.projectPos,m="x"===this.options.project,r="y"===this.options.project,x="z"===this.options.project,p=0;p<a.fN-1;++p)k[g]=m?f:a.fP[3*p],k[g+1]=r?f:a.fP[3*p+1],k[g+2]=x?f:a.fP[3*p+2],k[g+3]=m?f:a.fP[3*p+3],k[g+4]=r?f:a.fP[3*p+4],k[g+5]=x?f:a.fP[3*p+5],g+=6;c=new h.LineBasicMaterial({color:d,linewidth:c});k=e.Painter.createLineSegments(k,c);k.geo_name=b;k.geo_object=a;k.hightlightWidthScale=2;this.getExtrasContainer().add(k);return!0};f.prototype.drawHit=
function(a,b){if(!a||!a.fN||0>a.fN)return!1;var c=a.fMarkerSize*this.getOverallSize()*.005;0>=c&&(c=1);var d=a.fN,f=this.options.projectPos,g="x"===this.options.project,h="y"===this.options.project,m="z"===this.options.project;c=new e.Painter.PointsCreator(d,this._webgl,c);for(var r=0;r<d;r++)c.AddPoint(g?f:a.fP[3*r],h?f:a.fP[3*r+1],m?f:a.fP[3*r+2]);d=c.CreatePoints(e.Painter.root_colors[a.fMarkerColor]||"rgb(0,0,255)");d.highlightScale=2;d.geo_name=b;d.geo_object=a;this.getExtrasContainer().add(d);
return!0};f.prototype.drawExtraShape=function(a,b){var c=e.GEO.build(a);if(!c)return!1;c.geo_name=b;c.geo_object=a;this.getExtrasContainer().add(c);return!0};f.prototype.FindNodeWithVolume=function(a,b,c,d,f){var g=!1,k=null;if(c)0<d.length&&(d+="/"),d+=c.fName;else{c=this.GetGeometry();if(!c&&0!==e.GEO.NodeKind(c))return null;d=this.geo_manager?c.fName:"";g=!0;f=[]}if(!c.fVolume||c.fVolume._searched)return null;if(a.test(c.fVolume.fName)&&(k=b({node:c,item:d})))return k;c.fVolume._searched=!0;f.push(c.fVolume);
if(c.fVolume.fNodes)for(var h=0;h<c.fVolume.fNodes.arr.length&&!(k=this.FindNodeWithVolume(a,b,c.fVolume.fNodes.arr[h],d,f));++h);if(g)for(h=0,a=f.length;h<a;++h)delete f[h]._searched;return k};f.prototype.SetRootDefaultColors=function(){for(var a=[],b=0;110>b;b++)a.push(920);a[3]=390;a[4]=a[5]=406;a[6]=a[7]=593;a[8]=a[9]=613;a[10]=a[11]=622;a[12]=921;a[13]=590;a[14]=807;a[16]=401;a[20]=390;a[24]=a[25]=a[26]=592;a[29]=809;a[79]=798;this.FindNodeWithVolume({test:function(){return!0}},function(b){b=
b.node.fVolume;var c=b.fMedium;if(!c)return null;c=c.fMaterial;b.fLineColor=a[Math.round(c.fZ)];.1>c.fDensity&&(c.fFillStyle=3060)})};f.prototype.checkScript=function(a,b){var c=this,d=this.GetGeometry(),f="";this.geo_manager&&(f=d.fName);if(!a||3>a.length||0!==e.GEO.NodeKind(d))return e.CallBack(b,d,f);var g={GetVolume:function(a){var b=c.FindNodeWithVolume(new RegExp("^"+a+"$"),function(a){return a});b||console.log("Did not found "+a+" volume");return{found:b,fVolume:b?b.node.fVolume:null,InvisibleAll:function(a){e.GEO.InvisibleAll.call(this.fVolume,
a)},Draw:function(){this.found&&this.fVolume&&(d=this.found.node,f=this.found.item,console.log("Select volume for drawing",this.fVolume.fName,f))},SetTransparency:function(a){this.fVolume&&this.fVolume.fMedium&&this.fVolume.fMedium.fMaterial&&(this.fVolume.fMedium.fMaterial.fFillStyle=3E3+a)},SetLineColor:function(a){this.fVolume&&(this.fVolume.fLineColor=a)}}},DefaultColors:function(){c.SetRootDefaultColors()},SetMaxVisNodes:function(a){console.log("Automatic visible depth for "+a+" nodes");0<a&&
(c.options.maxnodeslimit=a)}};e.progress("Loading macro "+a);e.NewHttpRequest(a,"text",function(a){function c(a){for(var k=(new Date).getTime();a<h.length;){var l=h[a++].trim();if(!(0==l.indexOf("//")||0>l.indexOf("gGeoManager")||(l=l.replace("->GetVolume",".GetVolume"),l=l.replace("->InvisibleAll",".InvisibleAll"),l=l.replace("->SetMaxVisNodes",".SetMaxVisNodes"),l=l.replace("->DefaultColors",".DefaultColors"),l=l.replace("->Draw",".Draw"),l=l.replace("->SetTransparency",".SetTransparency"),l=l.replace("->SetLineColor",
".SetLineColor"),0<=l.indexOf("->")))){try{(new Function("gGeoManager",l))(g)}catch(E){console.error("Problem by processing "+l)}if(300<(new Date).getTime()-k)return e.progress("exec "+l),setTimeout(c.bind(this,a),1)}}e.CallBack(b,d,f)}if(!a||0==a.length)return e.CallBack(b,d,f);var h=a.split("\n");c(0)}).send()};f.prototype.assignClones=function(a){this._clones_owner=!0;this._clones=a};f.prototype.prepareObjectDraw=function(a,b){if("__geom_viewer_append__"==b)this._new_append_nodes=a,this.options.use_worker=
0,this._geom_viewer=!0;else if("__geom_viewer_selection__"==b&&this._clones)this._new_draw_nodes=a,this.options.use_worker=0,this._geom_viewer=!0;else if(this._main_painter)this._clones_owner=!1,this._clones=this._main_painter._clones,console.log("Reuse clones",this._clones.nodes.length,"from main painter");else if(a){if(this._start_drawing_time=(new Date).getTime(),this._clones_owner=!0,this._clones=new e.GEO.ClonedNodes(a),this._clones.name_prefix=b,a=this._clones.MarkVisisble(!0),a=0>=a?this._clones.MarkVisisble(!1):
this._clones.MarkVisisble(!0,!0),b=(new Date).getTime()-this._start_drawing_time,console.log("Creating clones",this._clones.nodes.length,"takes",b,"uniquevis",a),this.options._count)return this.drawCount(a,b)}else this._clones_owner=!1,this._clones=null;this._scene||(this.options.maxlimit=(this._webgl?2E5:1E5)*this.options.more,this._first_drawing=!0,0<this.options.use_worker&&this.startWorker(),a=this.size_for_3d(this._usesvg?3:void 0),this._fit_main_area=-1===a.can3d,b=this.createScene(a.width,
a.height),this.add_3d_canvas(a,b),this.AccessTopPainter(!0));this.CreateToolbar();this._clones?(this.showDrawInfo("Drawing geometry"),this.startDrawGeometry(!0)):this.completeDraw()};f.prototype.showDrawInfo=function(a){if(this._first_drawing&&this._start_drawing_time){var b=this._renderer.domElement.parentNode,c=v.select(b).select(".geo_info");if(a){var d=.001*((new Date).getTime()-this._start_drawing_time);c.empty()&&(c=v.select(b).append("p").attr("class","geo_info"));c.html(a+", "+d.toFixed(1)+
"s")}else c.remove()}};f.prototype.continueDraw=function(){if(0!==this.drawing_stage){for(var a=(new Date).getTime(),b=this._first_drawing?1E3:200,c=a;;){var d=this.nextDrawAction();if(!d)break;c=(new Date).getTime();if(1E5<c-this._startm){this.drawing_stage=0;break}if(!(!0===d&&c-a<b)&&(c-a>b||1===d||2===d)){e.progress(this.drawing_log);this.showDrawInfo(this.drawing_log);this._first_drawing&&this._webgl&&100<this._num_meshes-this._last_render_meshes&&c-this._last_render_tm>2.5*b&&(this.adjustCameraPosition(),
this.Render3D(-1),this._last_render_meshes=this._num_meshes);2!==d&&setTimeout(this.continueDraw.bind(this),1===d?100:1);return}}a=c-this._startm;this._first_drawing&&e.console("Create tm = "+a+" meshes "+this._num_meshes+" faces "+this._num_faces);if(300<a)return e.progress("Rendering geometry"),this.showDrawInfo("Rendering"),setTimeout(this.completeDraw.bind(this,!0),10);this.completeDraw(!0)}};f.prototype.TestCameraPosition=function(a){this._camera.updateMatrixWorld();var b=this._camera.position.clone();
!a&&this._last_camera_position&&this._last_camera_position.distanceTo(b)<(this._overall_size||1E3)/1E4||(this._last_camera_position=b,!this.options.project&&this._webgl&&e.GEO.produceRenderOrder(this._toplevel,b,this.options.depthMethod,this._clones))};f.prototype.Render3D=function(a,b){if(this._renderer){void 0===a&&(a=5);if(0>=a||this._usesvg){if("render_tmout"in this)clearTimeout(this.render_tmout);else if(-2222===a)return;var c=new Date;"function"===typeof this.TestAxisVisibility&&this.TestAxisVisibility(this._camera,
this._toplevel);this.TestCameraPosition(-1===a);this._webgl&&this._enableSSAO&&this._ssaoPass?this._effectComposer.render():this._renderer.render(this._scene,this._camera);a=new Date;this.last_render_tm=a.getTime();delete this.render_tmout;0===this.first_render_tm&&b&&(this.first_render_tm=a.getTime()-c.getTime(),e.console("First render tm = "+this.first_render_tm));return e.Painter.AfterRender3D(this._renderer)}this.render_tmout||(this.render_tmout=setTimeout(this.Render3D.bind(this,0,b),a))}else console.warn("renderer object not exists - check code")};
f.prototype.startWorker=function(){if(!this._worker){this._worker_ready=!1;this._worker_jobs=0;var a=this;this._worker=new Worker(e.source_dir+"scripts/JSRootGeoWorker.js");this._worker.onmessage=function(b){if("object"===typeof b.data){if("log"in b.data)return e.console("geo: "+b.data.log);if("progress"in b.data)return e.progress(b.data.progress);b.data.tm3=(new Date).getTime();if("init"in b.data)return a._worker_ready=!0,e.console("Worker ready: "+(b.data.tm3-b.data.tm0));a.processWorkerReply(b.data)}};
this._worker.postMessage({init:!0,browser:e.browser,tm0:(new Date).getTime(),clones:this._clones.nodes,sortmap:this._clones.sortmap})}};f.prototype.canSubmitToWorker=function(a){return this._worker?this._worker_ready&&(0==this._worker_jobs||a):!1};f.prototype.submitToWorker=function(a){if(!this._worker)return!1;this._worker_jobs++;a.tm0=(new Date).getTime();this._worker.postMessage(a)};f.prototype.processWorkerReply=function(a){this._worker_jobs--;if("collect"in a)return this._new_draw_nodes=a.new_nodes,
this._draw_all_nodes=a.complete,this.drawing_stage=3,this.continueDraw();if("shapes"in a){for(var b=0;b<a.shapes.length;++b){var c=a.shapes[b],d=this._build_shapes[b];c.buf_pos&&c.buf_norm&&(0===c.buf_pos.length?d.geom=null:c.buf_pos.length!==c.buf_norm.length?(console.error("item.buf_pos",c.buf_pos.length,"item.buf_norm",c.buf_norm.length),d.geom=null):(d.geom=new h.BufferGeometry,d.geom.addAttribute("position",new h.BufferAttribute(c.buf_pos,3)),d.geom.addAttribute("normal",new h.BufferAttribute(c.buf_norm,
3))),d.ready=!0,d.nfaces=c.nfaces)}a.tm4=(new Date).getTime();this.drawing_stage=7;return this.continueDraw()}};f.prototype.testGeomChanges=function(){if(this._main_painter)return console.warn("Get testGeomChanges call for slave painter"),this._main_painter.testGeomChanges();this.startDrawGeometry();for(var a=0;a<this._slave_painters.length;++a)this._slave_painters[a].startDrawGeometry()};f.prototype.drawSimpleAxis=function(){var a=this.getGeomBoundingBox(this._toplevel);this.getExtrasContainer("delete",
"axis");var b=this.getExtrasContainer("create","axis"),c=.02*Math.max(a.max.x-a.min.x,a.max.y-a.min.y,a.max.z-a.min.z),d=[0,0,0],f=["x","y","z"],g=["X","Y","Z"],l=["red","green","blue"],m=this.options.ortho_camera,r=[this.options._yup,this.options._yup,this.options._yup],x=3;if(this.options._axis_center)for(var p=0;3>p;++p){var t=f[p];0>=a.min[t]&&0<=a.max[t]||(d[p]=(a.min[t]+a.max[t])/2)}this.options.ortho_camera&&(x=2,g[0]=g[2],l[0]=l[2],r[0]=r[2],m=!0);for(p=0;p<x;++p){var v=function(b){return 2>
a.max[t]-a.min[t]?b.toFixed(3):1E5<Math.abs(b)?b.toExponential(3):Math.round(b).toString()},u=new Float32Array(6),y=l[p];t=f[p];var q=v(a.max[t]);u[0]=a.min.x;u[1]=a.min.y;u[2]=a.min.z;u[3]=a.min.x;u[4]=a.min.y;u[5]=a.min.z;switch(p){case 0:u[3]=a.max.x;q=r[0]&&!m?g[0]+" "+q:q+(" "+g[0]);break;case 1:u[4]=a.max.y;q=r[1]?q+(" "+g[1]):g[1]+" "+q;break;case 2:u[5]=a.max.z,q+=" "+g[2]}if(this.options._axis_center)for(var n=0;6>n;++n)n%3!==p&&(u[n]=d[n%3]);n=new h.LineBasicMaterial({color:y});n=e.Painter.createLineSegments(u,
n);b.add(n);y=new h.MeshBasicMaterial({color:y});0===d[p]&&d[p]>=a.min[t]&&d[p]<=a.max[t]&&(!this.options._axis_center||0===p)&&(n=m?new h.CircleBufferGeometry(.25*c):new h.SphereBufferGeometry(.25*c),n=new h.Mesh(n,y),n.translateX(0===p?d[0]:u[0]),n.translateY(1===p?d[1]:u[1]),n.translateZ(2===p?d[2]:u[2]),b.add(n));q=new h.TextGeometry(q,{font:e.threejs_font_helvetiker_regular,size:c,height:0,curveSegments:5});n=new h.Mesh(q,y);q=(new h.Box3).setFromObject(n);n.translateX(u[3]);n.translateY(u[4]);
n.translateZ(u[5]);if(r[p])switch(p){case 0:m?n.translateX(.5*c):(n.rotateY(Math.PI),n.translateX(-q.max.x-.5*c));n.translateY(-q.max.y/2);break;case 1:m?n.rotateZ(Math.PI/2):(n.rotateX(-Math.PI/2),n.rotateY(-Math.PI/2));n.translateX(.5*c);n.translateY(-q.max.y/2);break;case 2:n.rotateY(-Math.PI/2),n.translateX(.5*c),n.translateY(-q.max.y/2)}else switch(p){case 0:n.rotateX(Math.PI/2);n.translateY(-q.max.y/2);n.translateX(.5*c);break;case 1:n.rotateX(Math.PI/2);n.rotateY(-Math.PI/2);n.translateX(-q.max.x-
.5*c);n.translateY(-q.max.y/2);break;case 2:n.rotateX(Math.PI/2),n.rotateZ(Math.PI/2),n.translateX(.5*c),n.translateY(-q.max.y/2)}b.add(n);q=new h.TextGeometry(v(a.min[t]),{font:e.threejs_font_helvetiker_regular,size:c,height:0,curveSegments:5});n=new h.Mesh(q,y);q=(new h.Box3).setFromObject(n);n.translateX(u[0]);n.translateY(u[1]);n.translateZ(u[2]);if(r[p])switch(p){case 0:m?n.translateX(-q.max.x-.5*c):(n.rotateY(Math.PI),n.translateX(.5*c));n.translateY(-q.max.y/2);break;case 1:m?n.rotateZ(Math.PI/
2):(n.rotateX(-Math.PI/2),n.rotateY(-Math.PI/2));n.translateY(-q.max.y/2);n.translateX(-q.max.x-.5*c);break;case 2:n.rotateY(-Math.PI/2),n.translateX(-q.max.x-.5*c),n.translateY(-q.max.y/2)}else switch(p){case 0:n.rotateX(Math.PI/2);n.translateX(-q.max.x-.5*c);n.translateY(-q.max.y/2);break;case 1:n.rotateX(Math.PI/2);n.rotateY(-Math.PI/2);n.translateY(-q.max.y/2);n.translateX(.5*c);break;case 2:n.rotateX(Math.PI/2),n.rotateZ(Math.PI/2),n.translateX(-q.max.x-.5*c),n.translateY(-q.max.y/2)}b.add(n)}this.TestAxisVisibility=
function(a,b){a||(this.getExtrasContainer("delete","axis"),delete this.TestAxisVisibility,this.Render3D())}};f.prototype.toggleAxisDraw=function(a){this.TestAxisVisibility?a||this.TestAxisVisibility(null,this._toplevel):this.drawSimpleAxis()};f.prototype.completeDraw=function(a){var b=!1,c=!0;if(this.options){if(!this._clones){c=!1;this.getExtrasContainer("delete");var d=(this._main_painter?this._main_painter._extraObjects:null)||this._extraObjects;this.drawExtras(d,"",!1)}this._first_drawing&&(this.adjustCameraPosition(!0),
this.showDrawInfo(),this._first_drawing=!1,b=!0,this._webgl&&(this.enableX=this.options.clipx,this.enableY=this.options.clipy,this.enableZ=this.options.clipz),this.options.tracks&&this.geo_manager&&this.geo_manager.fTracks&&this.addExtra(this.geo_manager.fTracks,"<prnt>/Tracks"));0!==this.options.transparency&&this.changeGlobalTransparency(this.options.transparency,!0);b&&(this.completeScene(),this.options._axis&&this.toggleAxisDraw(!0));this._scene.overrideMaterial=null;void 0!==this._provided_more_nodes&&
(this.appendMoreNodes(this._provided_more_nodes,!0),delete this._provided_more_nodes);c&&(this.getExtrasContainer("delete"),d=(this._main_painter?this._main_painter._extraObjects:null)||this._extraObjects,this.drawExtras(d,"",!1));this.updateClipping(!0);this.Render3D(0,!0);a&&e.progress();this.addOrbitControls();this.addTransformControl();b&&(!1===this.options.highlight&&(this.options.highlight=1E3>this.first_render_tm),!1===this.options.highlight_scene&&(this.options.highlight_scene=this.options.highlight),
this._webgl&&this.options.autoRotate&&!this.options.project&&this.autorotate(2.5),this._usesvg||!this.options.show_controls||e.BatchMode||this.showControlOptions(!0));this.DrawingReady();if(this._draw_nodes_again)return this.startDrawGeometry();this._drawing_ready=!0}else console.warn("options object does not exist in completeDraw - something went wrong")};f.prototype.RemoveDrawnNode=function(a){if(this._draw_nodes){for(var b=[],c=0;c<this._draw_nodes.length;++c){var d=this._draw_nodes[c];d.nodeid===
a||this._clones.IsNodeInStack(a,d.stack)?this._clones.CreateObject3D(d.stack,this._toplevel,"delete_mesh"):b.push(d)}b.length<this._draw_nodes.length&&(this._draw_nodes=b,this.Render3D())}};f.prototype.Cleanup=function(a){if(!a){this.AccessTopPainter(!1);this.helpText();e.Painter.DisposeThreejsObject(this._scene);e.Painter.DisposeThreejsObject(this._full_geom);this._tcontrols&&this._tcontrols.dispose();this._controls&&this._controls.Cleanup();this._context_menu&&this._renderer.domElement.removeEventListener("contextmenu",
this._context_menu,!1);this._datgui&&this._datgui.destroy();this._worker&&this._worker.terminate();e.TObjectPainter.prototype.Cleanup.call(this);delete this.options;delete this._animating;var b=this.GetGeometry();b&&this.options.is_main&&(b.$geo_painter===this?delete b.$geo_painter:b.fVolume&&b.fVolume.$geo_painter===this&&delete b.fVolume.$geo_painter);this._main_painter&&(b=this._main_painter._slave_painters.indexOf(this),0<=b&&this._main_painter._slave_painters.splice(b,1));for(b=0;b<this._slave_painters.length;++b)(a=
this._slave_painters[b])&&a._main_painter===this&&(a._main_painter=null)}for(b in this._slave_painters)a=this._slave_painters[b],a._main_painter=null,a._clones===this._clones&&(a._clones=null);this._main_painter=null;this._slave_painters=[];this._renderer&&(this._renderer.dispose&&this._renderer.dispose(),this._renderer.context&&delete this._renderer.context);delete this._scene;this._scene_height=this._scene_width=0;this._selected_mesh=this._camera=this._full_geom=this._toplevel=this._renderer=null;
this._clones&&this._clones_owner&&this._clones.Cleanup(this._draw_nodes,this._build_shapes);delete this._clones;delete this._clones_owner;delete this._draw_nodes;delete this._drawing_ready;delete this._build_shapes;delete this._new_draw_nodes;delete this._new_append_nodes;delete this._last_camera_position;this.drawing_stage=this.last_render_tm=this.first_render_tm=0;delete this.drawing_log;delete this._datgui;delete this._controls;delete this._context_menu;delete this._tcontrols;delete this._toolbar;
delete this._worker};f.prototype.helpText=function(a){e.progress(a)};f.prototype.CheckResize=function(a){var b=this.canv_painter();if(b&&!b.CheckCanvasResize(a))return!1;a=this.size_for_3d();if(this._scene_width===a.width&&this._scene_height===a.height||10>a.width||10>a.height)return!1;this._scene_width=a.width;this._scene_height=a.height;this._camera&&this._renderer&&("PerspectiveCamera"==this._camera.type&&(this._camera.aspect=this._scene_width/this._scene_height),this._camera.updateProjectionMatrix(),
this._renderer.setSize(this._scene_width,this._scene_height,!this._fit_main_area),this._ssaoPass&&this._ssaoPass.setSize(this._scene_width,this._scene_height),this.drawing_stage||this.Render3D());return!0};f.prototype.ToggleEnlarge=function(){v.event&&(v.event.preventDefault(),v.event.stopPropagation());this.enlarge_main("toggle")&&this.CheckResize()};f.prototype.ownedByTransformControls=function(a){for(a=a.parent;a&&!(a instanceof h.TransformControls);)a=a.parent;return a&&a instanceof h.TransformControls};
f.prototype.accessObjectWireFrame=function(a,b){if(a.hasOwnProperty("material")&&!(a instanceof h.GridHelper)&&!this.ownedByTransformControls(a))return void 0!==b&&a.stack&&(a.material.wireframe=b),a.material.wireframe};f.prototype.changeWireFrame=function(a,b){var c=this;a.traverse(function(a){c.accessObjectWireFrame(a,b)});this.Render3D()};e.Painter.CreateGeoPainter=function(a,b,c){e.GEO.GradPerSegm=e.gStyle.GeoGradPerSegm;e.GEO.CompressComp=e.gStyle.GeoCompressComp;b=new f(b);b.SetDivId(a,5);b._usesvg=
e.Painter.UseSVGFor3D();b._usesvgimg=!b._usesvg&&e.BatchMode;b._webgl=!b._usesvg&&e.Painter.TestWebGL();b.options=b.decodeOptions(c);return b};e.Painter.drawGeoObject=function(a,b,c){if(!b)return null;var d=null,f=null,g="";"fShapeBits"in b&&"fShapeId"in b?(d=b,b=null):"TGeoVolumeAssembly"===b._typename||"TGeoVolume"===b._typename?d=b.fShape:"TEveGeoShapeExtract"===b._typename||"ROOT::Experimental::TEveGeoShapeExtract"===b._typename?d=b.fShape:"TGeoManager"===b._typename?(e.GEO.SetBit(b.fMasterVolume,
e.GEO.BITS.kVisThis,!1),d=b.fMasterVolume.fShape):"TGeoOverlap"===b._typename?(f=b.fMarker,g="<prnt>/Marker",b=e.GEO.buildOverlapVolume(b),c||(c="wire")):"fVolume"in b?b.fVolume&&(d=b.fVolume.fShape):b=null;c&&0==c.indexOf("comp")&&d&&"TGeoCompositeShape"==d._typename&&d.fNode&&(c=c.substr(4),b=e.GEO.buildCompositeVolume(d));!b&&d&&(b=e.extend(e.Create("TEveGeoShapeExtract"),{fTrans:null,fShape:d,fRGBA:[0,1,0,1],fElements:null,fRnrSelf:!0}));if(!b)return null;a=e.Painter.CreateGeoPainter(a,b,c);a.options.is_main&&
!b.$geo_painter&&(b.$geo_painter=a);!a.options.is_main&&a.options.project&&b.$geo_painter&&(a._main_painter=b.$geo_painter,a._main_painter._slave_painters.push(a));f&&(a._splitColors=!0,a.addExtra(f,g));a.checkScript(a.options.script_name,a.prepareObjectDraw.bind(a));return a};e.Painter.drawGeometry=e.Painter.drawGeoObject;e.GEO.buildCompositeVolume=function(a,b){var c=e.Create("TGeoVolume");if(b&&"TGeoCompositeShape"!==a._typename)return c.fName=b,e.GEO.SetBit(c,e.GEO.BITS.kVisThis,!0),c.fLineColor=
"Left"==b?2:3,c.fShape=a,c;e.GEO.SetBit(c,e.GEO.BITS.kVisDaughters,!0);c.$geoh=!0;c.fName="";b=e.Create("TGeoNodeMatrix");b.fName="Left";b.fMatrix=a.fNode.fLeftMat;b.fVolume=e.GEO.buildCompositeVolume(a.fNode.fLeft,"Left");var d=e.Create("TGeoNodeMatrix");d.fName="Right";d.fMatrix=a.fNode.fRightMat;d.fVolume=e.GEO.buildCompositeVolume(a.fNode.fRight,"Right");c.fNodes=e.Create("TList");c.fNodes.Add(b);c.fNodes.Add(d);return c};e.GEO.buildOverlapVolume=function(a){var b=e.Create("TGeoVolume");e.GEO.SetBit(b,
e.GEO.BITS.kVisDaughters,!0);b.$geoh=!0;b.fName="";var c=e.Create("TGeoNodeMatrix");c.fName=a.fVolume1.fName||"Overlap1";c.fMatrix=a.fMatrix1;c.fVolume=a.fVolume1;var d=e.Create("TGeoNodeMatrix");d.fName=a.fVolume2.fName||"Overlap2";d.fMatrix=a.fMatrix2;d.fVolume=a.fVolume2;b.fNodes=e.Create("TList");b.fNodes.Add(c);b.fNodes.Add(d);return b};e.GEO.provideVisStyle=function(a){if("TEveGeoShapeExtract"===a._typename||"ROOT::Experimental::TEveGeoShapeExtract"===a._typename)return a.fRnrSelf?" geovis_this":
"";var b=!e.GEO.TestBit(a,e.GEO.BITS.kVisNone)&&e.GEO.TestBit(a,e.GEO.BITS.kVisThis),c=e.GEO.TestBit(a,e.GEO.BITS.kVisDaughters)||e.GEO.TestBit(a,e.GEO.BITS.kVisOneLevel);!c||a.fNodes&&0!==a.fNodes.arr.length||(c=!1);return b&&c?" geovis_all":b?" geovis_this":c?" geovis_daughters":""};e.GEO.getBrowserItem=function(a,b,c){a._geoobj&&(a._geoobj.$geoh=!0);e.CallBack(c,a,a._geoobj)};e.GEO.createItem=function(a,b,c){c={_kind:"ROOT."+b._typename,_name:c?c:e.GEO.ObjectName(b),_title:b.fTitle,_parent:a,_geoobj:b,
_get:e.GEO.getBrowserItem};var d=!1;if("TGeoMaterial"==b._typename)c._icon="img_geomaterial";else if("TGeoMedium"==b._typename)c._icon="img_geomedium";else if("TGeoMixture"==b._typename)c._icon="img_geomixture";else if(0===b._typename.indexOf("TGeoNode")&&b.fVolume){c._title="node:"+b._typename;0<b.fTitle.length&&(c._title+=" "+b.fTitle);var f=b.fVolume}else if(0===b._typename.indexOf("TGeoVolume"))f=b;else if("TEveGeoShapeExtract"==b._typename||"ROOT::Experimental::TEveGeoShapeExtract"==b._typename){d=
!0;var g=b.fShape;var h=b.fElements?b.fElements.arr:null}else void 0!==b.fShapeBits&&void 0!==b.fShapeId&&(g=b);f&&(g=f.fShape,h=f.fNodes?f.fNodes.arr:null);if(f||g||h)f&&(c._volume=f),h?(c._more=!0,c._expand=e.GEO.expandObject):g&&"TGeoCompositeShape"===g._typename&&g.fNode&&(c._more=!0,c._shape=g,c._expand=function(a,b){e.GEO.createItem(a,a._shape.fNode.fLeft,"Left");e.GEO.createItem(a,a._shape.fNode.fRight,"Right");return!0}),c._title||"TGeoVolume"==b._typename||(c._title=b._typename),g?(""==c._title&&
(c._title=g._typename),c._icon=e.GEO.getShapeIcon(g)):c._icon=c._more?"img_geocombi":"img_geobbox",f?c._icon+=e.GEO.provideVisStyle(f):d&&(c._icon+=e.GEO.provideVisStyle(b)),c._menu=e.GEO.provideMenu,c._icon_click=e.GEO.browserIconClick;a._childs||(a._childs=[]);c._name||("string"===typeof a._name?(c._name=a._name,c._name.lastIndexOf("s")===c._name.length-1&&(c._name=c._name.substr(0,c._name.length-1)),c._name+="_"+a._childs.length):c._name="item_"+a._childs.length);a._childs.push(c);return c};e.GEO.createList=
function(a,b,c,d){b&&"arr"in b&&0!=b.arr.length&&(b={_name:c,_kind:"ROOT.TList",_title:d,_more:!0,_geoobj:b,_parent:a,_get:function(a,b,c){if("_geoobj"in a)return e.CallBack(c,a,a._geoobj);e.CallBack(c,a,null)},_expand:function(a,b){"fVolume"in b&&(b=b.fVolume.fNodes);if(!("arr"in b))return!1;a._childs=[];e.GEO.CheckDuplicates(null,b.arr);for(var c in b.arr)e.GEO.createItem(a,b.arr[c]);return!0}},a._childs||(a._childs=[]),a._childs.push(b))};e.GEO.provideMenu=function(a,b,c){function d(a,b,c){b||
(b={visible:0,hidden:0});c||(void 0!==b.assign?a.fRnrSelf=b.assign:a.fRnrSelf?b.vis++:b.hidden++);if(a.fElements)for(c=0;c<a.fElements.arr.length;++c)d(a.fElements.arr[c],b,!1);return b}function f(a){"self"===a?(h.fRnrSelf=!h.fRnrSelf,b._icon=b._icon.split(" ")[0]+e.GEO.provideVisStyle(h),c.UpdateTreeNode(b)):(d(h,{assign:"true"===a},!0),c.ForEach(function(a){a._geoobj&&a._icon&&(a._icon=b._icon.split(" ")[0]+e.GEO.provideVisStyle(a._geoobj),c.UpdateTreeNode(a))},b));e.GEO.findItemWithPainter(b,"testGeomChanges")}
function g(a){e.GEO.ToggleBit(m,a);var d=b._icon.split(" ")[0]+e.GEO.provideVisStyle(m);c.ForEach(function(a){b._volume===a._volume&&(a._icon=d,c.UpdateTreeNode(a))});c.UpdateTreeNode(b);e.GEO.findItemWithPainter(b,"testGeomChanges")}if(!b._geoobj)return!1;var h=b._geoobj,m=b._volume,r="TEveGeoShapeExtract"===h._typename||"ROOT::Experimental::TEveGeoShapeExtract"===h._typename;if(!m&&!r)return!1;a.add("separator");0===b._geoobj._typename.indexOf("TGeoNode")&&e.GEO.findItemWithPainter(b)&&a.add("Focus",
function(){var a=e.GEO.findItemWithPainter(b);if(a){var d=c.itemFullName(b,a);a._painter&&"function"==typeof a._painter.focusOnItem&&a._painter.focusOnItem(d)}});r?(a.addchk(h.fRnrSelf,"Visible","self",f),r=d(h,void 0,!0),0<r.hidden+r.visible&&a.addchk(0==r.hidden,"Daughters",0!=r.hidden?"true":"false",f)):(a.addchk(e.GEO.TestBit(m,e.GEO.BITS.kVisNone),"Invisible",e.GEO.BITS.kVisNone,g),a.addchk(e.GEO.TestBit(m,e.GEO.BITS.kVisThis),"Visible",e.GEO.BITS.kVisThis,g),a.addchk(e.GEO.TestBit(m,e.GEO.BITS.kVisDaughters),
"Daughters",e.GEO.BITS.kVisDaughters,g),a.addchk(e.GEO.TestBit(m,e.GEO.BITS.kVisOneLevel),"1lvl daughters",e.GEO.BITS.kVisOneLevel,g));return!0};e.GEO.findItemWithPainter=function(a,b){for(;a;){if(a._painter&&a._painter._camera){if(b&&"function"==typeof a._painter[b])a._painter[b]();return a}a=a._parent}return null};e.GEO.updateBrowserIcons=function(a,b){a&&b&&b.ForEach(function(c){if(a===c._volume||a===c._geoobj)c._icon=c._icon.split(" ")[0]+e.GEO.provideVisStyle(a),b.UpdateTreeNode(c)})};e.GEO.browserIconClick=
function(a,b){if(a._volume)return a._more&&a._volume.fNodes&&0<a._volume.fNodes.arr.length?e.GEO.ToggleBit(a._volume,e.GEO.BITS.kVisDaughters):e.GEO.ToggleBit(a._volume,e.GEO.BITS.kVisThis),e.GEO.updateBrowserIcons(a._volume,b),e.GEO.findItemWithPainter(a,"testGeomChanges"),!1;if(a._geoobj&&("TEveGeoShapeExtract"==a._geoobj._typename||"ROOT::Experimental::TEveGeoShapeExtract"==a._geoobj._typename))return a._geoobj.fRnrSelf=!a._geoobj.fRnrSelf,e.GEO.updateBrowserIcons(a._geoobj,b),e.GEO.findItemWithPainter(a,
"testGeomChanges"),!1;var c=e.GEO.findItemWithPainter(a);return c?void 0!==c._painter.ExtraObjectVisible(b,a,!0)?!0:!1:!1};e.GEO.getShapeIcon=function(a){switch(a._typename){case "TGeoArb8":return"img_geoarb8";case "TGeoCone":return"img_geocone";case "TGeoConeSeg":return"img_geoconeseg";case "TGeoCompositeShape":return"img_geocomposite";case "TGeoTubeSeg":return"img_geotubeseg";case "TGeoPara":return"img_geopara";case "TGeoParaboloid":return"img_geoparab";case "TGeoPcon":return"img_geopcon";case "TGeoPgon":return"img_geopgon";
case "TGeoShapeAssembly":return"img_geoassembly";case "TGeoSphere":return"img_geosphere";case "TGeoTorus":return"img_geotorus";case "TGeoTrd1":return"img_geotrd1";case "TGeoTrd2":return"img_geotrd2";case "TGeoXtru":return"img_geoxtru";case "TGeoTrap":return"img_geotrap";case "TGeoGtra":return"img_geogtra";case "TGeoEltu":return"img_geoeltu";case "TGeoHype":return"img_geohype";case "TGeoCtub":return"img_geoctub"}return"img_geotube"};e.GEO.getBrowserIcon=function(a,b){var c="";"ROOT.TEveTrack"==a._kind?
c="img_evetrack":"ROOT.TEvePointSet"==a._kind?c="img_evepoints":"ROOT.TPolyMarker3D"==a._kind&&(c="img_evepoints");if(0<c.length){var d=e.GEO.findItemWithPainter(a);d&&d._painter.ExtraObjectVisible(b,a)&&(c+=" geovis_this")}return c};e.GEO.expandObject=function(a,b){if(!a||!b)return!1;var c=0===b._typename.indexOf("TGeoNode"),d=0===b._typename.indexOf("TGeoVolume"),f="TGeoManager"===b._typename,g="TEveGeoShapeExtract"===b._typename||"ROOT::Experimental::TEveGeoShapeExtract"===b._typename,h="TGeoOverlap"===
b._typename;if(!(c||d||f||g||h))return!1;if(a._childs)return!0;if(f)return e.GEO.createList(a,b.fMaterials,"Materials","list of materials"),e.GEO.createList(a,b.fMedia,"Media","list of media"),e.GEO.createList(a,b.fTracks,"Tracks","list of tracks"),e.GEO.createList(a,b.fOverlaps,"Overlaps","list of detected overlaps"),e.GEO.SetBit(b.fMasterVolume,e.GEO.BITS.kVisThis,!1),e.GEO.createItem(a,b.fMasterVolume),!0;if(h)return e.GEO.createItem(a,b.fVolume1),e.GEO.createItem(a,b.fVolume2),e.GEO.createItem(a,
b.fMarker,"Marker"),!0;g?(c=b.fElements?b.fElements.arr:null,d=b.fShape):(c=(d=c?b.fVolume:b)&&d.fNodes?d.fNodes.arr:null,d=d?d.fShape:null);if(!c&&d&&"TGeoCompositeShape"===d._typename&&d.fNode)return a._childs||(e.GEO.createItem(a,d.fNode.fLeft,"Left"),e.GEO.createItem(a,d.fNode.fRight,"Right")),!0;if(!c)return!1;e.GEO.CheckDuplicates(b,c);for(b=0;b<c.length;++b)e.GEO.createItem(a,c[b]);return!0};e.addDrawFunc({name:"TGeoVolumeAssembly",icon:"img_geoassembly",func:e.Painter.drawGeoObject,expand:e.GEO.expandObject,
opt:";more;all;count"});e.addDrawFunc({name:"TEvePointSet",icon_get:e.GEO.getBrowserIcon,icon_click:e.GEO.browserIconClick});e.addDrawFunc({name:"TEveTrack",icon_get:e.GEO.getBrowserIcon,icon_click:e.GEO.browserIconClick});e.TGeoPainter=f;e.Painter.GeoDrawingControl=B;return e.Painter});

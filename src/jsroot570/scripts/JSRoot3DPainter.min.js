(function(e){if("function"===typeof define&&define.amd)define(["JSRootPainter","d3","threejs","threejs_all"],e);else if("object"===typeof exports&&"undefined"!==typeof module){var t=require("./JSRootCore.js");e(t,require("d3"),require("three"),require("./three.extra.min.js"),t.nodejs||"undefined"==typeof document?t.nodejs_document:document)}else{if("undefined"==typeof JSROOT)throw Error("JSROOT is not defined","JSRoot3DPainter.js");if("object"!=typeof d3)throw Error("This extension requires d3.js",
"JSRoot3DPainter.js");if("undefined"==typeof THREE)throw Error("THREE is not defined","JSRoot3DPainter.js");e(JSROOT,d3,THREE)}})(function(e,t,g,y,m){function q(){}function r(a){this.mesh=a}function u(a,c,d){this.webgl=void 0===c?!0:c;this.scale=d||1;this.pos=new Float32Array(3*a);this.geom=new g.BufferGeometry;this.geom.addAttribute("position",new g.BufferAttribute(this.pos,3));this.indx=0}function w(a,c){if(!a||!c)return null;a=a.get_color(c.fLineColor);var d=c.fLineStyle?e.Painter.root_line_styles[c.fLineStyle]:
"";a=(d=d?d.split(","):[])&&2<=d.length?new g.LineDashedMaterial({color:a,dashSize:parseInt(d[0]),gapSize:parseInt(d[1])}):new g.LineBasicMaterial({color:a});c.fLineWidth&&1<c.fLineWidth&&!e.browser.isIE&&(a.linewidth=c.fLineWidth);return a}e.sources.push("3d");"undefined"==typeof m&&"object"==typeof window&&(m=window.document);if("object"!=typeof e.Painter)throw Error("JSROOT.Painter is not defined","JSRoot3DPainter.js");e.Painter.TestWebGL=function(){if(e.gStyle.NoWebGL||e.nodejs)return!1;if("_Detect_WebGL"in
this)return this._Detect_WebGL;try{var a=m.createElement("canvas");this._Detect_WebGL=!(!window.WebGLRenderingContext||!a.getContext("webgl")&&!a.getContext("experimental-webgl"))}catch(c){this._Detect_WebGL=!1}return this._Detect_WebGL};e.Painter.UseSVGFor3D=function(){if(!e.nodejs)return!1;if(void 0!==this._Detect_UseSVGFor3D)return this._Detect_UseSVGFor3D;var a=null;try{a=require("canvas")}catch(c){a=null}return this._Detect_UseSVGFor3D=!a};e.Painter.Create3DRenderer=function(a,c,d,l,k,f){var h=
{renderer:null,dom:null,usesvg:d,usesvgimg:d&&e.gStyle.ImageSVG};f||(f={antialias:!0,alpha:!0});h.usewebgl=e.nodejs?!1:void 0!==k?k:e.Painter.TestWebGL();e.BatchMode&&e.browser.isChromeHeadless&&h.usewebgl&&(f.premultipliedAlpha=!1);if(d){k=null;if(e.nodejs&&h.usesvgimg)try{k=require("canvas")}catch(v){k=null,h.usesvgimg=!1,e.gStyle.ImageSVG=!1}h.usesvgimg?(k&&(f.canvas=new k(a,c),f.canvas.style={}),h.renderer=h.usewebgl?new g.WebGLRenderer(f):new g.SoftwareRenderer(f)):h.renderer=g.CreateSVGRenderer(!1,
0,m);if(h.usesvgimg||void 0!==h.renderer.makeOuterHTML)e.svg_workaround||(e.svg_workaround=[]),h.renderer.workaround_id=e.svg_workaround.length,e.svg_workaround[h.renderer.workaround_id]="<svg></svg>",h.dom=m.createElementNS("http://www.w3.org/2000/svg","path"),h.dom.setAttribute("jsroot_svg_workaround",h.renderer.workaround_id)}else h.renderer=h.usewebgl?new g.WebGLRenderer(f):new g.SoftwareRenderer(f);h.renderer.setSize(a,c);h.dom||(h.dom=h.renderer.domElement,!d&&l&&(h.dom=h.renderer.svgImage=
m.createElementNS("http://www.w3.org/2000/svg","image"),t.select(h.dom).attr("width",a).attr("height",c)));return h};e.Painter.AfterRender3D=function(a){if(a.svgImage){var c=a.domElement.toDataURL("image/png"),d=e.nodejs?"xlink_href_nodejs":"xlink:href";t.select(a.svgImage).attr(d,c)}void 0!==a.workaround_id&&("function"==typeof a.makeOuterHTML?e.svg_workaround[a.workaround_id]=a.makeOuterHTML():(d=a.domElement,c=d.toDataURL("image/png"),e.svg_workaround[a.workaround_id]='<image width="'+d.width+
'" height="'+d.height+'" xlink:href="'+c+'"></image>'))};e.Painter.ProcessSVGWorkarounds=function(a){if(!e.svg_workaround)return a;for(var c=0;c<e.svg_workaround.length;++c)a=a.replace('<path jsroot_svg_workaround="'+c+'"></path>',e.svg_workaround[c]);e.svg_workaround=void 0;return a};e.Painter.TooltipFor3D=function(a,c){this.cont=this.tt=null;this.lastlbl="";this.parent=a?a:m.body;this.canvas=c;this.abspos=!a;this.check_parent=function(a){a&&this.parent!==a&&(this.hide(),this.parent=a)};this.pos=
function(a){if(null!==this.tt){if(this.abspos){var d=e.browser.isIE?a.clientX+m.documentElement.scrollLeft:a.pageX;a=e.browser.isIE?a.clientY+m.documentElement.scrollTop:a.pageY}else{d=a.offsetX;a=a.offsetY;var c=this.parent.getBoundingClientRect(),f=this.canvas.getBoundingClientRect();void 0!==c.left&&void 0!==f.left&&(d+=f.left-c.left);void 0!==c.top&&void 0!==f.top&&(a+=f.top-c.top);d+this.tt.offsetWidth+3>=this.parent.offsetWidth&&(d=this.parent.offsetWidth-this.tt.offsetWidth-3);a+this.tt.offsetHeight+
15>=this.parent.offsetHeight&&(a=this.parent.offsetHeight-this.tt.offsetHeight-15);for(f=this.parent;f;){var h=getComputedStyle(f);if(!h||"static"!==h.position)break;if(!f.parentNode||1!=f.parentNode.nodeType)break;f=f.parentNode}f&&f!==this.parent&&(f=f.getBoundingClientRect(),d+=c.left-f.left,a+=c.top-f.top)}this.tt.style.top=a+15+"px";this.tt.style.left=d+3+"px"}};this.show=function(a,c,g){if(!a||""===a)return this.hide();if(a&&"object"==typeof a&&(a.lines||a.line)){if(a.only_status)return this.hide();
if(a.line)a=a.line;else{c=a.lines[0];for(g=1;g<a.lines.length;++g)c+="<br/>"+a.lines[g];a=c}}null===this.tt&&(this.tt=m.createElement("div"),this.tt.setAttribute("class","jsroot_tt3d_main"),this.cont=m.createElement("div"),this.cont.setAttribute("class","jsroot_tt3d_cont"),this.tt.appendChild(this.cont),this.parent.appendChild(this.tt));this.lastlbl!==a&&(this.lastlbl=this.cont.innerHTML=a,this.tt.style.width="auto",e.browser.isIE&&(this.tt.style.width=this.tt.offsetWidth))};this.hide=function(){null!==
this.tt&&this.parent.removeChild(this.tt);this.tt=null;this.lastlbl=""};return this};e.Painter.CreateOrbitControl=function(a,c,d,l,k){function f(a){if(e.Painter.IsRender3DFired(b.painter)||b.mouse_zoom_mesh)a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation();else{var c=b.DetectZoomMesh(a);if(c&&(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),b.painter&&"function"==typeof b.painter.AnalyzeMouseWheelEvent)){var d=c.object.zoom,p=c.point[d],f={name:d,ignore:!1};p=
"z"!==d?(p+b.painter.size_xy3d)/2/b.painter.size_xy3d:p/2/b.painter.size_z3d;b.painter.AnalyzeMouseWheelEvent(a,f,p,!1);"z"===d&&c.object.use_y_for_z&&(d="y");b.painter.Zoom(d,f.min,f.max)}}}function h(a){if(b.mouse_zoom_mesh)a.stopImmediatePropagation(),a.stopPropagation();else if(void 0===a.button||0===a.button)if(void 0===a.buttons||1===a.buttons){if(b.enable_zoom&&(b.mouse_zoom_mesh=b.DetectZoomMesh(a),b.mouse_zoom_mesh)){a.stopImmediatePropagation();a.stopPropagation();return}b.enable_select&&
(b.mouse_select_pnt=b.GetMousePos(a,{}))}}function v(a){if(b.mouse_zoom_mesh&&b.mouse_zoom_mesh.point2&&b.painter.Get3DZoomCoord){var d=b.mouse_zoom_mesh.object.zoom,c=b.painter.Get3DZoomCoord(b.mouse_zoom_mesh.point,d),p=b.painter.Get3DZoomCoord(b.mouse_zoom_mesh.point2,d);if(c>p){var e=c;c=p;p=e}"z"===d&&b.mouse_zoom_mesh.object.use_y_for_z&&(d="y");"z"===d&&b.mouse_zoom_mesh.object.use_y_for_z&&(d="y");c<p&&b.painter.Zoom(d,c,p)&&(b.mouse_zoom_mesh=null)}b.enable_zoom&&b.RemoveZoomMesh();b.enable_select&&
b.mouse_select_pnt&&(d=b.GetMousePos(a,{}),c=d.x==b.mouse_select_pnt.x&&d.y==b.mouse_select_pnt.y,delete b.mouse_select_pnt,c&&(c=b.GetMouseIntersects(d),b.painter.ProcessMouseClick(d,c,a)))}e.gStyle.Zooming&&e.gStyle.ZoomWheel&&l.domElement.addEventListener("wheel",f);var x=e.gStyle.Zooming&&e.gStyle.ZoomMouse,n="function"==typeof a.ProcessMouseClick;if(x||n)l.domElement.addEventListener("mousedown",h),l.domElement.addEventListener("mouseup",v);var b=new g.OrbitControls(c,l.domElement);b.enableDamping=
!1;b.dampingFactor=1;b.enableZoom=!0;k&&(b.target.copy(k),b.target0.copy(k),b.update());b.tooltip=new e.Painter.TooltipFor3D(a.select_main().node(),l.domElement);b.painter=a;b.camera=c;b.scene=d;b.renderer=l;b.raycaster=new g.Raycaster;b.raycaster.linePrecision=10;b.mouse_zoom_mesh=null;b.block_ctxt=!1;b.block_mousemove=!1;b.cursor_changed=!1;b.control_changed=!1;b.control_active=!1;b.mouse_ctxt={x:0,y:0,on:!1};b.enable_zoom=x;b.enable_select=n;b.Cleanup=function(){e.gStyle.Zooming&&e.gStyle.ZoomWheel&&
this.domElement.removeEventListener("wheel",f);if(this.enable_zoom||this.enable_select)this.domElement.removeEventListener("mousedown",h),this.domElement.removeEventListener("mouseup",v);this.domElement.removeEventListener("dblclick",this.lstn_dblclick);this.domElement.removeEventListener("contextmenu",this.lstn_contextmenu);this.domElement.removeEventListener("mousemove",this.lstn_mousemove);this.domElement.removeEventListener("mouseleave",this.lstn_mouseleave);this.dispose();this.tooltip.hide();
delete this.tooltip;delete this.painter;delete this.camera;delete this.scene;delete this.renderer;delete this.raycaster;delete this.mouse_zoom_mesh};b.HideTooltip=function(){this.tooltip.hide()};b.GetMousePos=function(a,b){b.x="offsetX"in a?a.offsetX:a.layerX;b.y="offsetY"in a?a.offsetY:a.layerY;b.clientX=a.clientX;b.clientY=a.clientY;return b};b.GetOriginDirectionIntersects=function(a,b){this.raycaster.set(a,b);a=this.raycaster.intersectObjects(this.scene.children,!0);"function"==typeof this.painter.FilterIntersects&&
(a=this.painter.FilterIntersects(a));return a};b.GetMouseIntersects=function(a){var b=this.renderer instanceof g.WebGLRenderer?this.renderer.getSize(new g.Vector2):this.renderer.domElement;a={x:a.x/b.width*2-1,y:-a.y/b.height*2+1};this.camera.updateMatrix();this.camera.updateMatrixWorld();this.raycaster.setFromCamera(a,this.camera);a=this.raycaster.intersectObjects(this.scene.children,!0);"function"==typeof this.painter.FilterIntersects&&(a=this.painter.FilterIntersects(a));return a};b.DetectZoomMesh=
function(a){a=this.GetMousePos(a,{});if(a=this.GetMouseIntersects(a))for(var b=0;b<a.length;++b)if(a[b].object.zoom)return a[b];return null};b.ProcessDblClick=function(a){(a=this.DetectZoomMesh(a))&&this.painter?this.painter.Unzoom(a.object.use_y_for_z?"y":a.object.zoom):this.reset()};b.ChangeEvent=function(){this.mouse_ctxt.on=!1;this.painter.zoom_changed_interactive=1;this.painter.Render3D(0);this.control_changed=!0};b.StartEvent=function(){this.control_active=!0;this.block_ctxt=!1;this.mouse_ctxt.on=
!1;this.tooltip.hide()};b.EndEvent=function(){this.control_active=!1;this.mouse_ctxt.on&&(this.mouse_ctxt.on=!1,this.ContextMenu(this.mouse_ctxt,this.GetMouseIntersects(this.mouse_ctxt)));this.control_changed=!1};b.MainProcessContextMenu=function(a){a.preventDefault();this.GetMousePos(a,this.mouse_ctxt);this.control_active?this.mouse_ctxt.on=!0:this.block_ctxt?this.block_ctxt=!1:this.ContextMenu(this.mouse_ctxt,this.GetMouseIntersects(this.mouse_ctxt))};b.ContextMenu=function(a,b){};b.SwitchTooltip=
function(a){this.block_mousemove=!a;!1===a&&(this.tooltip.hide(),this.RemoveZoomMesh())};b.RemoveZoomMesh=function(){this.mouse_zoom_mesh&&this.mouse_zoom_mesh.object.ShowSelection()&&this.painter.Render3D();this.mouse_zoom_mesh=null};b.MainProcessMouseMove=function(a){this.control_active&&a.buttons&&a.buttons&2&&(this.block_ctxt=!0);if(!this.control_active&&!this.block_mousemove&&this.ProcessMouseMove)if(this.mouse_zoom_mesh){var b=this.DetectZoomMesh(a);if(b=b&&b.object===this.mouse_zoom_mesh.object?
b.point:this.mouse_zoom_mesh.object.GlobalIntersect(this.raycaster))this.mouse_zoom_mesh.point2=b;b&&this.painter.enable_highlight&&this.mouse_zoom_mesh.object.ShowSelection(this.mouse_zoom_mesh.point,b)&&this.painter.Render3D(0);this.tooltip.hide()}else{a.preventDefault();var d=this.GetMousePos(a,{});b=this.GetMouseIntersects(d);var c=this.ProcessMouseMove(b),e=this.painter.GetShowStatusFunc();if(c&&e){var f="",g="",h="",k="";d&&(h=d.x.toFixed(0)+","+d.y.toFixed(0));"string"==typeof c?k=c:(f=c.name,
g=c.title,c.line?k=c.line:c.lines&&(k=c.lines.slice(1).join(" "),f=c.lines[0]));e(f,g,k,h)}this.cursor_changed=!1;if(c&&this.painter&&this.painter.IsTooltipAllowed())this.tooltip.check_parent(this.painter.select_main().node()),this.tooltip.show(c,d),this.tooltip.pos(a);else if(this.tooltip.hide(),b)for(a=0;a<b.length;++a)b[a].object.zoom&&(this.cursor_changed=!0);m.body.style.cursor=this.cursor_changed?"pointer":"auto"}};b.MainProcessMouseLeave=function(){this.tooltip.hide();"function"===typeof this.ProcessMouseLeave&&
this.ProcessMouseLeave();this.cursor_changed&&(m.body.style.cursor="auto",this.cursor_changed=!1)};b.MainProcessDblClick=function(a){this.ProcessDblClick(a)};b.addEventListener("change",b.ChangeEvent.bind(b));b.addEventListener("start",b.StartEvent.bind(b));b.addEventListener("end",b.EndEvent.bind(b));b.lstn_contextmenu=b.MainProcessContextMenu.bind(b);b.lstn_dblclick=b.MainProcessDblClick.bind(b);b.lstn_mousemove=b.MainProcessMouseMove.bind(b);b.lstn_mouseleave=b.MainProcessMouseLeave.bind(b);l.domElement.addEventListener("dblclick",
b.lstn_dblclick);l.domElement.addEventListener("contextmenu",b.lstn_contextmenu);l.domElement.addEventListener("mousemove",b.lstn_mousemove);l.domElement.addEventListener("mouseleave",b.lstn_mouseleave);return b};e.Painter.DisposeThreejsObject=function(a,c){if(a){if(a.children)for(var d=0;d<a.children.length;d++)e.Painter.DisposeThreejsObject(a.children[d]);c?a.children=[]:(a.children=void 0,a.geometry&&(a.geometry.dispose(),a.geometry=void 0),a.material&&(a.material.map&&(a.material.map.dispose(),
a.material.map=void 0),a.material.dispose(),a.material=void 0),delete a.painter,delete a.bins_index,delete a.tooltip,delete a.stack,delete a.drawn_highlight)}};e.Painter.createLineSegments=function(a,c,d,e){var k=new g.BufferGeometry;k.addAttribute("position",a instanceof Float32Array?new g.BufferAttribute(a,3):new g.Float32BufferAttribute(a,3));d&&k.setIndex(new g.BufferAttribute(d,1));if(c.isLineDashedMaterial){var f=new g.Vector3,h=new g.Vector3,l=0;if(d){var m=new Float32Array(d.length);for(var n=
0;n<d.length;n+=2){var b=d[n],p=d[n+1];f.set(a[b],a[b+1],a[b+2]);h.set(a[p],a[p+1],a[p+2]);m[n]=l;l+=h.distanceTo(f);m[n+1]=l}}else for(m=new Float32Array(a.length/3),n=0;n<a.length;n+=6)f.set(a[n],a[n+1],a[n+2]),h.set(a[n+3],a[n+4],a[n+5]),m[n/3]=l,l+=h.distanceTo(f),m[n/3+1]=l;k.addAttribute("lineDistance",new g.BufferAttribute(m,1))}return e?k:new g.LineSegments(k,c)};e.Painter.Box3D={Vertices:[new g.Vector3(1,1,1),new g.Vector3(1,1,0),new g.Vector3(1,0,1),new g.Vector3(1,0,0),new g.Vector3(0,
1,0),new g.Vector3(0,1,1),new g.Vector3(0,0,0),new g.Vector3(0,0,1)],Indexes:[0,2,1,2,3,1,4,6,5,6,7,5,4,5,1,5,0,1,7,6,2,6,3,2,5,7,0,7,2,0,1,3,4,3,6,4],Normals:[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],Segments:[0,2,2,7,7,5,5,0,1,3,3,6,6,4,4,1,1,0,3,2,6,7,4,5]};e.Painter.Box3D.MeshSegments=function(){for(var a=e.Painter.Box3D,c=new Int32Array(a.Segments.length),d=0;d<c.length;++d)for(var g=0;g<a.Indexes.length;++g)if(a.Segments[d]===a.Indexes[g]){c[d]=g;break}return c}();e.Painter.IsRender3DFired=function(a){return a&&
void 0!==a.renderer?void 0!==a.render_tmout:!1};q.prototype.cleanup=function(){};q.prototype.extractIndex=function(a){};q.prototype.setSelected=function(a,c){};q.prototype.setHighlight=function(a,c){};q.prototype.checkHighlightIndex=function(a){};r.prototype=Object.create(q.prototype);r.prototype.cleanup=function(){this.mesh&&(delete this.mesh.is_selected,this.createSpecial(null),delete this.mesh)};r.prototype.extractIndex=function(a){return a&&void 0!==a.index?a.index:void 0};r.prototype.setSelected=
function(a,c){var d=this.mesh;d.select_col==a&&d.select_indx==c&&(console.log("Reset selection"),a=null,c=void 0);d.select_col=a;d.select_indx=c;this.createSpecial(a,c);return!0};r.prototype.setHighlight=function(a,c){var d=this.mesh;d.h_index=c;a?this.createSpecial(a,c):this.createSpecial(d.select_col,d.select_indx);return!0};r.prototype.createSpecial=function(a,c){var d=this.mesh;if(a){if(!d.js_special){var l=new g.BufferGeometry;l.addAttribute("position",d.geometry.getAttribute("position"));var k=
new g.PointsMaterial({size:2*d.material.size,color:a});k.sizeAttenuation=d.material.sizeAttenuation;d.js_special=new g.Points(l,k);d.js_special.jsroot_special=!0;d.add(d.js_special)}a&&(d.js_special.material.color=new g.Color(a));void 0!==c&&d.js_special.geometry.setDrawRange(c,1)}else d.js_special&&(d.remove(d.js_special),e.Painter.DisposeThreejsObject(d.js_special),delete d.js_special)};u.prototype.AddPoint=function(a,c,d){this.pos[this.indx]=a;this.pos[this.indx+1]=c;this.pos[this.indx+2]=d;this.indx+=
3};u.prototype.CreatePoints=function(a){a=new g.PointsMaterial({size:(this.webgl?3:1)*this.scale,color:a||"black"});a=new g.Points(this.geom,a);a.nvertex=1;return a};e.Painter.PointsCreator=u;e.Painter.InteractiveControl=q;e.Painter.PointsControl=r;e.Painter.drawPolyLine3D=function(){var a=this.GetObject(),c=this.frame_painter();if(c&&c.mode3d&&c.toplevel&&a){var d=[];if(a._blob&&4==a._blob.length){var g=a._blob[1];var k=a._blob[2]}else g=a.fN,k=a.fP;for(var f=3;f<3*g;f+=3)d.push(c.grx(k[f-3]),c.gry(k[f-
2]),c.grz(k[f-1]),c.grx(k[f]),c.gry(k[f+1]),c.grz(k[f+2]));a=e.Painter.createLineSegments(d,w(this,a));c.toplevel.add(a)}};e.Painter.Create3DLineMaterial=w;return e});

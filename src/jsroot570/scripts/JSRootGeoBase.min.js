(function(g){if("function"===typeof define&&define.amd)define(["JSRootCore","threejs","ThreeCSG"],g);else if("object"===typeof exports&&"undefined"!==typeof module)g(require("./JSRootCore.js"),require("three"),require("./ThreeCSG.js"));else{if("undefined"==typeof JSROOT)throw Error("JSROOT is not defined","JSRootGeoBase.js");if("undefined"==typeof THREE)throw Error("THREE is not defined","JSRootGeoBase.js");if("undefined"==typeof ThreeBSP)throw Error("ThreeBSP is not defined","JSRootGeoBase.js");
g(JSROOT,THREE,ThreeBSP)}})(function(g,r,z){g.GEO={GradPerSegm:6,CompressComp:!0,CompLimit:20};g.GEO.BITS={kVisOverride:g.BIT(0),kVisNone:g.BIT(1),kVisThis:g.BIT(2),kVisDaughters:g.BIT(3),kVisOneLevel:g.BIT(4),kVisStreamed:g.BIT(5),kVisTouched:g.BIT(6),kVisOnScreen:g.BIT(7),kVisContainers:g.BIT(12),kVisOnly:g.BIT(13),kVisBranch:g.BIT(14),kVisRaytrace:g.BIT(15)};g.GEO.TestBit=function(a,d){a=a.fGeoAtt;return void 0===a?!1:0!==(a&d)};g.GEO.SetBit=function(a,d,c){void 0!==a.fGeoAtt&&(a.fGeoAtt=c?a.fGeoAtt|
d:a.fGeoAtt&~d)};g.GEO.ToggleBit=function(a,d){void 0!==a.fGeoAtt&&(a.fGeoAtt^=d&16777215)};g.GEO.InvisibleAll=function(a){void 0===a&&(a=!0);g.GEO.SetBit(this,g.GEO.BITS.kVisThis,!a);g.GEO.SetBit(this,g.GEO.BITS.kVisDaughters,!a);g.GEO.SetBit(this,g.GEO.BITS.kVisOneLevel,!1);if(this.fNodes)for(var d=0;d<this.fNodes.arr.length;++d)g.GEO.SetBit(this.fNodes.arr[d].fVolume,g.GEO.BITS.kVisThis,!a)};g.GEO.warn=function(a){void 0===g.GEO._warn_msgs&&(g.GEO._warn_msgs={});void 0===g.GEO._warn_msgs[a]&&(g.GEO._warn_msgs[a]=
!0,console.warn(a))};g.GEO.NodeKind=function(a){return void 0===a||null===a||"object"!==typeof a?-1:"fShape"in a&&"fTrans"in a?1:0};g.GEO.CountNumShapes=function(a){return a?"TGeoCompositeShape"!==a._typename?1:g.GEO.CountNumShapes(a.fNode.fLeft)+g.GEO.CountNumShapes(a.fNode.fRight):0};g.GEO.GeometryCreator=function(a){this.nfaces=a;this.indx=0;this.pos=new Float32Array(9*a);this.norm=new Float32Array(9*a);return this};g.GEO.GeometryCreator.prototype.AddFace3=function(a,d,c,b,e,f,l,h,g){var k=this.indx,
n=this.pos;n[k]=a;n[k+1]=d;n[k+2]=c;n[k+3]=b;n[k+4]=e;n[k+5]=f;n[k+6]=l;n[k+7]=h;n[k+8]=g;this.last4=!1;this.indx=k+9};g.GEO.GeometryCreator.prototype.StartPolygon=function(){};g.GEO.GeometryCreator.prototype.StopPolygon=function(){};g.GEO.GeometryCreator.prototype.AddFace4=function(a,d,c,b,e,f,l,h,g,m,n,q,t){var k=this.indx,w=this.pos;1!==t&&(w[k]=a,w[k+1]=d,w[k+2]=c,w[k+3]=b,w[k+4]=e,w[k+5]=f,w[k+6]=l,w[k+7]=h,w[k+8]=g,k+=9);2!==t&&(w[k]=a,w[k+1]=d,w[k+2]=c,w[k+3]=l,w[k+4]=h,w[k+5]=g,w[k+6]=m,w[k+
7]=n,w[k+8]=q,k+=9);this.last4=k!==this.indx+9;this.indx=k};g.GEO.GeometryCreator.prototype.SetNormal4=function(a,d,c,b,e,f,l,h,k,g,n,q,t){if(this.last4&&t)return console.error("missmatch between AddFace4 and SetNormal4 calls");var p=this.indx-(this.last4?18:9),m=this.norm;1!==t&&(m[p]=a,m[p+1]=d,m[p+2]=c,m[p+3]=b,m[p+4]=e,m[p+5]=f,m[p+6]=l,m[p+7]=h,m[p+8]=k,p+=9);2!==t&&(m[p]=a,m[p+1]=d,m[p+2]=c,m[p+3]=l,m[p+4]=h,m[p+5]=k,m[p+6]=g,m[p+7]=n,m[p+8]=q)};g.GEO.GeometryCreator.prototype.RecalcZ=function(a){for(var d=
this.pos,c=this.indx,b=c-(this.last4?18:9);b<c;)d[b+2]=a(d[b],d[b+1],d[b+2]),b+=3};g.GEO.GetNormal=function(a,d,c,b,e,f,l,h,k){a=new r.Vector3(a,d,c);b=new r.Vector3(b,e,f);l=new r.Vector3(l,h,k);h=new r.Vector3;k=new r.Vector3;h.subVectors(l,b);k.subVectors(a,b);h.cross(k);return h};g.GEO.GeometryCreator.prototype.CalcNormal=function(){this.cb||(this.pA=new r.Vector3,this.pB=new r.Vector3,this.pC=new r.Vector3,this.cb=new r.Vector3,this.ab=new r.Vector3);this.pA.fromArray(this.pos,this.indx-9);this.pB.fromArray(this.pos,
this.indx-6);this.pC.fromArray(this.pos,this.indx-3);this.cb.subVectors(this.pC,this.pB);this.ab.subVectors(this.pA,this.pB);this.cb.cross(this.ab);this.SetNormal(this.cb.x,this.cb.y,this.cb.z)};g.GEO.GeometryCreator.prototype.SetNormal=function(a,d,c){var b=this.indx-9,e=this.norm;e[b]=e[b+3]=e[b+6]=a;e[b+1]=e[b+4]=e[b+7]=d;e[b+2]=e[b+5]=e[b+8]=c;this.last4&&(b-=9,e[b]=e[b+3]=e[b+6]=a,e[b+1]=e[b+4]=e[b+7]=d,e[b+2]=e[b+5]=e[b+8]=c)};g.GEO.GeometryCreator.prototype.SetNormal_12_34=function(a,d,c,b,
e,f,l){void 0===l&&(l=0);var h=this.indx-(0<l?9:18),k=this.norm;1!==l&&(k[h]=a,k[h+1]=d,k[h+2]=c,k[h+3]=a,k[h+4]=d,k[h+5]=c,k[h+6]=b,k[h+7]=e,k[h+8]=f,h+=9);2!==l&&(k[h]=a,k[h+1]=d,k[h+2]=c,k[h+3]=b,k[h+4]=e,k[h+5]=f,k[h+6]=b,k[h+7]=e,k[h+8]=f)};g.GEO.GeometryCreator.prototype.Create=function(){this.nfaces!==this.indx/9&&console.error("Mismatch with created "+this.nfaces+" and filled "+this.indx/9+" number of faces");var a=new r.BufferGeometry;a.addAttribute("position",new r.BufferAttribute(this.pos,
3));a.addAttribute("normal",new r.BufferAttribute(this.norm,3));return a};g.GEO.PolygonsCreator=function(){this.polygons=[]};g.GEO.PolygonsCreator.prototype.StartPolygon=function(a){this.multi=1;this.mnormal=a};g.GEO.PolygonsCreator.prototype.StopPolygon=function(){this.multi&&(this.multi=0,console.error("Polygon should be already closed at this moment"))};g.GEO.PolygonsCreator.prototype.AddFace3=function(a,d,c,b,e,f,l,h,k){this.AddFace4(a,d,c,b,e,f,l,h,k,l,h,k,2)};g.GEO.PolygonsCreator.prototype.AddFace4=
function(a,d,c,b,e,f,l,h,k,g,n,q,t){void 0===t&&(t=0);this.v1=new z.Vertex(a,d,c,0,0,0);this.v2=1===t?null:new z.Vertex(b,e,f,0,0,0);this.v3=new z.Vertex(l,h,k,0,0,0);this.v4=2===t?null:new z.Vertex(g,n,q,0,0,0);this.reduce=t;if(this.multi)2!==t&&console.error("polygon not supported for not-reduced faces"),1===this.multi++?(a=new z.Polygon,a.vertices.push(this.mnormal?this.v2:this.v3),this.polygons.push(a)):(a=this.polygons[this.polygons.length-1],1E-12<(this.mnormal?this.v2:this.v3).diff(this.mnormal?
a.vertices[a.vertices.length-1]:a.vertices[0])&&console.error("vertex missmatch when building polygon")),1E-12>(this.mnormal?this.v3:this.v2).diff(this.mnormal?a.vertices[0]:a.vertices[a.vertices.length-1])?this.multi=0:this.mnormal?a.vertices.push(this.v3):a.vertices.unshift(this.v2);else{a=new z.Polygon;switch(t){case 0:a.vertices.push(this.v1,this.v2,this.v3,this.v4);break;case 1:a.vertices.push(this.v1,this.v3,this.v4);break;case 2:a.vertices.push(this.v1,this.v2,this.v3)}this.polygons.push(a)}};
g.GEO.PolygonsCreator.prototype.SetNormal4=function(a,d,c,b,e,f,g,h,k,m,n,q,t){this.v1.setnormal(a,d,c);this.v2&&this.v2.setnormal(b,e,f);this.v3.setnormal(g,h,k);this.v4&&this.v4.setnormal(m,n,q)};g.GEO.PolygonsCreator.prototype.SetNormal_12_34=function(a,d,c,b,e,f,g){this.v1.setnormal(a,d,c);this.v2&&this.v2.setnormal(a,d,c);this.v3.setnormal(b,e,f);this.v4&&this.v4.setnormal(b,e,f)};g.GEO.PolygonsCreator.prototype.CalcNormal=function(){this.cb||(this.pA=new r.Vector3,this.pB=new r.Vector3,this.pC=
new r.Vector3,this.cb=new r.Vector3,this.ab=new r.Vector3);this.pA.set(this.v1.x,this.v1.y,this.v1.z);1!==this.reduce?(this.pB.set(this.v2.x,this.v2.y,this.v2.z),this.pC.set(this.v3.x,this.v3.y,this.v3.z)):(this.pB.set(this.v3.x,this.v3.y,this.v3.z),this.pC.set(this.v4.x,this.v4.y,this.v4.z));this.cb.subVectors(this.pC,this.pB);this.ab.subVectors(this.pA,this.pB);this.cb.cross(this.ab);this.SetNormal(this.cb.x,this.cb.y,this.cb.z)};g.GEO.PolygonsCreator.prototype.SetNormal=function(a,d,c){this.v1.setnormal(a,
d,c);this.v2&&this.v2.setnormal(a,d,c);this.v3.setnormal(a,d,c);this.v4&&this.v4.setnormal(a,d,c)};g.GEO.PolygonsCreator.prototype.RecalcZ=function(a){this.v1.z=a(this.v1.x,this.v1.y,this.v1.z);this.v2&&(this.v2.z=a(this.v2.x,this.v2.y,this.v2.z));this.v3.z=a(this.v3.x,this.v3.y,this.v3.z);this.v4&&(this.v4.z=a(this.v4.x,this.v4.y,this.v4.z))};g.GEO.PolygonsCreator.prototype.Create=function(){return{polygons:this.polygons}};g.GEO.createCubeBuffer=function(a,d){if(0>d)return 12;var c=a.fDX,b=a.fDY;
a=a.fDZ;d=d?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(12);d.AddFace4(c,b,a,c,-b,a,c,-b,-a,c,b,-a);d.SetNormal(1,0,0);d.AddFace4(-c,b,-a,-c,-b,-a,-c,-b,a,-c,b,a);d.SetNormal(-1,0,0);d.AddFace4(-c,b,-a,-c,b,a,c,b,a,c,b,-a);d.SetNormal(0,1,0);d.AddFace4(-c,-b,a,-c,-b,-a,c,-b,-a,c,-b,a);d.SetNormal(0,-1,0);d.AddFace4(-c,b,a,-c,-b,a,c,-b,a,c,b,a);d.SetNormal(0,0,1);d.AddFace4(c,b,-a,c,-b,-a,-c,-b,-a,-c,b,-a);d.SetNormal(0,0,-1);return d.Create()};g.GEO.create8edgesBuffer=function(a,d){var c=
[4,7,6,5,0,3,7,4,4,5,1,0,6,2,1,5,7,3,2,6,1,2,3,0];d=0<d?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(12);for(var b=0;b<c.length;b+=4){var e=3*c[b],f=3*c[b+1],l=3*c[b+2],h=3*c[b+3];d.AddFace4(a[e],a[e+1],a[e+2],a[f],a[f+1],a[f+2],a[l],a[l+1],a[l+2],a[h],a[h+1],a[h+2]);0===b?d.SetNormal(0,0,1):20===b?d.SetNormal(0,0,-1):d.CalcNormal()}return d.Create()};g.GEO.createParaBuffer=function(a,d){if(0>d)return 12;var c=a.fTxy,b=a.fTxz,e=a.fTyz;return g.GEO.create8edgesBuffer([-a.fZ*b-c*a.fY-a.fX,-a.fY-
a.fZ*e,-a.fZ,-a.fZ*b+c*a.fY-a.fX,a.fY-a.fZ*e,-a.fZ,-a.fZ*b+c*a.fY+a.fX,a.fY-a.fZ*e,-a.fZ,-a.fZ*b-c*a.fY+a.fX,-a.fY-a.fZ*e,-a.fZ,a.fZ*b-c*a.fY-a.fX,-a.fY+a.fZ*e,a.fZ,a.fZ*b+c*a.fY-a.fX,a.fY+a.fZ*e,a.fZ,a.fZ*b+c*a.fY+a.fX,a.fY+a.fZ*e,a.fZ,a.fZ*b-c*a.fY+a.fX,-a.fY+a.fZ*e,a.fZ],d)};g.GEO.createTrapezoidBuffer=function(a,d){if(0>d)return 12;var c;if("TGeoTrd1"==a._typename)var b=c=a.fDY;else b=a.fDy1,c=a.fDy2;return g.GEO.create8edgesBuffer([-a.fDx1,b,-a.fDZ,a.fDx1,b,-a.fDZ,a.fDx1,-b,-a.fDZ,-a.fDx1,-b,
-a.fDZ,-a.fDx2,c,a.fDZ,a.fDx2,c,a.fDZ,a.fDx2,-c,a.fDZ,-a.fDx2,-c,a.fDZ],d)};g.GEO.createArb8Buffer=function(a,d){if(0>d)return 12;a=[a.fXY[0][0],a.fXY[0][1],-a.fDZ,a.fXY[1][0],a.fXY[1][1],-a.fDZ,a.fXY[2][0],a.fXY[2][1],-a.fDZ,a.fXY[3][0],a.fXY[3][1],-a.fDZ,a.fXY[4][0],a.fXY[4][1],a.fDZ,a.fXY[5][0],a.fXY[5][1],a.fDZ,a.fXY[6][0],a.fXY[6][1],a.fDZ,a.fXY[7][0],a.fXY[7][1],a.fDZ];for(var c=[4,7,6,6,5,4,0,3,7,7,4,0,4,5,1,1,0,4,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1],b=0;b<a.length;b+=a.length/2)for(var e=
b;e<b+a.length/2-3;e+=3)for(var f=e+3;f<b+a.length/2;f+=3)if(a[e]===a[f]&&a[e+1]===a[f+1]&&a[e+2]===a[f+2])for(var l=0;l<c.length;++l)c[l]===f/3&&(c[l]=e/3);b=[];for(l=e=0;l<c.length;l+=3){f=100*c[l]+10*c[l+1]+c[l+2];var h=100*c[l+1]+10*c[l+2]+c[l],k=100*c[l+2]+10*c[l]+c[l+1];c[l]==c[l+1]||c[l]==c[l+2]||c[l+1]==c[l+2]||0<=b.indexOf(f)||0<=b.indexOf(h)||0<=b.indexOf(k)?c[l]=c[l+1]=c[l+2]=-1:(b.push(f,h,k),e++)}l=d?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(e);for(b=0;b<c.length;b+=6){e=3*
c[b];f=3*c[b+1];h=3*c[b+2];k=3*c[b+3];var m=3*c[b+4],n=3*c[b+5],q=null;if(0<=e&&0<=k&&d)if(0===b)q=new r.Vector3(0,0,1);else if(30===b)q=new r.Vector3(0,0,-1);else{var t=g.GEO.GetNormal(a[e],a[e+1],a[e+2],a[f],a[f+1],a[f+2],a[h],a[h+1],a[h+2]);t.normalize();var p=g.GEO.GetNormal(a[k],a[k+1],a[k+2],a[m],a[m+1],a[m+2],a[n],a[n+1],a[n+2]);p.normalize();1E-12>t.distanceToSquared(p)&&(q=t)}null!==q?(l.AddFace4(a[e],a[e+1],a[e+2],a[f],a[f+1],a[f+2],a[h],a[h+1],a[h+2],a[m],a[m+1],a[m+2]),l.SetNormal(q.x,
q.y,q.z)):(0<=e&&(l.AddFace3(a[e],a[e+1],a[e+2],a[f],a[f+1],a[f+2],a[h],a[h+1],a[h+2]),l.CalcNormal()),0<=k&&(l.AddFace3(a[k],a[k+1],a[k+2],a[m],a[m+1],a[m+2],a[n],a[n+1],a[n+2]),l.CalcNormal()))}return l.Create()};g.GEO.createSphereBuffer=function(a,d){var c=[a.fRmax,a.fRmin],b=a.fPhi1,e=a.fPhi2-a.fPhi1,f=a.fTheta1,l=a.fTheta2-a.fTheta1,h=a.fNseg;a=a.fNz;var k=0>=c[1];if(0<d){var m=(k?2:4)*h*a/d;1<m&&(h=Math.max(4,Math.floor(h/Math.sqrt(m))),a=Math.max(4,Math.floor(a/Math.sqrt(m))))}var n=h*a*2,
q=2*h,t=2*h,p=360===e?0:a*(k?2:4);k&&(t=q=h);if(0>d)return n*(k?1:2)+q+t+p;m=new Float32Array(h+1);for(var w=new Float32Array(h+1),v=new Float32Array(a+1),r=new Float32Array(a+1),u=0;u<=a;++u){var x=(f+l/a*u)*Math.PI/180;v[u]=Math.sin(x);r[u]=Math.cos(x)}for(u=0;u<=h;++u)f=(b+e/h*u)*Math.PI/180,m[u]=Math.sin(f),w[u]=Math.cos(f);1E-10>=Math.abs(v[0])&&(n-=h,q=0);1E-10>=Math.abs(v[a])&&(n-=h,t=0);u=n*(k?1:2)+q+t+p;d=d?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(u);for(b=0;2>b&&(1!==b||!k);++b)for(q=
c[b],t=0===b?1:-1,f=1-b,l=1-f,n=0;n<a;++n){p=n+f;x=n+l;var y=0;1E-10>=Math.abs(v[p])?y=1:1E-10>=Math.abs(v[x])&&(y=2);for(u=0;u<h;++u)d.AddFace4(q*v[p]*w[u],q*v[p]*m[u],q*r[p],q*v[p]*w[u+1],q*v[p]*m[u+1],q*r[p],q*v[x]*w[u+1],q*v[x]*m[u+1],q*r[x],q*v[x]*w[u],q*v[x]*m[u],q*r[x],y),d.SetNormal4(t*v[p]*w[u],t*v[p]*m[u],t*r[p],t*v[p]*w[u+1],t*v[p]*m[u+1],t*r[p],t*v[x]*w[u+1],t*v[x]*m[u+1],t*r[x],t*v[x]*w[u],t*v[x]*m[u],t*r[x],y)}for(b=0;b<=a;b+=a)if(1E-10<=Math.abs(v[b]))for(q=v[b],t=r[b],f=0===b?0:1,
l=1-f,u=0;u<h;++u)d.AddFace4(c[1]*q*w[u+f],c[1]*q*m[u+f],c[1]*t,c[0]*q*w[u+f],c[0]*q*m[u+f],c[0]*t,c[0]*q*w[u+l],c[0]*q*m[u+l],c[0]*t,c[1]*q*w[u+l],c[1]*q*m[u+l],c[1]*t,k?2:0),d.CalcNormal();if(360>e)for(b=0;b<=h;b+=h)for(q=m[b],t=w[b],f=0===b?1:0,l=1-f,n=0;n<a;++n)d.AddFace4(c[1]*v[n+f]*t,c[1]*v[n+f]*q,c[1]*r[n+f],c[0]*v[n+f]*t,c[0]*v[n+f]*q,c[0]*r[n+f],c[0]*v[n+l]*t,c[0]*v[n+l]*q,c[0]*r[n+l],c[1]*v[n+l]*t,c[1]*v[n+l]*q,c[1]*r[n+l],k?2:0),d.CalcNormal();return d.Create()};g.GEO.createTubeBuffer=
function(a,d){if("TGeoCone"==a._typename||"TGeoConeSeg"==a._typename){var c=[a.fRmax2,a.fRmax1];var b=[a.fRmin2,a.fRmin1]}else c=[a.fRmax,a.fRmax],b=[a.fRmin,a.fRmin];var e=0<b[0]||0<b[1],f=0,l=360;if("TGeoConeSeg"==a._typename||"TGeoTubeSeg"==a._typename||"TGeoCtub"==a._typename)f=a.fPhi1,l=a.fPhi2-a.fPhi1;var h=Math.max(4,Math.round(l/g.GEO.GradPerSegm)),k=h*(0>=c[0]||0>=c[1]?1:2);e&&(k+=h*(0>=b[0]||0>=b[1]?1:2));0<c[0]&&(k+=h*(0<b[0]?2:1));0<c[1]&&(k+=h*(0<b[1]?2:1));360>l&&(k+=(c[0]>b[0]?2:0)+
(c[1]>b[1]?2:0));if(0>d)return k;var m=f*Math.PI/180,n=l/h*Math.PI/180;f=new Float32Array(h+1);for(var q=new Float32Array(h+1),t=0;t<=h;++t)q[t]=Math.cos(m+t*n),f[t]=Math.sin(m+t*n);d=d?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(k);var p;"TGeoCtub"==a._typename&&(p=function(c,b,d){var e=0>d?a.fNlow:a.fNhigh;return(0>d?-a.fDz:a.fDz)-(c*e[0]+b*e[1])/e[2]});for(k=0;2>k&&(1!==k||e);++k){var r=0===k?c:b;m=k;n=1-k;var v=1,A=0;r[0]!==r[1]&&(t=Math.atan2(r[1]-r[0],2*a.fDZ),v=Math.cos(t),A=Math.sin(t));
1===k&&(v*=-1,A*=-1);var u=0;0>=r[0]?u=2:0>=r[1]&&(u=1);for(t=0;t<h;++t)d.AddFace4(r[0]*q[t+m],r[0]*f[t+m],a.fDZ,r[1]*q[t+m],r[1]*f[t+m],-a.fDZ,r[1]*q[t+n],r[1]*f[t+n],-a.fDZ,r[0]*q[t+n],r[0]*f[t+n],a.fDZ,u),p&&d.RecalcZ(p),d.SetNormal_12_34(v*q[t+m],v*f[t+m],A,v*q[t+n],v*f[t+n],A,u)}for(k=0;2>k;++k)if(!(0>=c[k])){m=k;n=1-k;e=0==k?1:-1;u=0>=b[k]?2:0;2!=u||360!==l||p||d.StartPolygon(0===k);for(t=0;t<h;++t)d.AddFace4(b[k]*q[t+m],b[k]*f[t+m],e*a.fDZ,c[k]*q[t+m],c[k]*f[t+m],e*a.fDZ,c[k]*q[t+n],c[k]*f[t+
n],e*a.fDZ,b[k]*q[t+n],b[k]*f[t+n],e*a.fDZ,u),p?(d.RecalcZ(p),d.CalcNormal()):d.SetNormal(0,0,e);d.StopPolygon()}360>l&&(d.AddFace4(b[1]*q[0],b[1]*f[0],-a.fDZ,c[1]*q[0],c[1]*f[0],-a.fDZ,c[0]*q[0],c[0]*f[0],a.fDZ,b[0]*q[0],b[0]*f[0],a.fDZ,c[0]===b[0]?2:b[1]===c[1]?1:0),p&&d.RecalcZ(p),d.CalcNormal(),d.AddFace4(b[0]*q[h],b[0]*f[h],a.fDZ,c[0]*q[h],c[0]*f[h],a.fDZ,c[1]*q[h],c[1]*f[h],-a.fDZ,b[1]*q[h],b[1]*f[h],-a.fDZ,c[0]===b[0]?1:b[1]===c[1]?2:0),p&&d.RecalcZ(p),d.CalcNormal());return d.Create()};g.GEO.createEltuBuffer=
function(a,d){var c=Math.max(4,Math.round(360/g.GEO.GradPerSegm));if(0>d)return 4*c;for(var b=new Float32Array(c+1),e=new Float32Array(c+1),f=0;f<=c;++f){var l=f/c*2*Math.PI;b[f]=a.fRmin*Math.cos(l);e[f]=a.fRmax*Math.sin(l)}d=d?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(4*c);var h=1,k=0;for(f=0;f<c;++f){d.AddFace4(b[f],e[f],+a.fDZ,b[f],e[f],-a.fDZ,b[f+1],e[f+1],-a.fDZ,b[f+1],e[f+1],a.fDZ);l=h;var m=k;h=b[f+1]*a.fRmax/a.fRmin;k=e[f+1]*a.fRmin/a.fRmax;var n=Math.sqrt(h*h+k*k);h/=n;k/=n;d.SetNormal_12_34(l,
m,0,h,k,0)}for(l=0;2>l;++l)for(m=0===l?1:-1,h=l,k=1-l,f=0;f<c;++f)d.AddFace3(0,0,m*a.fDZ,b[f+h],e[f+h],m*a.fDZ,b[f+k],e[f+k],m*a.fDZ),d.SetNormal(0,0,m);return d.Create()};g.GEO.createTorusBuffer=function(a,d){var c=a.fR,b=Math.max(6,Math.round(360/g.GEO.GradPerSegm)),e=Math.max(8,Math.round(a.fDphi/g.GEO.GradPerSegm)),f=(0<a.fRmin?4:2)*b*(e+(360!==a.fDphi?1:0));if(0>d)return f;0<d&&f>d&&(b=Math.floor(b/Math.sqrt(f/d)),e=Math.floor(e/Math.sqrt(f/d)),f=(0<a.fRmin?4:2)*b*(e+(360!==a.fDphi?1:0)));for(var l=
new Float32Array(b+1),h=new Float32Array(b+1),k=new Float32Array(e+1),m=new Float32Array(e+1),n=0;n<=b;++n)l[n]=Math.sin(n/b*2*Math.PI),h[n]=Math.cos(n/b*2*Math.PI);for(var q=0;q<=e;++q)n=(a.fPhi1+a.fDphi*q/e)/180*Math.PI,k[q]=Math.sin(n),m[q]=Math.cos(n);d=d?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(f);for(var t=new r.Vector3,p=new r.Vector3,w=new r.Vector3,v=new r.Vector3,A=new r.Vector3,u=new r.Vector3,x=new r.Vector3,y=new r.Vector3,H=new r.Vector3,z=new r.Vector3,B=0;2>B&&!(0<B&&0>=
a.fRmin);++B){var C=0<B?a.fRmin:a.fRmax;f=1-B;var E=1-f,D=0<B?-1:1;for(q=0;q<e;++q){var F=q+f,G=q+E;H.x=c*m[F];H.y=c*k[F];z.x=c*m[G];z.y=c*k[G];for(n=0;n<b;++n)t.x=(c+C*h[n])*m[F],t.y=(c+C*h[n])*k[F],t.z=C*l[n],p.x=(c+C*h[n+1])*m[F],p.y=(c+C*h[n+1])*k[F],p.z=C*l[n+1],w.x=(c+C*h[n+1])*m[G],w.y=(c+C*h[n+1])*k[G],w.z=C*l[n+1],v.x=(c+C*h[n])*m[G],v.y=(c+C*h[n])*k[G],v.z=C*l[n],d.AddFace4(t.x,t.y,t.z,p.x,p.y,p.z,w.x,w.y,w.z,v.x,v.y,v.z),A.subVectors(t,H).normalize(),u.subVectors(p,H).normalize(),x.subVectors(w,
z).normalize(),y.subVectors(v,z).normalize(),d.SetNormal4(D*A.x,D*A.y,D*A.z,D*u.x,D*u.y,D*u.z,D*x.x,D*x.y,D*x.z,D*y.x,D*y.y,D*y.z)}}if(360!==a.fDphi)for(q=0;q<=e;q+=e)for(t=a.fRmax,p=a.fRmin,f=0<q?0:1,E=1-f,w=0<a.fRmin?0:1,v=0<q?1:-1,n=0;n<b;++n)d.AddFace4((c+t*h[n+f])*m[q],(c+t*h[n+f])*k[q],t*l[n+f],(c+p*h[n+f])*m[q],(c+p*h[n+f])*k[q],p*l[n+f],(c+p*h[n+E])*m[q],(c+p*h[n+E])*k[q],p*l[n+E],(c+t*h[n+E])*m[q],(c+t*h[n+E])*k[q],t*l[n+E],w),d.SetNormal(-v*k[q],v*m[q],0);return d.Create()};g.GEO.createPolygonBuffer=
function(a,d){var c=a.fPhi1,b=a.fDphi;var e="TGeoPgon"==a._typename?a.fNedges:Math.max(5,Math.round(b/g.GEO.GradPerSegm));for(var f=new Int16Array(2*a.fNz),l=0,h=!1,k=0;k<a.fNz;++k)0<a.fRmin[k]&&(h=!0);if(0>d)return(h?4:2)*e*(a.fNz-1);for(var m=360===b?null:[],n=0;2>n;++n){var q=0===n?"fRmax":"fRmin";for(k=0;k<a.fNz;++k){var t=a.fZ[k],p=a[q][k];f[2*k+n]=0;0<k&&k<a.fNz-1&&(a.fZ[k-1]===t&&a[q][k-1]===p||a[q][k+1]===p&&a[q][k-1]===p)||(0<k&&(0===n||h)&&(f[2*k+n]=1,l++),null!==m&&(0===n?m.push(new r.Vector2(p,
t)):p<a.fRmax[k]&&m.unshift(new r.Vector2(p,t))))}}var w=l*e*2;a.fRmin[0]!==a.fRmax[0]&&(w+=e*(h?2:1));a.fRmin[a.fNz-1]!==a.fRmax[a.fNz-1]&&(w+=e*(h?2:1));l=null;if(null!==m){if(m.length===2*a.fNz)for(l=[],k=a.fNz-1;0<k;--k)a.fZ[k]!==a.fZ[k-1]&&(p=2*a.fNz-1-k,l.push([p,k-1,k]),l.push([p,p+1,k-1]));else l=r.ShapeUtils.triangulateShape(m,[]);w+=2*l.length}k=c*Math.PI/180;var v=b/e*Math.PI/180;b=new Float32Array(e+1);c=new Float32Array(e+1);for(p=0;p<=e;++p)c[p]=Math.cos(k+p*v),b[p]=Math.sin(k+p*v);
d=d?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(w);for(n=0;2>n;++n){q=0===n?"fRmax":"fRmin";t=a.fZ[0];var A=a[q][0];w=1-n;v=n;for(k=0;k<a.fNz;++k)if(0!==f[2*k+n]){var u=a.fZ[k],x=a[q][k],y=1,z=0;x!==A&&(p=Math.atan2(x-A,u-t),y=Math.cos(p),z=Math.sin(p));0<n&&(y*=-1,z*=-1);for(p=0;p<e;++p)d.AddFace4(A*c[p+w],A*b[p+w],t,x*c[p+w],x*b[p+w],u,x*c[p+v],x*b[p+v],u,A*c[p+v],A*b[p+v],t),d.SetNormal_12_34(y*c[p+w],y*b[p+w],z,y*c[p+v],y*b[p+v],z);t=u;A=x}}for(k=0;k<a.fNz;k+=a.fNz-1)if(f=a.fRmin[k],n=
a.fRmax[k],f!==n){t=a.fZ[k];w=0===k?1:0;v=1-w;q=0===k?-1:1;h||l||d.StartPolygon(0<k);for(p=0;p<e;++p)d.AddFace4(f*c[p+w],f*b[p+w],t,n*c[p+w],n*b[p+w],t,n*c[p+v],n*b[p+v],t,f*c[p+v],f*b[p+v],t,h?0:2),d.SetNormal(0,0,q);d.StopPolygon()}if(l)for(p=0;p<=e;p+=e)for(w=0===p?1:2,v=3-w,a=0;a<l.length;++a)h=m[l[a][0]],k=m[l[a][w]],f=m[l[a][v]],d.AddFace3(h.x*c[p],h.x*b[p],h.y,k.x*c[p],k.x*b[p],k.y,f.x*c[p],f.x*b[p],f.y),d.CalcNormal();return d.Create()};g.GEO.createXtruBuffer=function(a,d){var c=(a.fNz-1)*
a.fNvert*2;if(0>d)return c+3*a.fNvert;for(var b=[],e=0;e<a.fNvert;++e)b.push(new r.Vector2(a.fX[e],a.fY[e]));e=r.ShapeUtils.triangulateShape(b,[]);e.length<b.length-2?(g.GEO.warn("Problem with XTRU shape "+a.fName+" with "+b.length+" vertices"),e=[]):c+=2*e.length;d=d?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(c);for(c=0;c<a.fNz-1;++c)for(var f=a.fZ[c],l=a.fScale[c],h=a.fZ[c+1],k=a.fScale[c+1],m=a.fX0[c],n=a.fX0[c+1],q=a.fY0[c],t=a.fY0[c+1],p=0;p<a.fNvert;++p){var w=(p+1)%a.fNvert;d.AddFace4(l*
a.fX[p]+m,l*a.fY[p]+q,f,k*a.fX[p]+n,k*a.fY[p]+t,h,k*a.fX[w]+n,k*a.fY[w]+t,h,l*a.fX[w]+m,l*a.fY[w]+q,f);d.CalcNormal()}for(c=0;c<=a.fNz-1;c+=a.fNz-1)for(f=a.fZ[c],l=a.fScale[c],h=a.fX0[c],k=a.fY0[c],m=0;m<e.length;++m)t=e[m],n=b[t[0]],q=b[t[0===c?2:1]],t=b[t[0===c?1:2]],d.AddFace3(l*n.x+h,l*n.y+k,f,l*q.x+h,l*q.y+k,f,l*t.x+h,l*t.y+k,f),d.SetNormal(0,0,0===c?-1:1);return d.Create()};g.GEO.createParaboloidBuffer=function(a,d){var c=Math.max(4,Math.round(360/g.GEO.GradPerSegm)),b=30;if(0<d){var e=2*c*
(b+1)/d;1<e&&(c=Math.max(5,Math.floor(c/Math.sqrt(e))),b=Math.max(5,Math.floor(b/Math.sqrt(e))))}e=-a.fDZ;var f=a.fDZ,l=a.fRlo,h=a.fRhi;0<=a.fA?a.fB>e&&(e=a.fB):a.fB<f&&(f=a.fB);var k=Math.atan2(e,l),m=Math.atan2(f,h),n=(b+1)*c*2;0===l&&(n-=2*c);0===h&&(n-=2*c);if(0>d)return n;for(var q=new Float32Array(c+1),t=new Float32Array(c+1),p=0;p<=c;++p)t[p]=Math.cos(p/c*2*Math.PI),q[p]=Math.sin(p/c*2*Math.PI);d=d?new g.GEO.PolygonsCreator:new g.GEO.GeometryCreator(n);n=e;for(var r=0,v=0,A=-1,u=0;u<=b+1;++u)if(0!==
u||0!==l){if(u===b+1&&0===r)break;switch(u){case 0:var x=e;var y=l;break;case b:x=f;y=h;break;case b+1:x=f;y=0;break;default:p=Math.tan(k+(m-k)*u/b),y=.5*(p+Math.sqrt(p*p-4*a.fA*a.fB))/a.fA,1E-6>y&&(y=0),x=y*p}var z=a.fA*y;var I=0<a.fA?-1:1;var B=0;0===r?B=1:0===y&&(B=2);for(p=0;p<c;++p)d.AddFace4(y*t[p],y*q[p],x,r*t[p],r*q[p],n,r*t[p+1],r*q[p+1],n,y*t[p+1],y*q[p+1],x,B),0===B||1===u&&0===l||u===b+1&&0===h?d.SetNormal4(z*t[p],z*q[p],I,v*t[p],v*q[p],A,v*t[p+1],v*q[p+1],A,z*t[p+1],z*q[p+1],I,B):d.SetNormal(0,
0,u<b?-1:1);n=x;r=y;v=z;A=I}return d.Create()};g.GEO.createHypeBuffer=function(a,d){if(0===a.fTin&&0===a.fTout)return g.GEO.createTubeBuffer(a,d);var c=Math.max(4,Math.round(360/g.GEO.GradPerSegm)),b=30,e=c*(b+1)*(0<a.fRmin?4:2);if(0>d)return e;0<d&&d>e&&(c=Math.max(4,Math.floor(c/Math.sqrt(e/d))),b=Math.max(4,Math.floor(b/Math.sqrt(e/d))),e=c*(b+1)*(0<a.fRmin?4:2));for(var f=new Float32Array(c+1),l=new Float32Array(c+1),h=0;h<=c;++h)l[h]=Math.cos(h/c*2*Math.PI),f[h]=Math.sin(h/c*2*Math.PI);d=d?new g.GEO.PolygonsCreator:
new g.GEO.GeometryCreator(e);for(var k=0;2>k&&!(0<k&&0>=a.fRmin);++k){var m=0<k?a.fRmin:a.fRmax,n=0<k?a.fTinsq:a.fToutsq;e=1-k;for(var q=1-e,t=0;t<b;++t){var p=-a.fDz+t/b*2*a.fDz,r=-a.fDz+(t+1)/b*2*a.fDz,v=Math.sqrt(m*m+n*p*p),A=Math.sqrt(m*m+n*r*r);for(h=0;h<c;++h)d.AddFace4(v*l[h+e],v*f[h+e],p,A*l[h+e],A*f[h+e],r,A*l[h+q],A*f[h+q],r,v*l[h+q],v*f[h+q],p),d.CalcNormal()}}for(t=0;2>t;++t)for(b=0===t?a.fDz:-a.fDz,v=Math.sqrt(a.fRmax*a.fRmax+a.fToutsq*b*b),A=0<a.fRmin?Math.sqrt(a.fRmin*a.fRmin+a.fTinsq*
b*b):0,k=0<a.fRmin?0:1,e=1-t,q=1-e,h=0;h<c;++h)d.AddFace4(v*l[h+e],v*f[h+e],b,A*l[h+e],A*f[h+e],b,A*l[h+q],A*f[h+q],b,v*l[h+q],v*f[h+q],b,k),d.SetNormal(0,0,0===t?1:-1);return d.Create()};g.GEO.createMatrix=function(a){if(!a)return null;var d=null,c=null,b=null;switch(a._typename){case "TGeoTranslation":d=a.fTranslation;break;case "TGeoRotation":c=a.fRotationMatrix;break;case "TGeoScale":b=a.fScale;break;case "TGeoGenTrans":b=a.fScale;case "TGeoCombiTrans":d=a.fTranslation;a.fRotation&&(c=a.fRotation.fRotationMatrix);
break;case "TGeoHMatrix":d=a.fTranslation;c=a.fRotationMatrix;b=a.fScale;break;case "TGeoIdentity":break;default:console.warn("unsupported matrix "+a._typename)}if(!d&&!c&&!b)return null;a=new r.Matrix4;c&&a.set(c[0],c[1],c[2],0,c[3],c[4],c[5],0,c[6],c[7],c[8],0,0,0,0,1);d&&a.setPosition(new r.Vector3(d[0],d[1],d[2]));b&&a.scale(new r.Vector3(b[0],b[1],b[2]));return a};g.GEO.getNodeMatrix=function(a,d){var c=null;if(1===a)c=new r.Matrix4,null!==d.fTrans&&(c.set(d.fTrans[0],d.fTrans[4],d.fTrans[8],
0,d.fTrans[1],d.fTrans[5],d.fTrans[9],0,d.fTrans[2],d.fTrans[6],d.fTrans[10],0,0,0,0,1),c.setPosition({x:d.fTrans[12],y:d.fTrans[13],z:d.fTrans[14]}));else if("fMatrix"in d&&null!==d.fMatrix)c=g.GEO.createMatrix(d.fMatrix);else if("TGeoNodeOffset"==d._typename&&null!==d.fFinder)switch(a=g.BIT(14),0!==(d.fFinder.fBits&a)&&g.GEO.warn("Unsupported reflected pattern "+d.fFinder._typename),d.fFinder._typename){case "TGeoPatternX":case "TGeoPatternY":case "TGeoPatternZ":case "TGeoPatternParaX":case "TGeoPatternParaY":case "TGeoPatternParaZ":a=
d.fFinder.fStart+(d.fIndex+.5)*d.fFinder.fStep;c=new r.Matrix4;switch(d.fFinder._typename[d.fFinder._typename.length-1]){case "X":c.setPosition(new r.Vector3(a,0,0));break;case "Y":c.setPosition(new r.Vector3(0,a,0));break;case "Z":c.setPosition(new r.Vector3(0,0,a))}break;case "TGeoPatternCylPhi":c=Math.PI/180*(d.fFinder.fStart+(d.fIndex+.5)*d.fFinder.fStep);d=Math.cos(c);a=Math.sin(c);c=new r.Matrix4;c.set(d,-a,0,0,a,d,0,0,0,0,1,0,0,0,0,1);break;case "TGeoPatternCylR":c=new r.Matrix4;break;case "TGeoPatternTrapZ":a=
d.fFinder.fStart+(d.fIndex+.5)*d.fFinder.fStep;c=new r.Matrix4;c.setPosition(new r.Vector3(d.fFinder.fTxz*a,d.fFinder.fTyz*a,a));break;default:g.GEO.warn("Unsupported pattern type "+d.fFinder._typename)}return c};g.GEO.createComposite=function(a,d){if(0>d)return g.GEO.createGeometry(a.fNode.fLeft,-10)+g.GEO.createGeometry(a.fNode.fRight,-10);var c=!1,b=g.GEO.createMatrix(a.fNode.fLeftMat);var e=g.GEO.createMatrix(a.fNode.fRightMat);0===d?d=g.browser&&g.browser.isIE?2E3:4E3:c=!0;b&&-.9>b.determinant()&&
g.GEO.warn("Axis reflection in left composite shape - not supported");e&&-.9>e.determinant()&&g.GEO.warn("Axis reflections in right composite shape - not supported");var f="TGeoHalfSpace"==a.fNode.fLeft._typename?g.GEO.createHalfSpace(a.fNode.fLeft):g.GEO.createGeometry(a.fNode.fLeft,d);if(!f)return null;var l=g.GEO.numGeometryFaces(f),h=0;f._exceed_limit&&(l+=d);if(l<d){var k="TGeoHalfSpace"==a.fNode.fRight._typename?g.GEO.createHalfSpace(a.fNode.fRight,f):g.GEO.createGeometry(a.fNode.fRight,d);
h=g.GEO.numGeometryFaces(k)}if(l+h>=d||!k)return f.polygons&&(f=z.CreateBufferGeometry(f.polygons),g.GEO.numGeometryFaces(f)),b&&f.applyMatrix(b),f._exceed_limit=!0,f;d=new z.Geometry(f,b,g.GEO.CompressComp?0:void 0);e=new z.Geometry(k,e,d.maxid);d.maxid=e.maxid;switch(a.fNode._typename){case "TGeoIntersection":d.direct_intersect(e);break;case "TGeoUnion":d.direct_union(e);break;case "TGeoSubtraction":d.direct_subtract(e);break;default:g.GEO.warn("unsupported bool operation "+a.fNode._typename+", use first geom")}0===
g.GEO.numGeometryFaces(d)&&(g.GEO.warn("Zero faces in comp shape left: "+a.fNode.fLeft._typename+" "+g.GEO.numGeometryFaces(f)+" faces right: "+a.fNode.fRight._typename+" "+g.GEO.numGeometryFaces(k)+" faces  use first"),d=new z.Geometry(f,b));return c?{polygons:d.toPolygons()}:d.toBufferGeometry()};g.GEO.projectGeometry=function(a,d,c,b,e){a.boundingBox||a.computeBoundingBox();var f=a.boundingBox.clone();f.applyMatrix4(d);b||(b=0);if(f.min[c]>=b&&f.max[c]>=b||f.min[c]<=b&&f.max[c]<=b)return null;
a=new z.Geometry(a,d,0,e);d=2*Math.max(Math.abs(f.min.x),Math.abs(f.max.x));e=2*Math.max(Math.abs(f.min.y),Math.abs(f.max.y));f=2*Math.max(Math.abs(f.min.z),Math.abs(f.max.z));var g=1E4;switch(c){case "x":g=Math.max(e,f);break;case "y":g=Math.max(d,f);break;case "z":g=Math.max(d,e)}c=z.CreateNormal(c,b,g);a.cut_from_plane(c);return c.toBufferGeometry()};g.GEO.createGeometry=function(a,d){void 0===d&&(d=0);try{switch(a._typename){case "TGeoBBox":return g.GEO.createCubeBuffer(a,d);case "TGeoPara":return g.GEO.createParaBuffer(a,
d);case "TGeoTrd1":case "TGeoTrd2":return g.GEO.createTrapezoidBuffer(a,d);case "TGeoArb8":case "TGeoTrap":case "TGeoGtra":return g.GEO.createArb8Buffer(a,d);case "TGeoSphere":return g.GEO.createSphereBuffer(a,d);case "TGeoCone":case "TGeoConeSeg":case "TGeoTube":case "TGeoTubeSeg":case "TGeoCtub":return g.GEO.createTubeBuffer(a,d);case "TGeoEltu":return g.GEO.createEltuBuffer(a,d);case "TGeoTorus":return g.GEO.createTorusBuffer(a,d);case "TGeoPcon":case "TGeoPgon":return g.GEO.createPolygonBuffer(a,
d);case "TGeoXtru":return g.GEO.createXtruBuffer(a,d);case "TGeoParaboloid":return g.GEO.createParaboloidBuffer(a,d);case "TGeoHype":return g.GEO.createHypeBuffer(a,d);case "TGeoCompositeShape":return g.GEO.createComposite(a,d);case "TGeoShapeAssembly":break;case "TGeoScaledShape":var c=g.GEO.createGeometry(a.fShape,d);a.fScale&&0<=d&&"object"===typeof c&&"function"===typeof c.scale&&c.scale(a.fScale.fScale[0],a.fScale.fScale[1],a.fScale.fScale[2]);return c;case "TGeoHalfSpace":if(0>d)return 1;default:g.GEO.warn("unsupported shape type "+
a._typename)}}catch(b){c="",void 0!==b.stack&&(c=b.stack.split("\n")[0],c=0<=c.indexOf(b.message)?b.stack.split("\n")[1]:" at: "+c),g.GEO.warn(a._typename+" err: "+b.message+c)}return 0>d?0:null};g.GEO.createHalfSpace=function(a,d){if(!a||!a.fN||!a.fP)return null;var c=new r.Vector3(a.fP[0],a.fP[1],a.fP[2]);a=new r.Vector3(a.fN[0],a.fN[1],a.fN[2]);a.normalize();var b=1E10;d&&(d=g.GEO.geomBoundingBox(d))&&(b=1E3*d.getSize(new r.Vector3).length());d=new r.Vector3(-b,-b/2,0);var e=new r.Vector3(0,b,
0),f=new r.Vector3(b,-b/2,0);b=new r.Vector3(0,0,-b);var l=new r.Geometry;l.vertices.push(d,e,f,b);l.faces.push(new r.Face3(0,2,1));l.faces.push(new r.Face3(0,1,3));l.faces.push(new r.Face3(1,2,3));l.faces.push(new r.Face3(2,0,3));l.lookAt(a);l.computeFaceNormals();d.add(c);e.add(c);f.add(c);b.add(c);return l};g.GEO.provideInfo=function(a){function d(a){return void 0===a?"???":a==Math.round(a)&&1E7>a?Math.round(a):e?a.toExponential(4):a.toPrecision(7)}var c=[],b=null;void 0!==a.fVolume?b=a.fVolume.fShape:
void 0!==a.fShape?b=a.fShape:void 0!==a.fShapeBits&&void 0!==a.fShapeId&&(b=a);if(!b)return c.push(a._typename),c;a=Math.max(b.fDX,b.fDY,b.fDZ);var e=1E7<a||1E-7>a;c.push(b._typename);c.push("DX="+d(b.fDX)+" DY="+d(b.fDY)+" DZ="+d(b.fDZ));switch(b._typename){case "TGeoPara":c.push("Alpha="+b.fAlpha+" Phi="+b.fPhi+" Theta="+b.fTheta);break;case "TGeoTrd2":c.push("Dy1="+d(b.fDy1)+" Dy2="+d(b.fDy1));case "TGeoTrd1":c.push("Dx1="+d(b.fDx1)+" Dx2="+d(b.fDx1));break;case "TGeoSphere":c.push("Rmin="+d(b.fRmin)+
" Rmax="+d(b.fRmax));c.push("Phi1="+b.fPhi1+" Phi2="+b.fPhi2);c.push("Theta1="+b.fTheta1+" Theta2="+b.fTheta2);break;case "TGeoConeSeg":c.push("Phi1="+b.fPhi1+" Phi2="+b.fPhi2);case "TGeoCone":c.push("Rmin1="+d(b.fRmin1)+" Rmax1="+d(b.fRmax1));c.push("Rmin2="+d(b.fRmin2)+" Rmax2="+d(b.fRmax2));break;case "TGeoCtub":case "TGeoTubeSeg":c.push("Phi1="+b.fPhi1+" Phi2="+b.fPhi2);case "TGeoEltu":case "TGeoTube":c.push("Rmin="+d(b.fRmin)+" Rmax="+d(b.fRmax));break;case "TGeoTorus":c.push("Rmin="+d(b.fRmin)+
" Rmax="+d(b.fRmax));c.push("Phi1="+b.fPhi1+" Dphi="+b.fDphi);break;case "TGeoParaboloid":c.push("Rlo="+d(b.fRlo)+" Rhi="+d(b.fRhi));c.push("A="+d(b.fA)+" B="+d(b.fB));break;case "TGeoHype":c.push("Rmin="+d(b.fRmin)+" Rmax="+d(b.fRmax));c.push("StIn="+d(b.fStIn)+" StOut="+d(b.fStOut));break;case "TGeoScaledShape":c=g.GEO.provideInfo(b.fShape),b.fScale&&c.unshift("Scale X="+b.fScale.fScale[0]+" Y="+b.fScale.fScale[1]+" Z="+b.fScale.fScale[2])}return c};g.GEO.CreateProjectionMatrix=function(a){var d=
new r.Matrix4;a.updateMatrixWorld();a.matrixWorldInverse.getInverse(a.matrixWorld);d.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);return d};g.GEO.CreateFrustum=function(a){if(!a)return null;a instanceof r.PerspectiveCamera&&(a=g.GEO.CreateProjectionMatrix(a));var d=new r.Frustum;d.setFromMatrix(a);d.corners=new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,0,0,0]);d.test=new r.Vector3(0,0,0);d.CheckShape=function(a,b){var c=this.test,d=this.corners.length,
g=this.corners,h;for(h=0;h<d;h+=3)if(c.x=g[h]*b.fDX,c.y=g[h+1]*b.fDY,c.z=g[h+2]*b.fDZ,this.containsPoint(c.applyMatrix4(a)))return!0;return!1};d.CheckBox=function(a){var b=this.test,c=0;b.set(a.min.x,a.min.y,a.min.z);this.containsPoint(b)&&c++;b.set(a.min.x,a.min.y,a.max.z);this.containsPoint(b)&&c++;b.set(a.min.x,a.max.y,a.min.z);this.containsPoint(b)&&c++;b.set(a.min.x,a.max.y,a.max.z);this.containsPoint(b)&&c++;b.set(a.max.x,a.max.y,a.max.z);this.containsPoint(b)&&c++;b.set(a.max.x,a.min.y,a.max.z);
this.containsPoint(b)&&c++;b.set(a.max.x,a.max.y,a.min.z);this.containsPoint(b)&&c++;b.set(a.max.x,a.max.y,a.max.z);this.containsPoint(b)&&c++;return 5<c};return d};g.GEO.VisibleByCamera=function(a,d,c){var b=new r.Frustum,e=new r.Matrix4;a.updateMatrixWorld();a.matrixWorldInverse.getInverse(a.matrixWorld);e.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);b.setFromMatrix(e);a=[new r.Vector3(c.fDX/2,c.fDY/2,c.fDZ/2),new r.Vector3(c.fDX/2,c.fDY/2,-c.fDZ/2),new r.Vector3(c.fDX/2,-c.fDY/2,c.fDZ/
2),new r.Vector3(c.fDX/2,-c.fDY/2,-c.fDZ/2),new r.Vector3(-c.fDX/2,c.fDY/2,c.fDZ/2),new r.Vector3(-c.fDX/2,c.fDY/2,-c.fDZ/2),new r.Vector3(-c.fDX/2,-c.fDY/2,c.fDZ/2),new r.Vector3(-c.fDX/2,-c.fDY/2,-c.fDZ/2)];for(c=0;c<a.length;c++)if(b.containsPoint(a[c].applyMatrix4(d)))return!0;return!1};g.GEO.numGeometryFaces=function(a){return a?a instanceof z.Geometry?a.tree.numPolygons():"BufferGeometry"==a.type?(a=a.getAttribute("position"))?a.count/3:0:a.polygons?a.polygons.length:a.faces.length:0};g.GEO.numGeometryVertices=
function(a){return a?a instanceof z.Geometry?3*a.tree.numPolygons():"BufferGeometry"==a.type?(a=a.getAttribute("position"))?a.count:0:a.polygons?4*a.polygons.length:a.vertices.length:0};g.GEO.geomBoundingBox=function(a){if(!a)return null;var d=null;a instanceof z.Geometry?d=a.tree.collectPolygons([]):a.polygons&&(d=a.polygons);if(null!==d){a=new r.Box3;for(var c=0;c<d.length;++c)for(var b=d[c],e=b.vertices.length,f=0;f<e;++f)a.expandByPoint(b.vertices[f]);return a}a.boundingBox||a.computeBoundingBox();
return a.boundingBox.clone()};g.GEO.CompareStacks=function(a,d){if(!a||!d)return 0;if(a===d)return a.length;for(var c=Math.min(a.length,d.length),b=0;b<c;++b)if(a[b]!==d[b])return b;return c};g.GEO.IsSameStack=function(a,d){if(!a||!d)return!1;if(a===d)return!0;if(a.length!==d.length)return!1;for(var c=0;c<a.length;++c)if(a[c]!==d[c])return!1;return!0};g.GEO.ClonedNodes=function(a,d){this.toplevel=!0;this.name_prefix="";this.maxdepth=1;a?(a.$geoh&&(this.toplevel=!1),this.CreateClones(a)):d&&(this.nodes=
d)};g.GEO.ClonedNodes.prototype.updateNode=function(a){a&&!isNaN(a.id)&&a.id<this.nodes.length&&(this.nodes[a.id]=a)};g.GEO.ClonedNodes.prototype.GetNodeShape=function(a){if(!this.origin||!this.nodes)return null;var d=this.origin[a];a=this.nodes[a];if(!d||!a)return null;if(0===a.kind){if(d.fVolume)return d.fVolume.fShape}else return d.fShape;return null};g.GEO.ClonedNodes.prototype.Cleanup=function(a,d){if(a)for(var c=0;c<a.length;++c)delete a[c].stack,a[c]=void 0;if(d)for(c=0;c<d.length;++c)delete d[c].geom,
d[c]=void 0;if(this.nodes)for(c=0;c<this.nodes.length;++c)delete this.nodes[c].chlds;delete this.nodes;delete this.origin;delete this.sortmap};g.GEO.ClonedNodes.prototype.CreateClones=function(a,d,c){d||(this.origin=[],d=1,c=g.GEO.NodeKind(a));if(!(0>c||!a||"_refid"in a)){a._refid=this.origin.length;this.origin.push(a);d>this.maxdepth&&(this.maxdepth=d);var b=null;b=0===c?a.fVolume&&a.fVolume.fNodes?a.fVolume.fNodes.arr:null:a.fElements?a.fElements.arr:null;if(null!==b){g.GEO.CheckDuplicates(a,b);
for(var e=0;e<b.length;++e)this.CreateClones(b[e],d+1,c)}if(!(1<d)){this.nodes=[];d=[];for(e=0;e<this.origin.length;++e)a=this.origin[e],b={id:e,kind:c,vol:0,nfaces:0,numvischld:1,idshift:0},this.nodes.push(b),d.push(b);for(e=0;e<this.origin.length;++e){a=this.origin[e];var f=this.nodes[e],l=b=null;1===c?(l=a.fShape,a.fElements&&(b=a.fElements.arr)):a.fVolume&&(l=a.fVolume.fShape,a.fVolume.fNodes&&(b=a.fVolume.fNodes.arr));if(a=g.GEO.getNodeMatrix(c,a))if(f.matrix=a.elements,1===f.matrix[0]){a=!0;
for(var h=1;h<f.matrix.length&&a;++h)a=f.matrix[h]===(5===h||10===h||15===h?1:0);a&&delete f.matrix}l&&(f.fDX=l.fDX,f.fDY=l.fDY,f.fDZ=l.fDZ,f.vol=l.fDX*l.fDY*l.fDZ,void 0===l.$nfaces&&(l.$nfaces=g.GEO.createGeometry(l,-1)),f.nfaces=l.$nfaces,0>=f.nfaces&&(f.vol=0));if(b)for(f.chlds=new Int32Array(b.length),h=0;h<b.length;++h)f.chlds[h]=b[h]._refid}for(e=0;e<this.origin.length;++e)delete this.origin[e]._refid;d.sort(function(a,b){return b.vol-a.vol});this.sortmap=new Int32Array(this.nodes.length);
for(e=0;e<this.nodes.length;++e)this.sortmap[e]=d[e].id,d[e].sortid=e}}};g.GEO.ClonedNodes.prototype.MarkVisisble=function(a,d,c){if(!this.nodes)return 0;var b=0,e=c&&c.length===this.nodes.length;if(!e&&!this.origin)return 0;for(var f=0;f<this.nodes.length;++f){var l=this.nodes[f];l.vis=!1;l.numvischld=1;l.idshift=0;delete l.depth;if(e)l.vis=c[f].vis,void 0!==c[f].depth&&(l.depth=c[f].depth);else{var h=this.origin[f];0===l.kind?h.fVolume&&(a?(l.vis=g.GEO.TestBit(h.fVolume,g.GEO.BITS.kVisOnScreen),
d&&(g.GEO.SetBit(h.fVolume,g.GEO.BITS.kVisNone,!1),g.GEO.SetBit(h.fVolume,g.GEO.BITS.kVisThis,l.vis),g.GEO.SetBit(h.fVolume,g.GEO.BITS.kVisDaughters,!0))):(l.vis=!g.GEO.TestBit(h.fVolume,g.GEO.BITS.kVisNone)&&g.GEO.TestBit(h.fVolume,g.GEO.BITS.kVisThis)&&!h.fFinder,g.GEO.TestBit(h.fVolume,g.GEO.BITS.kVisDaughters)||(l.depth=g.GEO.TestBit(h.fVolume,g.GEO.BITS.kVisOneLevel)?1:0))):(l.vis=h.fRnrSelf,0===f&&1===this.nodes.length&&(l.vis=!0));if(0>=l.vol||0>=l.nfaces)l.vis=!1}l.vis&&b++}return b};g.GEO.ClonedNodes.prototype.GetVisibleFlags=
function(){for(var a=[],d=0;d<this.nodes.length;++d){var c={vis:this.nodes[d].vis};"depth"in this.nodes[d]&&(c.depth=this.nodes[d].depth);a.push(c)}return a};g.GEO.ClonedNodes.prototype.ScanVisible=function(a,d){if(!this.nodes)return 0;void 0===d&&(d=99999,a||(a={}),a.stack=Array(100),a.nodeid=0,a.counter=0,a.last=0,a.CopyStack=function(a){var b={nodeid:this.nodeid,seqid:this.counter,stack:10<this.last?new Int32Array(this.last):Array(this.last)};a&&(b.factor=a);for(a=0;a<this.last;++a)b.stack[a]=
this.stack[a+1];return b},a.domatrix&&(a.matrices=[],a.mpool=[new r.Matrix4],a.getmatrix=function(){return this.matrices[this.last]}));var c=0,b=this.nodes[a.nodeid];if(a.domatrix){a.mpool[a.last+1]||(a.mpool[a.last+1]=new r.Matrix4);var e=0<a.last?a.matrices[a.last-1]:new r.Matrix4;b.matrix?(a.matrices[a.last]=a.mpool[a.last].fromArray(e.elements),a.matrices[a.last].multiply(a.mpool[a.last+1].fromArray(b.matrix))):a.matrices[a.last]=e}b.vis&&0<=d&&(!a.func||a.func(b))&&c++;a.counter++;void 0!==b.depth&&
d>b.depth&&(d=b.depth);if(b.chlds&&0<b.numvischld){e=a.counter;var f=0;a.last++;for(var g=0;g<b.chlds.length;++g)a.nodeid=b.chlds[g],a.stack[a.last]=g,f+=this.ScanVisible(a,d-1);a.last--;c+=f;0===f&&(b.numvischld=0,b.idshift=a.counter-e)}else a.counter+=b.idshift;0===a.last&&(delete a.last,delete a.stack,delete a.CopyStack,delete a.counter,delete a.matrices,delete a.mpool,delete a.getmatrix);return c};g.GEO.ClonedNodes.prototype.GetNodeName=function(a){return this.origin?(a=this.origin[a])?g.GEO.ObjectName(a):
"":(a=this.nodes[a])?a.name:""};g.GEO.ClonedNodes.prototype.ResolveStack=function(a,d){var c={id:0,obj:null,node:this.nodes[0],name:this.name_prefix};d&&(c.matrix=new r.Matrix4,c.node.matrix&&c.matrix.fromArray(c.node.matrix));this.origin&&(c.obj=this.origin[0]);if(a)for(var b=0;b<a.length;++b){c.id=c.node.chlds[a[b]];c.node=this.nodes[c.id];this.origin&&(c.obj=this.origin[c.id]);var e=this.GetNodeName(c.id);e&&(c.name&&(c.name+="/"),c.name+=e);d&&c.node.matrix&&c.matrix.multiply((new r.Matrix4).fromArray(c.node.matrix))}return c};
g.GEO.ClonedNodes.prototype.MakeStackByIds=function(a){if(!a)return null;if(0!==a[0])return console.error("wrong ids - first should be 0"),null;for(var d=this.nodes[0],c=[],b=1;b<a.length;++b){var e=a[b];if(!d)return null;d=d.chlds.indexOf(e);if(0>d)return console.error("wrong nodes ids "+a[b]+" is not child of "+a[b-1]),null;c.push(d);d=this.nodes[e]}return c};g.GEO.ClonedNodes.prototype.MakeIdsByStack=function(a){if(!a)return null;for(var d=this.nodes[0],c=[0],b=0;b<a.length;++b)d=d.chlds[a[b]],
c.push(d),d=this.nodes[d];return c};g.GEO.ClonedNodes.prototype.IsNodeInStack=function(a,d){if(!a)return!0;for(var c=this.nodes[0],b=0;b<d.length;++b){c=c.chlds[d[b]];if(c==a)return!0;c=this.nodes[c]}return!1};g.GEO.ClonedNodes.prototype.FindStackByName=function(a){a=a.split("/");var d=0,c=[];if(this.GetNodeName(d)!==a[0])return null;for(var b=1;b<a.length;++b){var e=this.nodes[d];if(!e.chlds)return null;for(var f=0;f<e.chlds.length;++f){var g=e.chlds[f];if(this.GetNodeName(g)===a[b]){c.push(f);d=
g;break}}if(c.length===b-1)return null}return c};g.GEO.ClonedNodes.prototype.getDrawEntryProperties=function(a){var d=this.nodes[a.nodeid];if(2===d.kind){d={name:d.name,nname:d.name,shape:null,material:null,chlds:null};var c=a.opacity;d.fillcolor=new r.Color(a.color?"rgb("+a.color+")":"blue");d.material=new r.MeshLambertMaterial({transparent:1>c,opacity:c,wireframe:!1,color:d.fillcolor,side:r.FrontSide,vertexColors:r.NoColors,depthWrite:1==c});d.material.inherentOpacity=c;return d}if(!this.origin)return console.error("origin not there - kind",
d.kind,a.nodeid,d),null;var b=this.origin[a.nodeid];if(1===d.kind)return d={name:g.GEO.ObjectName(b),nname:g.GEO.ObjectName(b),shape:b.fShape,material:null,chlds:null},null!==b.fElements&&(d.chlds=b.fElements.arr),c=Math.min(1,b.fRGBA[3]),d.fillcolor=new r.Color(b.fRGBA[0],b.fRGBA[1],b.fRGBA[2]),d.material=new r.MeshLambertMaterial({transparent:1>c,opacity:c,wireframe:!1,color:d.fillcolor,side:r.FrontSide,vertexColors:r.NoColors,depthWrite:1==c}),d.material.inherentOpacity=c,d;var e=b.fVolume;d={name:g.GEO.ObjectName(e),
nname:g.GEO.ObjectName(b),volume:b.fVolume,shape:e.fShape,material:null,chlds:null};null!==b.fVolume.fNodes&&(d.chlds=b.fVolume.fNodes.arr);e&&(d.linewidth=e.fLineWidth);c=1;a.custom_color?d.fillcolor=a.custom_color:1<e.fFillColor&&1==e.fLineColor?d.fillcolor=g.Painter.root_colors[e.fFillColor]:0<=e.fLineColor&&(d.fillcolor=g.Painter.root_colors[e.fLineColor]);e.fMedium&&e.fMedium.fMaterial&&(a=e.fMedium.fMaterial.fFillStyle,a=3E3>a||3100<a?0:a-3E3,0<a&&(c=(100-a)/100),void 0===d.fillcolor&&(d.fillcolor=
g.Painter.root_colors[e.fMedium.fMaterial.fFillColor]));void 0===d.fillcolor&&(d.fillcolor="lightgrey");d.material=new r.MeshLambertMaterial({transparent:1>c,opacity:c,wireframe:!1,color:d.fillcolor,side:r.FrontSide,vertexColors:r.NoColors,depthWrite:1==c});d.material.inherentOpacity=c;return d};g.GEO.ClonedNodes.prototype.CreateObject3D=function(a,d,c){for(var b=this.nodes[0],e=d,f=0,g="object"==typeof c||"force"===c,h=0;h<=a.length;++h){var k=0<h?a[h-1]:0;0<h&&(b=this.nodes[b.chlds[k]]);var m=void 0;
if(e.children)for(var n=0;n<e.children.length;++n)if(e.children[n].nchld===k){m=e.children[n];break}if(m)e=m,m.$jsroot_drawable&&f++;else{if(!g)return null;m=new r.Object3D;b.matrix&&(m.matrix.fromArray(b.matrix),m.matrix.decompose(m.position,m.quaternion,m.scale));m.nchld=k;e.add(m);0==h&&"object"==typeof c&&c.scale&&(0>c.scale.x||0>c.scale.y||0>c.scale.z)&&(m.scale.copy(c.scale),m.updateMatrix());m.updateMatrixWorld();e=m}}if("mesh"===c||"delete_mesh"===c){a=null;if(e)for(b=0;b<e.children.length&&
!a;++b)f=e.children[b],"Mesh"===f.type&&void 0===f.nchld&&(a=f);if("mesh"===c||!a)return a;for(c=e;a&&a!==d;)e=a.parent,e.remove(a),a=0==e.children.length?e:null;return c}e&&(e.$jsroot_drawable=!0,e.$jsroot_depth=f);return e};g.GEO.ClonedNodes.prototype.GetVolumeBoundary=function(a,d,c){var b={min:0,max:1,sortidcut:0};if(!this.sortmap)return console.error("sorting map do not exist"),b;for(var e,f,g=0,h=0,k=0;k<this.sortmap.length&&g<c&&h<d;++k){var m=this.sortmap[k];0!==a[m]&&(f=this.nodes[m],e||
(e=f),g+=a[m],h+=a[m]*f.nfaces)}if(!f)return console.error("no volumes selected"),b;b.max=e.vol;b.min=f.vol;b.sortidcut=f.sortid;return b};g.GEO.ClonedNodes.prototype.CollectVisibles=function(a,d,c){c||(c=a/100);for(var b={facecnt:0,viscnt:new Int32Array(this.nodes.length),func:function(a){this.facecnt+=a.nfaces;this.viscnt[a.id]++;return!0}},e=0;e<b.viscnt.length;++e)b.viscnt[e]=0;this.ScanVisible(b);var f=0,g=0,h=-1,k=10,m=this.nodes.length+1;if(b.facecnt>a&&(e=this.GetVolumeBoundary(b.viscnt,a*
(d?.8:1),c*(d?.8:1)),f=e.min,g=e.max,m=e.sortidcut,d)){b.domatrix=!0;b.frustum=d;b.totalcam=0;b.func=function(a){a.vol<=f&&this.frustum.CheckShape(this.getmatrix(),a)&&(this.viscnt[a.id]++,this.totalcam+=a.nfaces);return!0};for(e=0;e<b.viscnt.length;++e)b.viscnt[e]=0;this.ScanVisible(b);h=b.totalcam>.2*a?this.GetVolumeBoundary(b.viscnt,.2*a,.2*c).min:0;k=g/(0<h?0<h:f)}b.items=[];b.func=function(a){a.sortid<m?this.items.push(this.CopyStack()):0<=h&&a.vol>h&&this.frustum.CheckShape(this.getmatrix(),
a)&&this.items.push(this.CopyStack(k));return!0};this.ScanVisible(b);return{lst:b.items,complete:0===f}};g.GEO.ClonedNodes.prototype.MergeVisibles=function(a,d){for(var c=0,b=[],e=0;e<a.length&&c<d.length;++e){for(;c<d.length&&d[c].seqid<a[e].seqid;)b.push(d[c++]);c<d.length&&d[c].seqid===a[e].seqid&&(d[c].done&&(a[e].done=!0),c++)}for(;c<d.length;)b.push(d[c++]);return b};g.GEO.ClonedNodes.prototype.CollectShapes=function(a){for(var d=[],c=0;c<a.length;++c){var b=a[c],e=this.GetNodeShape(b.nodeid);
e&&(void 0===e._id?(e._id=d.length,d.push({id:e._id,shape:e,vol:this.nodes[b.nodeid].vol,refcnt:1,factor:1,ready:!1})):d[e._id].refcnt++,b.shape=d[e._id],b.factor&&b.factor>b.shape.factor&&(b.shape.factor=b.factor))}d.sort(function(a,b){return b.vol*b.factor-a.vol*a.factor});for(c=0;c<d.length;++c)b=d[c],b.id=c,delete b.shape._id;for(c=0;c<a.length;++c)b=a[c],b.shape&&(b.shapeid=b.shape.id,delete b.shape);return d};g.GEO.ClonedNodes.prototype.MergeShapesLists=function(a,d){if(!a)return d;for(var c=
0;c<a.length;++c){var b=a[c];b.shape._geom=b.geom;delete b.geom;void 0!==b.geomZ&&(b.shape._geomZ=b.geomZ,delete b.geomZ)}for(c=0;c<d.length;++c)b=d[c],void 0!==b.shape._geom&&(b.geom=b.shape._geom,delete b.shape._geom),void 0!==b.shape._geomZ&&(b.geomZ=b.shape._geomZ,delete b.shape._geomZ);for(c=0;c<a.length;++c)b=a[c],delete b.shape._geom,delete b.shape._geomZ;return d};g.GEO.ClonedNodes.prototype.BuildShapes=function(a,d,c){for(var b=0,e=(new Date).getTime(),f={done:!1,shapes:0,faces:0,notusedshapes:0},
l=0;l<a.length;++l){var h=a[l];if(f.done)h.ready=!0;else if(h.ready||(void 0===h.geom&&(h.geom=g.GEO.createGeometry(h.shape),h.geom&&b++),h.nfaces=g.GEO.numGeometryFaces(h.geom),h.ready=!0),f.shapes++,h.used||f.notusedshapes++,f.faces+=h.nfaces*h.refcnt,f.faces>=d)f.done=!0;else if(b>.01*a.length&&void 0!==c&&(new Date).getTime()-e>c)return f}f.done=!0;return f};g.GEO.ObjectName=function(a){return a&&a.fName?a.fName+(a.$geo_suffix?a.$geo_suffix:""):""};g.GEO.CheckDuplicates=function(a,d){if(a){if(a.$geo_checked)return;
a.$geo_checked=!0}a=[];for(var c=[],b=0;b<d.length;++b){var e=d[b];if(e&&e.fName){if(!e.$geo_suffix){var f=a.indexOf(e.fName);if(0<=f){for(var l=c[f]||1;0<=a.indexOf(e.fName+"#"+l);)++l;e.$geo_suffix="#"+l;c[f]=l+1}}a.push(g.GEO.ObjectName(e))}}};g.GEO.createFlippedMesh=function(a,d,c){a=new r.Vector3(1,1,-1);if(void 0===d.geomZ)if("BufferGeometry"==d.geom.type){var b=d.geom.getAttribute("position").array,e=d.geom.getAttribute("normal").array,f=d.geom.getIndex();if(f){f=f.array;var g=d.geom.drawRange.start,
h=d.geom.drawRange.count;g+h>f.length&&(h=f.length-g);for(var k=new Float32Array(3*h),m=new Float32Array(3*h),n=0;n<h;++n){var q=f[g+n];(0>q||3*q>=b.length)&&console.log("strange index",3*q,b.length);k[3*n]=b[3*q];k[3*n+1]=b[3*q+1];k[3*n+2]=b[3*q+2];m[3*n]=e[3*q];m[3*n+1]=e[3*q+1];m[3*n+2]=e[3*q+2]}b=k;e=m}g=b.length;h=0;k=new Float32Array(g);m=new Float32Array(g);for(f=0;f<g;f+=3)k[f]=b[f+h],k[f+1]=b[f+1+h],k[f+2]=-b[f+2+h],m[f]=e[f+h],m[f+1]=e[f+1+h],m[f+2]=-e[f+2+h],h+=3,6===h&&(h=-3);d.geomZ=
new r.BufferGeometry;d.geomZ.addAttribute("position",new r.BufferAttribute(k,3));d.geomZ.addAttribute("normal",new r.BufferAttribute(m,3))}else for(d.geomZ=d.geom.clone(),d.geomZ.scale(a.x,a.y,a.z),f=0;f<d.geomZ.faces.length;)b=geom.faces[f++],e=b.b,b.b=b.c,b.c=e;d=new r.Mesh(d.geomZ,c);d.scale.copy(a);d.updateMatrix();d._flippedMesh=!0;return d};g.GEO.cleanupShape=function(a){a&&(a.geom&&"funciton"==typeof a.geom.dispose&&a.geom.dispose(),a.geomZ&&"funciton"==typeof a.geomZ.dispose&&a.geomZ.dispose(),
delete a.geom,delete a.geomZ)};g.GEO.produceRenderOrder=function(a,d,c,b){function e(a){a&&a.traverse(function(a){a.renderOrder=0;a.material&&(a.material.depthWrite=!0)})}function f(a,b,c){if(a.children)for(var d=0;d<a.children.length;++d){var g=a.children[d];g.$jsroot_order===b?g.material&&(g.material.transparent?(g.material.depthWrite=!1,c.push(g)):e(g)):(void 0===a.$jsroot_depth||a.$jsroot_depth<b)&&f(g,b,c)}}function l(a,e,f){if(300<a.length){for(var h=0;h<a.length;++h)a[h].renderOrder=(e+f)/
2;return!1}var l=new r.Vector3;for(h=0;h<a.length;++h){var n=a[h],m=n.$jsroot_box3;m||(n.$jsroot_box3=m=g.GEO.getBoundingBox(n));if("size"===c)n.$jsroot_distance=m.getSize(new r.Vector3);else if("pnt"===c)n.$jsroot_distance=d.distanceTo(m.getCenter(l));else{var q=Math.min(q,d.distanceTo(m.min),d.distanceTo(m.max)),u=new r.Vector3(m.min.x,m.min.y,m.max.z);q=Math.min(q,d.distanceTo(u));u.set(m.min.x,m.max.y,m.min.z);q=Math.min(q,d.distanceTo(u));u.set(m.max.x,m.min.y,m.min.z);q=Math.min(q,d.distanceTo(u));
u.set(m.max.x,m.max.y,m.min.z);q=Math.min(q,d.distanceTo(u));u.set(m.max.x,m.min.y,m.max.z);q=Math.min(q,d.distanceTo(u));u.set(m.min.x,m.max.y,m.max.z);q=Math.min(q,d.distanceTo(u));n.$jsroot_distance=q}}a.sort(function(a,b){return a.$jsroot_distance-b.$jsroot_distance});q=Array(a.length);for(h=0;h<a.length;++h)a[h].$jsroot_index=h,q[h]=a[h];if("ray"===c)for(h=a.length-1;0<=h;--h){n=a[h];m=n.$jsroot_box3;m=m.getCenter(l);for(u=0;2>u;++u){m.sub(d).normalize();k.set(d,m);var x=k.intersectObjects(a,
!1),y=[];for(m=0;m<x.length;++m)0>y.indexOf(x[m].object)&&y.push(x[m].object);x=y;0>x.indexOf(n)&&0<u&&console.log("MISS",b?b.ResolveStack(n.stack).name:"???");if(0<=x.indexOf(n)||0<u)break;m=n.geometry.attributes.position.array;m=new r.Vector3((m[0]+m[3]+m[6])/3,(m[1]+m[4]+m[7])/3,(m[2]+m[5]+m[8])/3);m.applyMatrix4(n.matrixWorld)}for(m=0;m<x.length-1;++m)if(n=x[m+1],u=x[m].$jsroot_index,y=n.$jsroot_index,!(u<y)){for(;y<u;++y)q[y]=q[y+1],q[y].$jsroot_index=y;q[u]=n;n.$jsroot_index=u}}for(h=0;h<q.length;++h)q[h].renderOrder=
f-(h+1)/(q.length+1)*(f-e),delete q[h].$jsroot_index,delete q[h].$jsroot_distance;return!0}function h(a,b,c,d){var e=[],g=!1;f(a,b,e);if(e.length){if(c===d)for(a=0;a<e.length;++a)e[a].renderOrder=c;else(g=l(e,c,d))||(c=d=(c+d)/2);for(a=0;a<e.length;++a){var k=e[a].parent,m=c,n=d;g&&(n=e[a].renderOrder,m=n-(d-c)/(e.length+2));h(k,b+1,m,n)}}}var k=new r.Raycaster;c&&"dflt"!==c?h(a,0,1,1E6):e(a)};g.GEO.build=function(a,d,c){if(a){d||(d={});d.numfaces||(d.numfaces=1E5);d.numnodes||(d.numnodes=1E3);d.res_mesh=
d.res_faces=0;var b=null;"fShapeBits"in a&&"fShapeId"in a?(b=a,a=null):"TGeoVolumeAssembly"===a._typename||"TGeoVolume"===a._typename?b=a.fShape:"TEveGeoShapeExtract"===a._typename||"ROOT::Experimental::TEveGeoShapeExtract"===a._typename?b=a.fShape:"TGeoManager"===a._typename?(a=a.fMasterVolume,g.GEO.SetBit(a,g.GEO.BITS.kVisThis,!1),b=a.fShape):"fVolume"in a?a.fVolume&&(b=a.fVolume.fShape):a=null;d.composite&&b&&"TGeoCompositeShape"==b._typename&&b.fNode&&(a=g.GEO.buildCompositeVolume(b));!a&&b&&
(a=g.extend(g.Create("TEveGeoShapeExtract"),{fTrans:null,fShape:b,fRGBA:[0,1,0,1],fElements:null,fRnrSelf:!0}));if(!a)return null;0===a._typename.indexOf("TGeoVolume")&&(a={_typename:"TGeoNode",fVolume:a,fName:a.fName,$geoh:a.$geoh,_proxy:!0});a=new g.GEO.ClonedNodes(a);0>=a.MarkVisisble(!0)?a.MarkVisisble(!1):a.MarkVisisble(!0,!0);a.MarkVisisble();var e=a.CollectVisibles(d.numfaces,null,d.numnodes).lst,f=a.CollectShapes(e);a.BuildShapes(f,d.numfaces);for(var l=new r.Object3D,h=0;h<e.length;++h){var k=
e[h];if(!k.done){b=f[k.shapeid];if(!b.ready){console.warn("shape marked as not ready when should");break}k.done=!0;b.used=!0;if(b.geom&&0!==b.nfaces){var m=a.getDrawEntryProperties(k);d.res_mesh++;d.res_faces+=b.nfaces;k=a.CreateObject3D(k.stack,l,d);m.material.wireframe=d.wireframe;m.material.side=d.doubleside?r.DoubleSide:r.FrontSide;b=-.9<k.matrixWorld.determinant()?new r.Mesh(b.geom,m.material):g.GEO.createFlippedMesh(k,b,m.material);k.add(b)}else a.CreateObject3D(k.stack,l,"delete_mesh")}}g.CallBack(c,
l);return l}};g.GEO.getBoundingBox=function(a,d){if(!a||!a.geometry)return d;d||(d=new r.Box3,d.makeEmpty());a.updateMatrixWorld();var c=new r.Vector3,b=a.geometry;if(b.isGeometry){var e=b.vertices;b=0;for(var f=e.length;b<f;b++)c.copy(e[b]),c.applyMatrix4(a.matrixWorld),d.expandByPoint(c)}else if(b.isBufferGeometry&&(e=b.attributes.position,void 0!==e))for(b=0,f=e.count;b<f;b++)c.fromBufferAttribute(e,b).applyMatrix4(a.matrixWorld),d.expandByPoint(c);return d};return g});

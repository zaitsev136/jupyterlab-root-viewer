var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,K,M){e!=Array.prototype&&e!=Object.prototype&&(e[K]=M.value)};$jscomp.getGlobal=function(e){return"undefined"!=typeof window&&window===e?e:"undefined"!=typeof global&&null!=global?global:e};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(e,K,M,g){if(K){M=$jscomp.global;e=e.split(".");for(g=0;g<e.length-1;g++){var Y=e[g];Y in M||(M[Y]={});M=M[Y]}e=e[e.length-1];g=M[e];K=K(g);K!=g&&null!=K&&$jscomp.defineProperty(M,e,{configurable:!0,writable:!0,value:K})}};$jscomp.arrayIteratorImpl=function(e){var K=0;return function(){return K<e.length?{done:!1,value:e[K++]}:{done:!0}}};$jscomp.arrayIterator=function(e){return{next:$jscomp.arrayIteratorImpl(e)}};$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(e,K){this.$jscomp$symbol$id_=e;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:K})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function e(M){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(M||"")+"_"+K++,M)}var K=0;return e}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.iterator;e||(e=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[e]&&$jscomp.defineProperty(Array.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.asyncIterator;e||(e=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(e){$jscomp.initSymbolIterator();e={next:e};e[$jscomp.global.Symbol.iterator]=function(){return this};return e};
$jscomp.iteratorFromArray=function(e,K){$jscomp.initSymbolIterator();e instanceof String&&(e+="");var M=0,g={next:function(){if(M<e.length){var Y=M++;return{value:K(Y,e[Y]),done:!1}}g.next=function(){return{done:!0,value:void 0}};return g.next()}};g[Symbol.iterator]=function(){return g};return g};$jscomp.polyfill("Array.prototype.entries",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(e,M){return[e,M]})}},"es6","es3");
(function(e){if("function"===typeof define&&define.amd)define(["JSRootCore","d3","JSRootPainter.hist","threejs","threejs_all"],e);else if("object"===typeof exports&&"undefined"!==typeof module){var K=require("./JSRootCore.js");e(K,require("d3"),require("./JSRootPainter.hist.js"),require("three"),require("./three.extra.min.js"),K.nodejs||"undefined"==typeof document?K.nodejs_document:document)}else{if("undefined"==typeof JSROOT)throw Error("JSROOT is not defined","JSRootPainter.hist3d.js");if("object"!=
typeof d3)throw Error("This extension requires d3.js","JSRootPainter.hist3d.js");if("undefined"==typeof THREE)throw Error("THREE is not defined","JSRoot3DPainter.js");e(JSROOT,d3,JSROOT,THREE,THREE)}})(function(e,K,M,g,Y,ja){function Q(a){e.THistPainter.call(this,a);this.mode3d=!0}function fa(a){e.TObjectPainter.call(this,a)}e.sources.push("hist3d");"undefined"==typeof ja&&"object"==typeof window&&(ja=window.document);if("undefined"===typeof e.THistPainter)throw Error("JSROOT.THistPainter is not defined",
"JSRootPainter.hist3d.js");e.TFramePainter.prototype.SetCameraPosition=function(a,b){var c=Math.max(.75*this.size_xy3d,this.size_z3d);b&&this.camera.position.set(-1.6*c,-3.5*c,1.4*this.size_z3d);if(!(!a||!b&&this.zoom_changed_interactive||isNaN(a.fTheta)||isNaN(a.fPhi)||a.fTheta===this.camera_Theta&&a.fPhi===this.camera_Phi)){c=3*Math.max(this.size_xy3d,this.size_z3d);b=(-a.fPhi-90)/180*Math.PI;var d=a.fTheta/180*Math.PI;this.camera_Phi=a.fPhi;this.camera_Theta=a.fTheta;this.camera.position.set(c*
Math.cos(b)*Math.cos(d),c*Math.sin(b)*Math.cos(d),this.size_z3d+c*Math.sin(d));b=!0}b&&this.camera.lookAt(this.lookat)};e.TFramePainter.prototype.Create3DScene=function(a){if(void 0!==a&&0>a)this.mode3d&&(this.TestAxisVisibility(null,this.toplevel),this.clear_3d_canvas(),e.Painter.DisposeThreejsObject(this.scene),this.control&&this.control.Cleanup(),this.renderer&&(this.renderer.dispose&&this.renderer.dispose(),this.renderer.context&&delete this.renderer.context),delete this.size_xy3d,delete this.size_z3d,
delete this.tooltip_mesh,delete this.scene,delete this.toplevel,delete this.camera,delete this.pointLight,delete this.renderer,delete this.control,"render_tmout"in this&&(clearTimeout(this.render_tmout),delete this.render_tmout),this.mode3d=!1);else if(this.mode3d=!0,"toplevel"in this)this.scene.remove(this.toplevel),e.Painter.DisposeThreejsObject(this.toplevel),delete this.tooltip_mesh,delete this.toplevel,this.control&&this.control.HideTooltip(),a=new g.Object3D,this.scene.add(a),this.toplevel=
a,this.Resize3D(),this.SetCameraPosition(this.root_pad(),!1);else{this.usesvg=e.Painter.UseSVGFor3D();a=this.size_for_3d(this.usesvg?3:void 0);this.size_z3d=100;this.size_xy3d=10<a.height&&10<a.width?Math.round(a.width/a.height*this.size_z3d):this.size_z3d;this.scene=new g.Scene;this.toplevel=new g.Object3D;this.scene.add(this.toplevel);this.scene_width=a.width;this.scene_height=a.height;this.camera=new g.PerspectiveCamera(45,this.scene_width/this.scene_height,1,40*this.size_z3d);this.camera_Theta=
this.camera_Phi=30;this.pointLight=new g.PointLight(16777215,1);this.camera.add(this.pointLight);this.pointLight.position.set(this.size_xy3d/2,this.size_xy3d/2,this.size_z3d/2);this.lookat=new g.Vector3(0,0,.8*this.size_z3d);this.camera.up=new g.Vector3(0,0,1);this.scene.add(this.camera);this.SetCameraPosition(this.root_pad(),!0);var b=e.Painter.Create3DRenderer(this.scene_width,this.scene_height,this.usesvg,4==a.can3d);this.renderer=b.renderer;this.webgl=b.usewebgl;this.add_3d_canvas(a,b.dom);this.first_render_tm=
0;this.enable_highlight=!1;if(!e.BatchMode){this.control=e.Painter.CreateOrbitControl(this,this.camera,this.scene,this.renderer,this.lookat);var c=this,d=this.main_painter();this.control.ProcessMouseMove=function(a){for(var b=null,d=null,m=null,e=0;e<a.length;++e)if(a[e].object.tooltip){if(b=a[e].object.tooltip(a[e])){d=a[e].object;break}}else a[e].object.zoom&&!m&&(m=a[e].object);b&&!b.use_itself&&(a=1E-4*c.size_xy3d,e=1E-4*c.size_z3d,(b.x1>b.x2||b.y1>b.y2||b.z1>b.z2)&&console.warn("check 3D hints coordinates"),
b.x1-=a,b.x2+=a,b.y1-=a,b.y2+=a,b.z1-=e,b.z2+=e);c.BinHighlight3D(b,d);return!b&&m&&c.Get3DZoomCoord?(d=m.GlobalIntersect(this.raycaster),b=m.zoom,d=c.Get3DZoomCoord(d,b),"z"===b&&m.use_y_for_z&&(b="y"),m=c.GetAxis(b),a={name:b,title:"TAxis",line:"any info",only_status:!0},m&&(a.name=m.fName,a.title=m.fTitle||"histogram TAxis object"),a.line=b+" : "+c.AxisAsText(b,d),a):b&&b.lines?b:""};this.control.ProcessMouseLeave=function(){c.BinHighlight3D(null)};this.control.ContextMenu=function(a,b){var c=
"hist",e=d;if(b)for(var g=0;g<b.length;++g){var p=b[g].object;if(p.zoom){c=p.zoom;break}if(p.painter&&"function"===typeof p.painter.ShowContextMenu){e=p.painter;break}}e.ShowContextMenu(c,a)}}}};e.TFramePainter.prototype.SetActive=function(a){this.control&&(this.control.enableKeys=a)};e.TFramePainter.prototype.Render3D=function(a){if(-1111===a){a=g.CreateSVGRenderer(!1,0,ja);a.setSize(this.scene_width,this.scene_height);a.render(this.scene,this.camera);if(a.makeOuterHTML){var b=ja.createElement("div");
b.innerHTML=a.makeOuterHTML();return b.childNodes[0]}return a.domElement}void 0===a&&(a=5);if(0>=a||this.usesvg||e.BatchMode){if("render_tmout"in this)clearTimeout(this.render_tmout);else if(-2222===a)return;void 0!==this.renderer&&(a=new Date,this.opt3d||(this.opt3d={FrontBox:!0,BackBox:!0}),this.TestAxisVisibility(this.camera,this.toplevel,this.opt3d.FrontBox,this.opt3d.BackBox),this.renderer.render(this.scene,this.camera),0===this.first_render_tm&&this.renderer instanceof g.SoftwareRenderer&&this.renderer.render(this.scene,
this.camera),e.Painter.AfterRender3D(this.renderer),b=new Date,delete this.render_tmout,0===this.first_render_tm&&(this.first_render_tm=b.getTime()-a.getTime(),this.enable_highlight=1200>this.first_render_tm&&this.IsTooltipAllowed(),console.log("First render tm = "+this.first_render_tm)))}else"render_tmout"in this||(this.render_tmout=setTimeout(this.Render3D.bind(this,0),a))};e.TFramePainter.prototype.Resize3D=function(){var a=this.size_for_3d(this.access_3d_kind());this.apply_3d_size(a);if(this.scene_width===
a.width&&this.scene_height===a.height||10>a.width||10>a.height)return!1;this.scene_width=a.width;this.scene_height=a.height;this.camera.aspect=this.scene_width/this.scene_height;this.camera.updateProjectionMatrix();this.renderer.setSize(this.scene_width,this.scene_height);return!0};e.TFramePainter.prototype.BinHighlight3D=function(a,b){var c=!1,d=null,z=!0,v=!a||void 0===a.x1||!this.enable_highlight;this.tooltip_selfmesh&&(z=this.tooltip_selfmesh!==b,this.tooltip_selfmesh.material.color=this.tooltip_selfmesh.save_color,
delete this.tooltip_selfmesh,c=!0);this.tooltip_mesh&&(d=this.tooltip_mesh,this.toplevel.remove(this.tooltip_mesh),delete this.tooltip_mesh,c=!0);if(v)c&&this.Render3D(),this.ProvideUserTooltip(null);else{if(a.use_itself)b.save_color=b.material.color,b.material.color=new g.Color(a.color),this.tooltip_selfmesh=b,c=z;else{c=!0;b=e.Painter.Box3D.Indexes;z=e.Painter.Box3D.Normals;v=e.Painter.Box3D.Vertices;var r=new g.Color(a.color?a.color:16711680),m=a.opacity||1;if(d){var u=d.geometry.attributes.position.array;
d.geometry.attributes.position.needsUpdate=!0;d.material.color=r;d.material.opacity=m}else{u=new Float32Array(3*b.length);var p=new Float32Array(3*b.length);d=new g.BufferGeometry;d.addAttribute("position",new g.BufferAttribute(u,3));d.addAttribute("normal",new g.BufferAttribute(p,3));r=new g.MeshBasicMaterial({color:r,opacity:m,flatShading:!0});d=new g.Mesh(d,r)}a.x1===a.x2&&console.warn("same tip X",a.x1,a.x2);a.y1===a.y2&&console.warn("same tip Y",a.y1,a.y2);a.z1===a.z2&&(a.z2=a.z1+1E-4);r=0;for(m=
-3;r<b.length;++r){var f=v[b[r]];u[3*r]=a.x1+f.x*(a.x2-a.x1);u[3*r+1]=a.y1+f.y*(a.y2-a.y1);u[3*r+2]=a.z1+f.z*(a.z2-a.z1);p&&(0===r%6&&(m+=3),p[3*r]=z[m],p[3*r+1]=z[m+1],p[3*r+2]=z[m+2])}this.tooltip_mesh=d;this.toplevel.add(d)}c&&this.Render3D();c&&a.$painter&&"function"==typeof a.$painter.RedrawProjection&&a.$painter.RedrawProjection(a.ix-1,a.ix,a.iy-1,a.iy);this.GetObject()&&this.ProvideUserTooltip({obj:this.GetObject(),name:this.GetObject().fName,bin:a.bin,cont:a.value,binx:a.ix,biny:a.iy,binz:a.iz,
grx:(a.x1+a.x2)/2,gry:(a.y1+a.y2)/2,grz:(a.z1+a.z2)/2})}};e.TFramePainter.prototype.TestAxisVisibility=function(a,b,c,d){function e(a,b){a<=m&&(a+=4);return a>m&&a<m+b}if(b&&b.children)for(var g=0;g<b.children.length;++g){var r=b.children[g];if(r.axis_draw)break;r=void 0}if(r)if(a){c=c?!0:!1;d=d?!0:!1;var m=1;g=a.position;0>g.x&&0<=g.y&&(m=2);0<=g.x&&0<=g.y&&(m=3);0<=g.x&&0>g.y&&(m=4);for(g=0;g<r.children.length;++g)if(a=r.children[g],a.grid)a.visible=d&&e(a.grid,3);else if(a.zid)a.visible=e(a.zid,
2);else if(a.xyid)a.visible=e(a.xyid,3);else if(a.xyboxid){b=5;var u=0;d&&!c?(b=3,u=-2):c&&!d?b=3:c||d||(b=a.bottom?3:0);a.visible=e(a.xyboxid+u,b);!a.visible&&a.bottom&&d&&(a.visible=e(a.xyboxid,3))}else a.zboxid&&(b=2,u=0,c&&d?b=5:d&&!c?b=4:!d&&c&&(u=-2,b=4),a.visible=e(a.zboxid+u,b))}else b.remove(r)};e.TFramePainter.prototype.Set3DOptions=function(a){this.opt3d=a};e.TFramePainter.prototype.DrawXYZ=function(a,b){function c(a,b,d){var c=new g.Geometry;"z"===a?c.vertices.push(new g.Vector3(0,0,0),
new g.Vector3(4*A,0,0),new g.Vector3(4*A,0,2*b),new g.Vector3(0,0,2*b)):c.vertices.push(new g.Vector3(-b,0,0),new g.Vector3(b,0,0),new g.Vector3(b,4*-A,0),new g.Vector3(-b,4*-A,0));c.faces.push(new g.Face3(0,2,1));c.faces.push(new g.Face3(0,3,2));c.computeFaceNormals();var f=new g.MeshBasicMaterial({transparent:!0,vertexColors:g.NoColors,side:g.DoubleSide,opacity:0});c=new g.Mesh(c,f);c.zoom=a;c.size_3d=b;c.use_y_for_z=d;"y"==a&&c.rotateZ(Math.PI/2).rotateX(Math.PI);c.GlobalIntersect=function(a){var b=
new g.Plane,c=this.geometry;if(c&&c.vertices&&(b.setFromCoplanarPoints(c.vertices[0],c.vertices[1],c.vertices[2]),b.applyMatrix4(this.matrixWorld),c=a.ray.origin.clone(),a=c.clone().addScaledVector(a.ray.direction,1E10),b=b.intersectLine(new g.Line3(c,a),new g.Vector3)))return a=-this.size_3d,c=this.size_3d,"z"===this.zoom&&(a=0,c=2*this.size_3d),b[this.zoom]<a?b[this.zoom]=a:b[this.zoom]>c&&(b[this.zoom]=c),b};c.ShowSelection=function(a,b){var c=this.children?this.children[0]:null,d=this.zoom;if(!a||
!b)return c&&(this.remove(c),e.Painter.DisposeThreejsObject(c)),c;if(c)var f=c.geometry;else f=this.geometry.clone(),"z"===d?f.vertices[1].x=f.vertices[2].x=A:f.vertices[2].y=f.vertices[3].y=-A,c=new g.Mesh(f,new g.MeshBasicMaterial({color:65280,side:g.DoubleSide})),this.add(c);"z"==d?(f.vertices[0].z=f.vertices[1].z=a[d],f.vertices[2].z=f.vertices[3].z=b[d]):(f.vertices[0].x=f.vertices[3].x=a[d],f.vertices[1].x=f.vertices[2].x=b[d]);f.computeFaceNormals();f.verticesNeedUpdate=!0;return f.normalsNeedUpdate=
!0};return c}b||(b={});var d=-this.size_xy3d,z=this.size_xy3d,v=-this.size_xy3d,r=this.size_xy3d,m=0,u=2*this.size_z3d,p=Math.round(.05*this.size_z3d),f=this.root_pad(),q=this.xmin,y=this.xmax,k=this.ymin,l=this.ymax,n=this.zmin,h=this.zmax,x=!1,t=!1;this.size_z3d||(d=this.xmin,z=this.xmax,v=this.ymin,r=this.ymax,m=this.zmin,u=this.zmax,p=.05*(u-m));"zoom_xmin"in this&&"zoom_xmax"in this&&this.zoom_xmin!==this.zoom_xmax&&(q=this.zoom_xmin,y=this.zoom_xmax);"zoom_ymin"in this&&"zoom_ymax"in this&&
this.zoom_ymin!==this.zoom_ymax&&(k=this.zoom_ymin,l=this.zoom_ymax,x=!0);"zoom_zmin"in this&&"zoom_zmax"in this&&this.zoom_zmin!==this.zoom_zmax&&(n=this.zoom_zmin,h=this.zoom_zmax,t=!0);b.use_y_for_z&&(this.zmin=this.ymin,this.zmax=this.ymax,n=k,h=l,t=x,k=0,l=1);this.lego_zmin=n;this.lego_zmax=h;void 0===b.zmult||t||(h*=b.zmult);if(f&&f.fLogx){0>=y&&(y=1);if(0>=q&&this.xaxis)for(x=0;x<this.xaxis.fNbins&&!(q=Math.max(q,this.xaxis.GetBinLowEdge(x+1)),0<q);++x);0>=q&&(q=1E-4*y);this.grx=K.scaleLog();
this.x_kind="log"}else this.grx=K.scaleLinear(),this.x_kind=this.xaxis&&this.xaxis.fLabels?"labels":"normal";this.logx="log"===this.x_kind;this.grx.domain([q,y]).range([d,z]);this.x_handle=new e.TAxisPainter(this.xaxis);this.x_handle.SetAxisConfig("xaxis",this.x_kind,this.grx,this.xmin,this.xmax,q,y);this.x_handle.CreateFormatFuncs();this.scale_xmin=q;this.scale_xmax=y;if(f&&f.fLogy&&!b.use_y_for_z){0>=l&&(l=1);if(0>=k&&this.yaxis)for(x=0;x<this.yaxis.fNbins&&!(k=Math.max(k,this.yaxis.GetBinLowEdge(x+
1)),0<k);++x);0>=k&&(k=1E-4*l);this.gry=K.scaleLog();this.y_kind="log"}else this.gry=K.scaleLinear(),this.y_kind=this.yaxis&&this.yaxis.fLabels?"labels":"normal";this.logy="log"===this.y_kind;this.gry.domain([k,l]).range([v,r]);this.y_handle=new e.TAxisPainter(this.yaxis);this.y_handle.SetAxisConfig("yaxis",this.y_kind,this.gry,this.ymin,this.ymax,k,l);this.y_handle.CreateFormatFuncs();this.scale_ymin=k;this.scale_ymax=l;f&&f.fLogz?(0>=h&&(h=1),0>=n&&(n=1E-4*h),this.grz=K.scaleLog(),this.z_kind="log"):
(this.grz=K.scaleLinear(),this.z_kind="normal",this.zaxis&&this.zaxis.fLabels&&3===b.ndim&&(this.z_kind="labels"));this.logz="log"===this.z_kind;this.grz.domain([n,h]).range([m,u]);this.SetRootPadRange(f,!0);this.z_handle=new e.TAxisPainter(this.zaxis);this.z_handle.SetAxisConfig("zaxis",this.z_kind,this.grz,this.zmin,this.zmax,n,h);this.z_handle.CreateFormatFuncs();this.scale_zmin=n;this.scale_zmax=h;this.x_handle.debug=!0;var D=new g.MeshBasicMaterial({color:0});f=new g.LineBasicMaterial({color:0});
var A=.5*p;y=[];var B=1;t=this.x_handle.CreateTicks(!1,!0);x=this.y_handle.CreateTicks(!1,!0);k=this.z_handle.CreateTicks(!1,!0);q=new g.Object3D;q.axis_draw=!0;a.add(q);a=[];for(var O=0,J=this.xaxis;t.next();){var H=t.grpos;n=1===t.kind;l=this.x_handle.format(t.tick,!0,!0);t.last_major()?J&&J.fTitle||(l="x"):null===l&&(n=!1,l="");if(n&&l&&0<l.length){l=new g.TextGeometry(l,{font:e.threejs_font_helvetiker_regular,size:p,height:0,curveSegments:5});l.computeBoundingBox();h=l.boundingBox.max.x-l.boundingBox.min.x;
var G=l.boundingBox.max.y-l.boundingBox.min.y;l.center=!0;O=Math.max(O,G);l.grx=H;y.push(l);t.last_major()||(G=t.next_major_grpos()-H,0<h&&(B=Math.min(B,.9*G/h)),this.x_handle.IsCenterLabels()&&(l.grx+=G/2))}a.push(H,0,0,H,n?-A:.6*-A,0)}J&&J.fTitle&&(l=new g.TextGeometry(J.fTitle,{font:e.threejs_font_helvetiker_regular,size:p,height:0,curveSegments:5}),l.computeBoundingBox(),l.center=J.TestBit(e.EAxisBits.kCenterTitle),l.gry=2,l.grx=(d+z)/2,y.push(l));this.Get3DZoomCoord=function(a,b){a=a[b];var c=
this["scale_"+b+"min"],d=this["scale_"+b+"max"];a="z"===b?a/2/this.size_z3d:(a+this.size_xy3d)/2/this.size_xy3d;return a=this["log"+b]?Math.exp(Math.log(c)+a*(Math.log(d)-Math.log(c))):c+a*(d-c)};var E=new g.Object3D;E.position.set(0,v,m);E.rotation.x=.25*Math.PI;E.xyid=2;a=e.Painter.createLineSegments(a,f);E.add(a);y.forEach(function(a){var b=a.boundingBox.max.x-a.boundingBox.min.x,c=a.center?a.grx-b/2:z-b;b=new g.Matrix4;b.set(B,0,0,c,0,B,0,(-O*B-1.5*A)*(a.gry||1),0,0,1,0,0,0,0,1);a=new g.Mesh(a,
D);a.applyMatrix(b);E.add(a)});b.zoom&&E.add(c("x",this.size_xy3d));q.add(E);E=new g.Object3D;E.position.set(0,r,m);E.rotation.x=.75*Math.PI;E.add(new g.LineSegments(a.geometry,f));y.forEach(function(a){var b=a.boundingBox.max.x-a.boundingBox.min.x,c=a.center?a.grx+b/2:z;b=new g.Matrix4;b.set(-B,0,0,c,0,B,0,(-O*B-1.5*A)*(a.gry||1),0,0,-1,0,0,0,0,1);a=new g.Mesh(a,D);a.applyMatrix(b);E.add(a)});E.xyid=4;b.zoom&&E.add(c("x",this.size_xy3d));q.add(E);y=[];B=1;O=0;a=[];for(t=this.yaxis;x.next();)J=x.grpos,
n=1===x.kind,l=this.y_handle.format(x.tick,!0,!0),x.last_major()?t&&t.fTitle||(l="y"):null===l&&(n=!1,l=""),n&&(l=new g.TextGeometry(l,{font:e.threejs_font_helvetiker_regular,size:p,height:0,curveSegments:5}),l.computeBoundingBox(),h=l.boundingBox.max.x-l.boundingBox.min.x,G=l.boundingBox.max.y-l.boundingBox.min.y,l.center=!0,O=Math.max(O,G),l.gry=J,y.push(l),x.last_major()||(G=x.next_major_grpos()-J,0<h&&(B=Math.min(B,.9*G/h)),this.y_handle.IsCenterLabels()&&(l.gry+=G/2))),a.push(0,J,0,n?-A:.6*-A,
J,0);t&&t.fTitle&&(l=new g.TextGeometry(t.fTitle,{font:e.threejs_font_helvetiker_regular,size:p,height:0,curveSegments:5}),l.computeBoundingBox(),l.center=t.TestBit(e.EAxisBits.kCenterTitle),l.grx=2,l.gry=(v+r)/2,y.push(l));if(!b.use_y_for_z){a=e.Painter.createLineSegments(a,f);var F=new g.Object3D;F.position.set(d,0,m);F.rotation.y=-.25*Math.PI;F.add(a);y.forEach(function(a){var b=a.boundingBox.max.x-a.boundingBox.min.x,c=a.center?a.gry+b/2:r;b=new g.Matrix4;b.set(0,B,0,(-O*B-1.5*A)*(a.grx||1),-B,
0,0,c,0,0,1,0,0,0,0,1);a=new g.Mesh(a,D);a.applyMatrix(b);F.add(a)});F.xyid=3;b.zoom&&F.add(c("y",this.size_xy3d));q.add(F);F=new g.Object3D;F.position.set(z,0,m);F.rotation.y=-.75*Math.PI;F.add(new g.LineSegments(a.geometry,f));y.forEach(function(a){var b=a.boundingBox.max.x-a.boundingBox.min.x,c=a.center?a.gry-b/2:r-b;b=new g.Matrix4;b.set(0,B,0,(-O*B-1.5*A)*(a.grx||1),B,0,0,c,0,0,-1,0,0,0,0,1);a=new g.Mesh(a,D);a.applyMatrix(b);F.add(a)});F.xyid=1;b.zoom&&F.add(c("y",this.size_xy3d));q.add(F)}y=
[];B=1;a=[];var L=J=H=null;x=this.zaxis;t=0;this.size_z3d&&(H=[],J=[]);for(;k.next();){var I=k.grpos;n=1==k.kind;l=this.z_handle.format(k.tick,!0,!0);null===l&&(n=!1,l="");n&&l&&(l=new g.TextGeometry(l,{font:e.threejs_font_helvetiker_regular,size:p,height:0,curveSegments:5}),l.computeBoundingBox(),h=l.boundingBox.max.x-l.boundingBox.min.x,G=l.boundingBox.max.y-l.boundingBox.min.y,l.translate(-h,-G/2,0),l.grz=I,y.push(l),null!==L&&0<G&&(B=Math.min(B,.9*(I-L)/G)),t=Math.max(t,h),L=I);H&&n&&H.push(d,
0,I,z,0,I);J&&n&&J.push(0,v,I,0,r,I);a.push(0,0,I,n?A:.6*A,0,I)}H&&0<H.length&&(k=new g.LineDashedMaterial({color:0,dashSize:2,gapSize:2}),l=e.Painter.createLineSegments(H,k),l.position.set(0,r,0),l.grid=2,l.visible=!1,q.add(l),k=new g.LineSegments(l.geometry,k),k.position.set(0,v,0),k.grid=4,k.visible=!1,q.add(k));J&&0<J.length&&(k=new g.LineDashedMaterial({color:0,dashSize:2,gapSize:2}),l=e.Painter.createLineSegments(J,k),l.position.set(z,0,0),l.grid=3,l.visible=!1,q.add(l),k=new g.LineSegments(l.geometry,
k),k.position.set(d,0,0),k.grid=1,k.visible=!1,q.add(k));var C=[];k=e.Painter.createLineSegments(a,f);for(var w=0;4>w;++w)C.push(new g.Object3D),y.forEach(function(a){var b=new g.Matrix4;b.set(-B,0,0,2*A,0,0,1,0,0,B,0,a.grz);a=new g.Mesh(a,D);a.applyMatrix(b);C[w].add(a)}),x&&x.fTitle&&(l=new g.TextGeometry(x.fTitle,{font:e.threejs_font_helvetiker_regular,size:p,height:0,curveSegments:5}),l.computeBoundingBox(),h=l.boundingBox.max.x-l.boundingBox.min.x,G=l.boundingBox.max.y-l.boundingBox.min.y,n=
x.TestBit(e.EAxisBits.kCenterTitle)?(u+m-h)/2:u-h,l.rotateZ(Math.PI/2),a=new g.Matrix4,a.set(-B,0,0,3*A+t,0,0,1,0,0,B,0,n),l=new g.Mesh(l,D),l.applyMatrix(a),C[w].add(l)),C[w].add(0==w?k:new g.LineSegments(k.geometry,f)),b.zoom&&C[w].add(c("z",this.size_z3d,b.use_y_for_z)),C[w].zid=w+2,q.add(C[w]);C[0].position.set(d,r,0);C[0].rotation.z=.75*Math.PI;C[1].position.set(z,r,0);C[1].rotation.z=.25*Math.PI;C[2].position.set(z,v,0);C[2].rotation.z=-.25*Math.PI;C[3].position.set(d,v,0);C[3].rotation.z=-.75*
Math.PI;if(0!==this.size_z3d){p=e.Painter.createLineSegments([d,0,0,z,0,0],f,null,!0);for(w=0;2>w;++w)b=new g.LineSegments(p,f),b.position.set(0,v,0===w?m:u),b.xyboxid=2,b.bottom=0==w,q.add(b),b=new g.LineSegments(p,f),b.position.set(0,r,0===w?m:u),b.xyboxid=4,b.bottom=0==w,q.add(b);v=e.Painter.createLineSegments([0,v,0,0,r,0],f,null,!0);for(w=0;2>w;++w)b=new g.LineSegments(v,f),b.position.set(d,0,0===w?m:u),b.xyboxid=3,b.bottom=0==w,q.add(b),b=new g.LineSegments(v,f),b.position.set(z,0,0===w?m:u),
b.xyboxid=1,b.bottom=0==w,q.add(b);d=e.Painter.createLineSegments([0,0,m,0,0,u],f,null,!0);for(w=0;4>w;++w)b=new g.LineSegments(d,f),b.zboxid=C[w].zid,b.position.copy(C[w].position),q.add(b)}};e.THistPainter.prototype.Draw3DBins=function(){function a(a,b,c){t=B.getBinContent(a+1,b+1);x=O?O.getBinContent(a+1,b+1):!1!==A.options.BaseLine?A.options.BaseLine:A.options.Zero?u:0;t<x&&(a=x,x=t,t=a);if(x>=I||t<L)return!1;D=t===L||x>=t;return!D||0<c?!0:B.$baseh?!1:A.options.Zero||0<u?!0:A._show_empty_bins}
if(this.draw_content){if(this.IsTH2Poly()&&this.DrawPolyLego)return this.DrawPolyLego();if(2==this.Dimension()&&this.options.Contour&&this.DrawContour3D)return this.DrawContour3D(!0);if(2==this.Dimension()&&this.options.Surf&&this.DrawSurf)return this.DrawSurf();if(2==this.Dimension()&&this.options.Error&&this.DrawError)return this.DrawError();var b=e.Painter.Box3D.Vertices,c=e.Painter.Box3D.Indexes,d=e.Painter.Box3D.Normals,z=e.Painter.Box3D.Segments,v=[0,1,1,2,2,3,3,0],r=[new g.Vector3(0,0,0),new g.Vector3(0,
1,0),new g.Vector3(1,1,0),new g.Vector3(1,0,0)],m=this.frame_painter(),u=m.grz.domain()[0],p=m.grz.domain()[1],f=this.PrepareColorDraw({rounding:!1,use3d:!0,extra:1}),q=f.i1,y=f.i2,k=f.j1,l=f.j2,n,h,x,t,D,A=this,B=this.GetHisto(),O=B?B.$baseh:null,J=11===this.options.Lego||13===this.options.Lego;if(!(q>=y||k>=l)){var H=65535>this.histo.getBin(y,l),G=[u,p],E=null;if(12===this.options.Lego||14===this.options.Lego)G=this.CreateContour(B.fContour?B.fContour.length:20,m.lego_zmin,m.lego_zmax),E=this.GetPalette();
for(var F=0;F<G.length-1;++F){var L=G[F],I=G[F+1],C=0,w=0,X=0,M=0;E&&F==G.length-2&&I<p&&(I=p);var R=m.grz(L),V=m.grz(I);for(n=q;n<y;++n)for(h=k;h<l;++h)if(a(n,h,F)){var N=!D&&0<F;var Q=!D&&t>I&&F<G.length-2;X+=D?12:c.length;N&&(X-=6);Q&&(X-=6);J&&!D&&(X-=12,M+=12)}var Z=new Float32Array(3*X),S=new Float32Array(3*X),U=H?new Uint16Array(X/3):new Uint32Array(X/3),P=null,W=null;X=null;var ba=0,ca=0,aa;0<M&&(P=new Float32Array(3*M),W=new Float32Array(3*M),X=H?new Uint16Array(M/3):new Uint32Array(M/3));
for(n=q;n<y;++n){var da=f.grx[n]+f.xbar1*(f.grx[n+1]-f.grx[n]);var ha=f.grx[n]+f.xbar2*(f.grx[n+1]-f.grx[n]);for(h=k;h<l;++h)if(a(n,h,F)){N=!D&&0<F;Q=!D&&t>I&&F<G.length-2;var ea=f.gry[h]+f.ybar1*(f.gry[h+1]-f.gry[h]);var ia=f.gry[h]+f.ybar2*(f.gry[h+1]-f.gry[h]);C=x<=L?R:m.grz(x);w=t>I?V:m.grz(t);var T=aa=0;D&&(aa+=12,T+=24);var ka=c.length,la=this.histo.getBin(n+1,h+1);for(N&&(ka-=6);T<ka;)N=b[c[T]],J&&12>T?(P[ca]=da+N.x*(ha-da),P[ca+1]=ea+N.y*(ia-ea),P[ca+2]=C+N.z*(w-C),W[ca]=d[aa],W[ca+1]=d[aa+
1],W[ca+2]=d[aa+2],0===ca%9&&(X[ca/9]=la),ca+=3):(Z[ba]=da+N.x*(ha-da),Z[ba+1]=ea+N.y*(ia-ea),Z[ba+2]=C+N.z*(w-C),S[ba]=d[aa],S[ba+1]=d[aa+1],S[ba+2]=d[aa+2],0===ba%9&&(U[ba/9]=la),ba+=3),++T,0===T%6&&(aa+=3,Q&&T===c.length-12&&(T+=6,aa+=3))}}h=new g.BufferGeometry;h.addAttribute("position",new g.BufferAttribute(Z,3));h.addAttribute("normal",new g.BufferAttribute(S,3));R=B.fFillColor;V=this.get_color(R);if(E)V=E.calcColor(F,G.length);else if(1===this.options.Lego||2>R)R=1,V="white";n=new g.MeshBasicMaterial({color:V,
flatShading:!0});n=new g.Mesh(h,n);n.face_to_bins_index=U;n.painter=this;n.zmin=u;n.zmax=p;n.baseline=!1===this.options.BaseLine?u:this.options.BaseLine;n.tip_color=3===R?16711680:65280;n.handle=f;n.tooltip=function(a){if(isNaN(a.faceIndex))return console.error("faceIndex not provided, check three.js version",g.REVISION,"expected r97"),null;if(0>a.faceIndex||a.faceIndex>=this.face_to_bins_index.length)return null;var b=this.painter,c=this.handle,d=b.frame_painter(),f=b.GetHisto();a=b.Get3DToolTip(this.face_to_bins_index[a.faceIndex]);
a.x1=Math.max(-d.size_xy3d,c.grx[a.ix-1]+c.xbar1*(c.grx[a.ix]-c.grx[a.ix-1]));a.x2=Math.min(d.size_xy3d,c.grx[a.ix-1]+c.xbar2*(c.grx[a.ix]-c.grx[a.ix-1]));a.y1=Math.max(-d.size_xy3d,c.gry[a.iy-1]+c.ybar1*(c.gry[a.iy]-c.gry[a.iy-1]));a.y2=Math.min(d.size_xy3d,c.gry[a.iy-1]+c.ybar2*(c.gry[a.iy]-c.gry[a.iy-1]));c=this.baseline;var e=a.value;f.$baseh&&(c=f.$baseh.getBinContent(a.ix,a.iy));e<c&&(f=c,c=e,e=f);a.z1=d.grz(Math.max(this.zmin,c));a.z2=d.grz(Math.min(this.zmax,e));a.color=this.tip_color;b.is_projection&&
2==b.Dimension()&&(a.$painter=b);return a};m.toplevel.add(n);0<M&&(h=new g.BufferGeometry,h.addAttribute("position",new g.BufferAttribute(P,3)),h.addAttribute("normal",new g.BufferAttribute(W,3)),R=2>R?new g.Color(16711680):new g.Color(K.rgb(V).darker(.5).toString()),R=new g.MeshBasicMaterial({color:R,flatShading:!0}),h=new g.Mesh(h,R),h.face_to_bins_index=X,h.painter=this,h.handle=n.handle,h.tooltip=n.tooltip,h.zmin=n.zmin,h.zmax=n.zmax,h.baseline=n.baseline,h.tip_color=n.tip_color,m.toplevel.add(h))}if(!(12<
this.options.Lego)){J=d=0;c=!0;H=0;I=p;L=u;for(n=q;n<y;++n)for(h=k;h<l;++h)a(n,h,0)?(d+=D?r.length:b.length,J+=D?v.length:z.length):H++;65520<d&&(c=!1);c||(d=3*J);d=new Float32Array(3*d);J=c?new Uint16Array(J):null;R=m.grz(u);V=m.grz(p);G=H=w=C=0;for(n=q;n<y;++n)for(da=f.grx[n]+f.xbar1*(f.grx[n+1]-f.grx[n]),ha=f.grx[n]+f.xbar2*(f.grx[n+1]-f.grx[n]),h=k;h<l;++h)if(a(n,h,0))if(ea=f.gry[h]+f.ybar1*(f.gry[h+1]-f.gry[h]),ia=f.gry[h]+f.ybar2*(f.gry[h+1]-f.gry[h]),C=x<=u?R:m.grz(x),w=t>p?V:m.grz(t),q=D?
v:z,E=D?r:b,c){for(T=0;T<q.length;++T)J[G++]=H/3+q[T];for(T=0;T<E.length;++T)N=E[T],d[H]=da+N.x*(ha-da),d[H+1]=ea+N.y*(ia-ea),d[H+2]=C+N.z*(w-C),H+=3}else for(T=0;T<q.length;++T)N=E[q[T]],d[H]=da+N.x*(ha-da),d[H+1]=ea+N.y*(ia-ea),d[H+2]=C+N.z*(w-C),H+=3;b=this.get_color(B.fLineColor);n=new g.LineBasicMaterial({color:new g.Color(b)});e.browser.isIE||(n.linewidth=B.fLineWidth);b=e.Painter.createLineSegments(d,n,c?J:null);m.toplevel.add(b)}}}};e.Painter.drawAxis3D=function(a,b,c){c=new e.TObjectPainter(b);
"_main"in b||c.SetDivId(a);c.Draw3DAxis=function(){var a=this.frame_painter();if(!a||!a._toplevel)return console.warn("no geo object found for 3D axis drawing");var b=(new g.Box3).setFromObject(a._toplevel);this.xmin=b.min.x;this.xmax=b.max.x;this.ymin=b.min.y;this.ymax=b.max.y;this.zmin=b.min.z;this.zmax=b.max.z;this.size_xy3d=this.size_z3d=0;this.DrawXYZ=e.TFramePainter.prototype.DrawXYZ;this.DrawXYZ(a._toplevel);a.adjustCameraPosition();a.Render3D()};c.Draw3DAxis();return c.DrawingReady()};e.TH1Painter.prototype.Draw3D=
function(a,b){this.mode3d=!0;var c=this.frame_painter(),d=this.is_main_painter(),g=this.GetHisto();b?d&&c.Resize3D()&&c.Render3D():(this.DeleteAtt(),this.ScanContent(!0),d&&(c.Create3DScene(),c.SetAxesRanges(g.fXaxis,this.xmin,this.xmax,g.fYaxis,this.ymin,this.ymax,g.fZaxis,0,0),c.Set3DOptions(this.options),c.DrawXYZ(c.toplevel,{use_y_for_z:!0,zmult:1.1,zoom:e.gStyle.Zooming,ndim:1})),this.Draw3DBins(),c.Render3D(),this.UpdateStatWebCanvas(),c.AddKeysHandler());d&&(this.DrawColorPalette(this.options.Zscale&&
(12===this.options.Lego||14===this.options.Lego)),this.DrawTitle());e.CallBack(a)};e.TH2Painter.prototype.Draw3D=function(a,b){this.mode3d=!0;var c=this.frame_painter(),d=this.is_main_painter(),g=this.GetHisto();if(b)d&&c.Resize3D()&&c.Render3D();else{b=this.root_pad();this.zmin=b.fLogz?.3*this.gminposbin:this.gminbin;this.zmax=this.gmaxbin;var v=1.1;-1111!==this.options.minimum&&(this.zmin=this.options.minimum);-1111!==this.options.maximum&&(this.zmax=this.options.maximum,v=1);b.fLogz&&0>=this.zmin&&
(this.zmin=1E-5*this.zmax);this.DeleteAtt();d&&(c.Create3DScene(),c.SetAxesRanges(g.fXaxis,this.xmin,this.xmax,g.fYaxis,this.ymin,this.ymax,g.fZaxis,this.zmin,this.zmax),c.Set3DOptions(this.options),c.DrawXYZ(c.toplevel,{zmult:v,zoom:e.gStyle.Zooming,ndim:2}));this.Draw3DBins();c.Render3D();this.UpdateStatWebCanvas();c.AddKeysHandler()}d&&(this.DrawColorPalette(this.options.Zscale&&(12===this.options.Lego||14===this.options.Lego||11===this.options.Surf||12===this.options.Surf)),this.DrawTitle());
e.CallBack(a)};e.TH2Painter.prototype.DrawContour3D=function(a){var b=this.frame_painter(),c=this.PrepareColorDraw({rounding:!1,use3d:!0,extra:100,middle:0}),d=this.GetHisto(),g=this.GetContour(),v=this.GetPalette(),r=2*b.size_z3d,m=[];this.BuildContour(c,g,v,function(c,d,f,e,z,k){if(!(3>z-e)){if(a&&(r=b.grz(g[k]),0>r||r>2*b.size_z3d))return;for(c=e;c<z;++c)m.push(d[c],f[c],r),m.push(d[c+1],f[c+1],r)}});c=e.Painter.createLineSegments(m,e.Painter.Create3DLineMaterial(this,d));b.toplevel.add(c)};e.TH2Painter.prototype.DrawSurf=
function(){function a(a,b,c,d,f,e){if(n){var h=0>c?-1:c>2*r.size_z3d?1:0,l=0>e?-1:e>2*r.size_z3d?1:0;if(h!==l||0===h){if(!D)return++J;if(0!==h){var g=e-c;c=0>h?0:2*r.size_z3d;a=d-(d-a)/g*(e-c);b=f-(f-b)/g*(e-c)}0!==l&&(g=c-e,e=0>l?0:2*r.size_z3d,d=a-(a-d)/g*(c-e),f=b-(b-f)/g*(c-e));H[G]=a;H[G+1]=b;H[G+2]=c;G+=3;H[G]=d;H[G+1]=f;H[G+2]=e;G+=3}}}function b(a,b,c,d,f,e,h,l){w>=C.length&&console.log("more than 6 points???");c=(h-c)/(e-c);e=3;0!==K&&Math.abs(c)<Math.abs(K)&&(C[w]=C[w-3],C[w+1]=C[w-2],C[w+
2]=C[w-1],w-=3,e=6);C[w]=a+c*(d-a);C[w+1]=b+c*(f-b);C[w+2]=h;l&&F&&(M[R]=C[w],M[R+1]=C[w+1],M[R+2]=C[w+2],R+=3);w+=e;K=c}function c(a,b,c){b=8*((b-m.i1)*(m.j2-m.j1)+(c-m.j1));if(0<=I[b])return console.error("More than 8 vertexes for the bin");c=b+8+I[b];I[b]--;I[c]=a}function d(a){for(var b=m.i1;b<m.i2;++b)for(var c=m.j1;c<m.j2;++c){var d=8*((b-m.i1)*(m.j2-m.j1)+(c-m.j1));if(-1!==I[d]){var f=0<=I[d]?d:d+9+I[d];d+=8;for(var e=0,h=0,l=0,g=f;g<d;++g){var k=I[g];if(0>k)return console.error("FAILURE in NORMALS RECALCULATIONS");
e+=a[k];h+=a[k+1];l+=a[k+2]}e/=d-f;h/=d-f;l/=d-f;for(g=f;g<d;++g)k=I[g],a[k]=e,a[k+1]=h,a[k+2]=l}}}function z(a,d,f,e,h,g,k,m,n,r){for(var q=1;q<l.length;++q){var t=f<l[q-1]?-1:f>l[q]?1:0,z=g<l[q-1]?-1:g>l[q]?1:0,v=n<l[q-1]?-1:n>l[q]?1:0,y=t+z+v;if(3!==y){if(-3===y)break;if(D){if(w=R=0,0===t&&(C[w]=a,C[w+1]=d,C[w+2]=f,w+=3),t!==z&&(K=0,(0>t||0>z)&&b(a,d,f,e,h,g,l[q-1]),(0<t||0<z)&&b(a,d,f,e,h,g,l[q],!0)),0===z&&(C[w]=e,C[w+1]=h,C[w+2]=g,w+=3),z!==v&&(K=0,(0>z||0>v)&&b(e,h,g,k,m,n,l[q-1]),(0<z||0<
v)&&b(e,h,g,k,m,n,l[q],!0)),0===v&&(C[w]=k,C[w+1]=m,C[w+2]=n,w+=3),v!==t&&(K=0,(0>v||0>t)&&b(k,m,n,a,d,f,l[q-1]),(0<v||0<t)&&b(k,m,n,a,d,f,l[q],!0)),0!==w)if(9>w)console.log("found less than 3 points",w/3);else{if(F&&6===R){for(t=0;6>t;++t)F[L+t]=M[t];L+=6}t=B[q];z=O[q];x&&9===w&&(c(z,u,p),c(z+3,u+1,r?p+1:p),c(z+6,r?u:u+1,p+1));for(v=3;v<w-3;v+=3)t[z]=C[0],t[z+1]=C[1],t[z+2]=C[2],z+=3,t[z]=C[v],t[z+1]=C[v+1],t[z+2]=C[v+2],z+=3,t[z]=C[v+3],t[z+1]=C[v+4],t[z+2]=C[v+5],z+=3;O[q]=z}}else y=Math.abs(z-
t)+Math.abs(v-z)+Math.abs(t-v),0===t&&++y,0===z&&++y,0===v&&++y,1!==y&&2!==y||console.error("FOND npnts",y),2<y&&(void 0===A[q]&&(A[q]=0),A[q]+=y-2),!(0<t||0<z||0<v)||t===z&&z===v&&v===t||++E}}}var v=this.GetHisto(),r=this.frame_painter(),m=this.PrepareColorDraw({rounding:!1,use3d:!0,extra:1,middle:.5}),u,p,f,q,y=r.grz.domain()[0];r.grz.domain();var k=r.logz?function(a){return a<y?-.1:r.grz(a)}:r.grz;if(!(2>m.i2-m.i1||2>m.j2-m.j1)){var l=f=null,n=!0,h=!1,x=!1,t=null;switch(this.options.Surf){case 11:f=
this.GetContour();t=this.GetPalette();break;case 12:case 15:case 17:f=this.GetContour();t=this.GetPalette();n=!1;break;case 14:n=!1;x=!0;break;case 16:f=this.GetContour();h=!0;n=!1;break;default:f=r.z_handle.CreateTicks(!0),h=!0}if(f)for(l=new Float32Array(f.length),q=0;q<f.length;++q)l[q]=k(f[q]);else l=[0,2*r.size_z3d];var D,A=[],B=[],O=[],J=0,H=null,G=0,E=0,F=null,L=0,I=null,C=new Float32Array(18),w=0,K=0,M=new Float32Array(6),R=0;if(x)for(I=new Int32Array((m.i2-m.i1)*(m.j2-m.j1)*8),f=0;f<I.length;++f)I[f]=
-1;for(D=0;2>D;++D){if(D){for(f=1;f<l.length;++f)A[f]&&(B[f]=new Float32Array(9*A[f]),O[f]=0);n&&0<J&&(H=new Float32Array(6*J));h&&0<E&&(F=new Float32Array(6*E))}for(u=m.i1;u<m.i2-1;++u){f=m.grx[u];var V=m.grx[u+1];for(p=m.j1;p<m.j2-1;++p){q=m.gry[p];var N=m.gry[p+1];var Q=k(v.getBinContent(u+1,p+1));var Z=k(v.getBinContent(u+1,p+2));var S=k(v.getBinContent(u+2,p+1));var U=k(v.getBinContent(u+2,p+2));z(f,q,Q,V,N,U,f,N,Z,!0);z(f,q,Q,V,q,S,V,N,U,!1);a(f,N,Z,f,q,Q);a(f,q,Q,V,q,S);u===m.i2-2&&a(V,q,S,
V,N,U);p===m.j2-2&&a(f,N,Z,V,N,U)}}}for(f=1;f<l.length;++f)B[f]&&(O[f]!==9*A[f]&&console.error("SURF faces missmatch lvl",f,"faces",A[f],"index",O[f],"check",9*A[f]-O[f]),k=new g.BufferGeometry,k.addAttribute("position",new g.BufferAttribute(B[f],3)),k.computeVertexNormals(),x&&1===f&&d(k.getAttribute("normal").array),t?h=t.calcColor(f,l.length):(h=1<v.fFillColor?this.get_color(v.fFillColor):"white",14===this.options.Surf&&2>v.fFillColor&&(h=this.get_color(48))),h=14===this.options.Surf?new g.MeshLambertMaterial({color:h,
side:g.DoubleSide}):new g.MeshBasicMaterial({color:h,side:g.DoubleSide}),k=new g.Mesh(k,h),r.toplevel.add(k),k.painter=this);H&&(6*J!==G&&console.error("SURF lines mismmatch nsegm",J," lindx",G,"difference",6*J-G),k=this.get_color(v.fLineColor),h=new g.LineBasicMaterial({color:new g.Color(k)}),e.browser.isIE||(h.linewidth=v.fLineWidth),k=e.Painter.createLineSegments(H,h),k.painter=this,r.toplevel.add(k));F&&(6*E!==L&&console.error("SURF grid draw mismatch ngridsegm",E,"gindx",L,"diff",6*E-L),h=1===
this.options.Surf?new g.LineDashedMaterial({color:0,dashSize:2,gapSize:2}):new g.LineBasicMaterial({color:new g.Color(this.get_color(v.fLineColor))}),k=e.Painter.createLineSegments(F,h),k.painter=this,r.toplevel.add(k));17===this.options.Surf&&this.DrawContour3D();if(13===this.options.Surf){m=this.PrepareColorDraw({rounding:!1,use3d:!0,extra:100,middle:0});l=this.GetContour();t=this.GetPalette();var P=-1,W=2*r.size_z3d;this.BuildContour(m,l,t,function(a,b,c,d,f){b[f]===b[d]&&c[f]===c[d]&&f--;if(!(3>
f-d)){for(var e=[],h=d;h<=f;++h)h!==d&&b[h]===b[h-1]&&c[h]===c[h-1]||e.push(new g.Vector2(b[h],c[h]));if(!(3>e.length)&&(d=g.ShapeUtils.triangulateShape(e,[]))&&0!==d.length){if(0>P||P!==a)P=a,W+=1E-4*r.size_z3d;b=new Float32Array(9*d.length);c=new Float32Array(9*d.length);for(h=f=0;h<d.length;++h)for(var l=d[h],k=0;3>k;++k){var m=e[l[k]];b[f]=m.x;b[f+1]=m.y;b[f+2]=W;c[f]=0;c[f+1]=0;c[f+2]=1;f+=3}e=new g.BufferGeometry;e.addAttribute("position",new g.BufferAttribute(b,3));e.addAttribute("normal",
new g.BufferAttribute(c,3));a=t.getColor(a);a=new g.MeshBasicMaterial({color:a,flatShading:!0,side:g.DoubleSide,opacity:.5});a=new g.Mesh(e,a);a.painter=this;r.toplevel.add(a)}}})}}};e.TH2Painter.prototype.DrawError=function(){for(var a=this.frame_painter(),b=this.PrepareColorDraw({rounding:!1,use3d:!0,extra:1}),c=a.grz.domain()[0],d=a.grz.domain()[1],z,v,r,m,u,p,f,q,y,k=0,l=null,n=null,h=0,x=0;2>x;++x){for(z=b.i1;z<b.i2;++z)for(p=b.grx[z],f=b.grx[z+1],v=b.j1;v<b.j2;++v)if(m=this.histo.getBinContent(z+
1,v+1),!(m<c||m>d)){if(u=m===c)u=this.options.Zero||0<c?!1:!this._show_empty_bins;u||(0===x?k+=3:(r=this.histo.getBin(z+1,v+1),u=this.histo.getBinError(r),n[h/18]=r,r=b.gry[v],q=b.gry[v+1],y=a.grz(m-u<c?c:m-u),m=a.grz(m+u>d?d:m+u),l[h]=p,l[h+3]=f,l[h+1]=l[h+4]=(r+q)/2,l[h+2]=l[h+5]=(y+m)/2,h+=6,l[h]=l[h+3]=(p+f)/2,l[h+1]=r,l[h+4]=q,l[h+2]=l[h+5]=(y+m)/2,h+=6,l[h]=l[h+3]=(p+f)/2,l[h+1]=l[h+4]=(r+q)/2,l[h+2]=y,l[h+5]=m,h+=6))}if(0===x){if(0===k)return;l=new Float32Array(6*k);n=new Int32Array(k/3)}}b=
this.get_color(this.GetObject().fLineColor);b=new g.LineBasicMaterial({color:new g.Color(b)});l=e.Painter.createLineSegments(l,b);e.browser.isIE||(b.linewidth=this.GetObject().fLineWidth);l.painter=this;l.intersect_index=n;l.zmin=c;l.zmax=d;l.tip_color=3===this.GetObject().fLineColor?16711680:65280;l.tooltip=function(a){if(isNaN(a.index))return console.error("segment index not provided, check three.js version",g.REVISION,"expected r97"),null;var b=Math.floor(a.index/6);if(0>b||b>=this.intersect_index.length)return null;
var c=this.painter;a=c.GetHisto();var d=c.frame_painter();b=c.Get3DToolTip(this.intersect_index[b]);b.x1=Math.max(-d.size_xy3d,d.grx(a.fXaxis.GetBinLowEdge(b.ix)));b.x2=Math.min(d.size_xy3d,d.grx(a.fXaxis.GetBinLowEdge(b.ix+1)));b.y1=Math.max(-d.size_xy3d,d.gry(a.fYaxis.GetBinLowEdge(b.iy)));b.y2=Math.min(d.size_xy3d,d.gry(a.fXaxis.GetBinLowEdge(b.iy+1)));b.z1=d.grz(b.value-b.error<this.zmin?this.zmin:b.value-b.error);b.z2=d.grz(b.value+b.error>this.zmax?this.zmax:b.value+b.error);b.color=this.tip_color;
return b};a.toplevel.add(l)};e.TH2Painter.prototype.DrawPolyLego=function(){var a=this.GetHisto(),b=this.frame_painter(),c=b.grz.domain()[0],d=b.grz.domain()[1],e,v=a.fBins.arr.length,r=0,m=b.grz(c),u=m;this.fContour=null;this.fCustomContour=!1;this.maxbin=this.gmaxbin;this.minbin=this.gminbin;this.minposbin=this.gminposbin;for(e=0;e<v;++e){var p=a.fBins.arr[e];if(!(p.fContent<c)){var f=this.getContourColor(p.fContent,!0);if(null!==f&&!(p.fXmin>b.scale_xmax||p.fXmax<b.scale_xmin||p.fYmin>b.scale_ymax||
p.fYmax<b.scale_ymin)){u=b.grz(p.fContent>d?d:p.fContent);var q=[],y=[],k=1,l=p.fPoly,n=0;"TMultiGraph"==l._typename&&(k=p.fPoly.fGraphs.arr.length,l=null);for(var h=0;h<k;++h){if(!l||0<h)l=p.fPoly.fGraphs.arr[h];for(var x=l.fNpoints,t=l.fX,D=l.fY;2<x&&t[0]===t[x-1]&&D[0]===D[x-1];)--x;for(var A,B,O=0;2>O;++O){var J=b.size_xy3d*b.size_z3d,H=0<O?0:J/1E6;A=[];B=null;for(var G=0;G<x;++G){var E=b.grx(t[G]);var F=b.gry(D[G]);0<G&&(J=(E-L)*(E-L)+(F-I)*(F-I));if(J>H){A.push(new g.Vector2(E,F));var L=E;var I=
F}}try{2<A.length&&(B=g.ShapeUtils.triangulateShape(A,[]))}catch(C){B=null}if(B&&B.length>A.length-3)break}B&&B.length&&A&&(q.push(A),y.push(B),n+=2*B.length,u>m&&(n+=2*A.length))}p=new Float32Array(9*n);for(h=k=0;h<q.length;++h){A=q[h];B=y[h];for(l=0;2>l;++l)for(n=0;n<B.length;++n)D=B[n],x=A[D[0]],t=A[D[0===l?2:1]],D=A[D[0===l?1:2]],p[k]=x.x,p[k+1]=x.y,p[k+2]=l?u:m,k+=3,p[k]=t.x,p[k+1]=t.y,p[k+2]=l?u:m,k+=3,p[k]=D.x,p[k+1]=D.y,p[k+2]=l?u:m,k+=3;if(u>m)for(n=0;n<A.length;++n)x=A[n],t=A[0<n?n-1:A.length-
1],p[k]=x.x,p[k+1]=x.y,p[k+2]=m,k+=3,p[k]=t.x,p[k+1]=t.y,p[k+2]=m,k+=3,p[k]=t.x,p[k+1]=t.y,p[k+2]=u,k+=3,p[k]=x.x,p[k+1]=x.y,p[k+2]=m,k+=3,p[k]=t.x,p[k+1]=t.y,p[k+2]=u,k+=3,p[k]=x.x,p[k+1]=x.y,p[k+2]=u,k+=3}q=new g.BufferGeometry;q.addAttribute("position",new g.BufferAttribute(p,3));q.computeVertexNormals();f=this.fPalette.getColor(f);f=new g.MeshBasicMaterial({color:f,flatShading:!0});f=new g.Mesh(q,f);b.toplevel.add(f);f.painter=this;f.bins_index=e;f.draw_z0=m;f.draw_z1=u;f.tip_color=65280;f.tooltip=
function(a){a=this.painter;var b=a.frame_painter(),c=a.GetObject().fBins.arr[this.bins_index];return{use_itself:!0,x1:b.grx(c.fXmin),x2:b.grx(c.fXmax),y1:b.gry(c.fYmin),y2:b.gry(c.fYmax),z1:this.draw_z0,z2:this.draw_z1,bin:this.bins_index,value:c.fContent,color:this.tip_color,lines:a.ProvidePolyBinHints(this.bins_index)}};r++}}}};Q.prototype=Object.create(e.THistPainter.prototype);Q.prototype.ScanContent=function(a){if(!(a&&this.nbinsx&&this.nbinsy&&this.nbinsz)){a=this.GetObject();this.nbinsx=a.fXaxis.fNbins;
this.nbinsy=a.fYaxis.fNbins;this.nbinsz=a.fZaxis.fNbins;this.xmin=a.fXaxis.fXmin;this.xmax=a.fXaxis.fXmax;this.ymin=a.fYaxis.fXmin;this.ymax=a.fYaxis.fXmax;this.zmin=a.fZaxis.fXmin;this.zmax=a.fZaxis.fXmax;this.gminbin=this.gmaxbin=a.getBinContent(1,1,1);for(var b=0;b<this.nbinsx;++b)for(var c=0;c<this.nbinsy;++c)for(var d=0;d<this.nbinsz;++d){var e=a.getBinContent(b+1,c+1,d+1);e<this.gminbin?this.gminbin=e:e>this.gmaxbin&&(this.gmaxbin=e)}this.draw_content=0<this.gmaxbin;this.CreateAxisFuncs(!0,
!0)}};Q.prototype.CountStat=function(){var a=this.GetHisto(),b=a.fXaxis,c=a.fYaxis,d=a.fZaxis,e=0,g=0,r=0,m=0,u=0,p=0,f=0,q=this.GetSelectIndex("x","left"),y=this.GetSelectIndex("x","right"),k=this.GetSelectIndex("y","left"),l=this.GetSelectIndex("y","right"),n=this.GetSelectIndex("z","left"),h=this.GetSelectIndex("z","right"),x=this.frame_painter(),t={name:a.fName,entries:0,integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0},D,A,B;for(D=0;D<this.nbinsx+2;++D){var O=b.GetBinCoord(D-.5);var J=
D<q?0:D>y?2:1;for(A=0;A<this.nbinsy+2;++A){var H=c.GetBinCoord(A-.5);var G=A<k?0:A>l?2:1;for(B=0;B<this.nbinsz+2;++B){var E=d.GetBinCoord(B-.5);var F=B<n?0:B>h?2:1;var L=a.getBinContent(D,A,B);t.entries+=L;1==J&&1==G&&1==F&&(e+=L,g+=O*L,r+=H*L,m+=E*L,u+=O*O*L,p+=H*H*L,f+=E*E*L)}}}0<a.fTsumw&&!x.IsAxisZoomed("x")&&!x.IsAxisZoomed("y")&&!x.IsAxisZoomed("z")&&(e=a.fTsumw,g=a.fTsumwx,u=a.fTsumwx2,r=a.fTsumwy,p=a.fTsumwy2,m=a.fTsumwz,f=a.fTsumwz2);0<e&&(t.meanx=g/e,t.meany=r/e,t.meanz=m/e,t.rmsx=Math.sqrt(Math.abs(u/
e-t.meanx*t.meanx)),t.rmsy=Math.sqrt(Math.abs(p/e-t.meany*t.meany)),t.rmsz=Math.sqrt(Math.abs(f/e-t.meanz*t.meanz)));t.integral=e;1<a.fEntries&&(t.entries=a.fEntries);return t};Q.prototype.FillStatistic=function(a,b,c){if(this.IgnoreStatsFill())return!1;var d=this.CountStat(),e=b%10,g=Math.floor(b/10)%10,r=Math.floor(b/100)%10,m=Math.floor(b/1E3)%10;b=Math.floor(b/1E6)%10;a.ClearPave();0<e&&a.AddText(d.name);0<g&&a.AddText("Entries = "+a.Format(d.entries,"entries"));0<r&&(a.AddText("Mean x = "+a.Format(d.meanx)),
a.AddText("Mean y = "+a.Format(d.meany)),a.AddText("Mean z = "+a.Format(d.meanz)));0<m&&(a.AddText("Std Dev x = "+a.Format(d.rmsx)),a.AddText("Std Dev y = "+a.Format(d.rmsy)),a.AddText("Std Dev z = "+a.Format(d.rmsz)));0<b&&a.AddText("Integral = "+a.Format(d.integral,"entries"));c&&a.FillFunctionStat(this.FindFunction("TF1"),c);return!0};Q.prototype.GetBinTips=function(a,b,c){var d=[],g=this.frame_painter(),v=this.GetHisto();d.push(this.GetTipName());"labels"==g.x_kind?d.push("x = "+g.AxisAsText("x",
v.fXaxis.GetBinLowEdge(a+1))+"  xbin="+(a+1)):d.push("x = ["+g.AxisAsText("x",v.fXaxis.GetBinLowEdge(a+1))+", "+g.AxisAsText("x",v.fXaxis.GetBinLowEdge(a+2))+")   xbin="+(a+1));"labels"==g.y_kind?d.push("y = "+g.AxisAsText("y",v.fYaxis.GetBinLowEdge(b+1))+"  ybin="+(b+1)):d.push("y = ["+g.AxisAsText("y",v.fYaxis.GetBinLowEdge(b+1))+", "+g.AxisAsText("y",v.fYaxis.GetBinLowEdge(b+2))+")  ybin="+(b+1));"labels"==g.z_kind?d.push("z = "+g.AxisAsText("z",v.fZaxis.GetBinLowEdge(c+1))+"  zbin="+(c+1)):d.push("z = ["+
g.AxisAsText("z",v.fZaxis.GetBinLowEdge(c+1))+", "+g.AxisAsText("z",v.fZaxis.GetBinLowEdge(c+2))+")  zbin="+(c+1));a=v.getBinContent(a+1,b+1,c+1);a===Math.round(a)?d.push("entries = "+a):d.push("entries = "+e.FFormat(a,e.gStyle.fStatFormat));return d};Q.prototype.Draw3DScatter=function(){var a=this.GetObject(),b=this.frame_painter(),c=this.GetSelectIndex("x","left",.5),d=this.GetSelectIndex("x","right",0),z=this.GetSelectIndex("y","left",.5),v=this.GetSelectIndex("y","right",0),r=this.GetSelectIndex("z",
"left",.5),m=this.GetSelectIndex("z","right",0);this.GetTipName("<br/>");var u,p,f;if(d<=c||v<=z||m<=r)return!0;var q=1E3<this.gmaxbin?1E3/this.gmaxbin:1,y=0,k=0,l=Math.max(0,this.gminbin);for(u=c;u<d;++u)for(p=z;p<v;++p)for(f=r;f<m;++f){var n=a.getBinContent(u+1,p+1,f+1);k+=n;n<=l||(y+=Math.round(n*q))}if(y>(b.webgl?1E5:3E4))return!1;e.seed(k);k=new e.Painter.PointsCreator(y,b.webgl,b.size_xy3d/200);y=new Int32Array(y);var h=0;for(u=c;u<d;++u)for(p=z;p<v;++p)for(f=r;f<m;++f)if(n=a.getBinContent(u+
1,p+1,f+1),!(n<=l))for(c=Math.round(n*q),n=0;n<c;++n){var x=a.fXaxis.GetBinCoord(u+e.random()),t=a.fYaxis.GetBinCoord(p+e.random()),D=a.fZaxis.GetBinCoord(f+e.random());y[h++]=a.getBin(u+1,p+1,f+1);k.AddPoint(b.grx(x),b.gry(t),b.grz(D))}d=k.CreatePoints(this.get_color(a.fMarkerColor));b.toplevel.add(d);d.bins=y;d.painter=this;d.tip_color=3===a.fMarkerColor?16711680:65280;d.tooltip=function(a){if(isNaN(a.index))return console.error("intersect.index not provided, check three.js version",g.REVISION,
"expected r97"),null;var b=Math.floor(a.index/this.nvertex);if(0>b||b>=this.bins.length)return null;var c=this.painter;a=c.GetHisto();var d=c.frame_painter();b=c.Get3DToolTip(this.bins[b]);b.x1=d.grx(a.fXaxis.GetBinLowEdge(b.ix));b.x2=d.grx(a.fXaxis.GetBinLowEdge(b.ix+1));b.y1=d.gry(a.fYaxis.GetBinLowEdge(b.iy));b.y2=d.gry(a.fYaxis.GetBinLowEdge(b.iy+1));b.z1=d.grz(a.fZaxis.GetBinLowEdge(b.iz));b.z2=d.grz(a.fZaxis.GetBinLowEdge(b.iz+1));b.color=this.tip_color;b.opacity=.3;return b};return!0};Q.prototype.Draw3DBins=
function(){if(this.draw_content&&(this.options.Box||this.options.GLBox||this.options.GLColor||this.options.Lego||!this.Draw3DScatter())){var a=this.GetObject().fFillColor,b=this.get_color(a),c=this.frame_painter(),d=0,z=!1,v=!1,r=!1,m=1,u=!0,p=this.options.Box?this.options.BoxStyle:0,f=.5;!p&&this.options.Lego&&(p=1===this.options.Lego?10:this.options.Lego);if(11===this.options.GLBox||12===this.options.GLBox){f=.4;z=!0;12===this.options.GLBox&&(r=!0);p=e.Painter.TestWebGL()?new g.SphereGeometry(.5,
16,12):new g.SphereGeometry(.5,8,6);p.applyMatrix((new g.Matrix4).makeRotationX(Math.PI/2));d=9*p.faces.length;var q=new Float32Array(d);var y=new Float32Array(d);for(var k=0;k<p.faces.length;++k)q[9*k]=p.vertices[p.faces[k].a].x,q[9*k+1]=p.vertices[p.faces[k].a].y,q[9*k+2]=p.vertices[p.faces[k].a].z,q[9*k+3]=p.vertices[p.faces[k].b].x,q[9*k+4]=p.vertices[p.faces[k].b].y,q[9*k+5]=p.vertices[p.faces[k].b].z,q[9*k+6]=p.vertices[p.faces[k].c].x,q[9*k+7]=p.vertices[p.faces[k].c].y,q[9*k+8]=p.vertices[p.faces[k].c].z,
y[9*k]=p.faces[k].vertexNormals[0].x,y[9*k+1]=p.faces[k].vertexNormals[0].y,y[9*k+2]=p.faces[k].vertexNormals[0].z,y[9*k+3]=p.faces[k].vertexNormals[1].x,y[9*k+4]=p.faces[k].vertexNormals[1].y,y[9*k+5]=p.faces[k].vertexNormals[1].z,y[9*k+6]=p.faces[k].vertexNormals[2].x,y[9*k+7]=p.faces[k].vertexNormals[2].y,y[9*k+8]=p.faces[k].vertexNormals[2].z}else{k=e.Painter.Box3D.Indexes;var l=e.Painter.Box3D.Normals,n=e.Painter.Box3D.Vertices;d=3*k.length;q=new Float32Array(d);y=new Float32Array(d);for(var h=
0,x=-3;h<k.length;++h){var t=n[k[h]];q[3*h]=t.x-.5;q[3*h+1]=t.y-.5;q[3*h+2]=t.z-.5;0===h%6&&(x+=3);y[3*h]=l[x];y[3*h+1]=l[x+1];y[3*h+2]=l[x+2]}v=!0;12===p?r=!0:13===p?(r=!0,v=!1):this.options.GLColor&&(r=!0,m=.5,v=u=!1,z=!0)}u&&(u=this.gminbin||this.gmaxbin?1/Math.max(Math.abs(this.gminbin),Math.abs(this.gmaxbin)):1);var D=this.GetHisto(),A=this.GetSelectIndex("x","left",.5),B=this.GetSelectIndex("x","right",0),O=this.GetSelectIndex("y","left",.5),J=this.GetSelectIndex("y","right",0),H=this.GetSelectIndex("z",
"left",.5),G=this.GetSelectIndex("z","right",0);this.GetTipName("<br/>");if(!(B<=A||J<=O||G<=H)){p=(c.grx(D.fXaxis.GetBinLowEdge(B+1))-c.grx(D.fXaxis.GetBinLowEdge(A+1)))/(B-A);k=(c.gry(D.fYaxis.GetBinLowEdge(J+1))-c.gry(D.fYaxis.GetBinLowEdge(O+1)))/(J-O);l=(c.grz(D.fZaxis.GetBinLowEdge(G+1))-c.grz(D.fZaxis.GetBinLowEdge(H+1)))/(G-H);var E=0,F,L;n=[];var I=0;x=[];for(F=A;F<B;++F)for(L=O;L<J;++L)for(h=H;h<G;++h)if(t=D.getBinContent(F+1,L+1,h+1),!(0===t||t<this.gminbin)){var C=u?Math.pow(Math.abs(t*
u),.3333):1;if(!(.001>C)&&(E++,r)){var w=this.getContourColor(t,!0);null!==w?(void 0===n[w]&&(n[w]=0,x[w]=I++),n[w]+=1):console.error("not found color for",t)}}r||(n.push(E),I=1,x=[0]);var K=Array(I),M=Array(I),R=Array(I),Q=Array(I),N=Array(I),Y=Array(I);I=Array(I);for(h=0;h<n.length;++h)n[h]&&(E=n[h],w=x[h],K[w]=0,N[w]=0,v&&(N[w]=65520<E*d/3?2:1),M[w]=new Float32Array(E*d),R[w]=new Float32Array(E*d),Q[w]=new Int32Array(E),1===N[w]&&(Y[w]=new Uint16Array(E*e.Painter.Box3D.MeshSegments.length)),2===
N[w]&&(I[w]=new Float32Array(E*e.Painter.Box3D.Segments.length*3)));for(F=A;F<B;++F)for(h=D.fXaxis.GetBinCenter(F+1),v=c.grx(h),L=O;L<J;++L)for(h=D.fYaxis.GetBinCenter(L+1),A=c.gry(h),h=H;h<G;++h)if(t=D.getBinContent(F+1,L+1,h+1),!(0===t||t<this.gminbin||(C=u?Math.pow(Math.abs(t*u),.3333):1,.001>C))){w=0;if(r){w=this.getContourColor(t,!0);if(null===w)continue;w=x[w]}E=K[w];t=D.fZaxis.GetBinCenter(h+1);var Z=c.grz(t);Q[w][E]=D.getBin(F+1,L+1,h+1);var S=E*d;t=M[w];for(var U=R[w],P=0;P<d;P+=3,S+=3)t[S]=
v+q[P]*p*C,t[S+1]=A+q[P+1]*k*C,t[S+2]=Z+q[P+2]*l*C,U[S]=y[P],U[S+1]=y[P+1],U[S+2]=y[P+2];if(1===N[w]){U=e.Painter.Box3D.MeshSegments;S=E*U.length;t=Math.round(E*d/3);var W=Y[w];for(P=0;P<U.length;++P)W[S+P]=t+U[P]}if(2===N[w])for(U=e.Painter.Box3D.Segments,W=I[w],S=E*U.length*3,P=0;P<U.length;++P,S+=3)t=e.Painter.Box3D.Vertices[U[P]],W[S]=v+(t.x-.5)*p*C,W[S+1]=A+(t.y-.5)*k*C,W[S+2]=Z+(t.z-.5)*l*C;K[w]=E+1}for(h=0;h<n.length;++h)n[h]&&(E=n[h],w=x[h],q=new g.BufferGeometry,q.addAttribute("position",
new g.BufferAttribute(M[w],3)),q.addAttribute("normal",new g.BufferAttribute(R[w],3)),r&&(b=this.fPalette.getColor(h)),y=z?new g.MeshLambertMaterial({color:b,opacity:m,transparent:1>m}):new g.MeshBasicMaterial({color:b,opacity:m}),q=new g.Mesh(q,y),q.bins=Q[w],q.bins_faces=d/9,q.painter=this,q.scalex=f*p,q.scaley=f*k,q.scalez=f*l,q.tip_color=3===a?16711680:65280,q.use_scale=u,q.tooltip=function(a){if(isNaN(a.faceIndex))return console.error("intersect.faceIndex not provided, check three.js version",
g.REVISION,"expected r97"),null;var b=Math.floor(a.faceIndex/this.bins_faces);if(0>b||b>=this.bins.length)return null;var c=this.painter;a=c.GetHisto();var d=c.frame_painter();b=c.Get3DToolTip(this.bins[b]);c=d.grx(a.fXaxis.GetBinCoord(b.ix-.5));var f=d.gry(a.fYaxis.GetBinCoord(b.iy-.5));a=d.grz(a.fZaxis.GetBinCoord(b.iz-.5));d=this.use_scale?Math.pow(Math.abs(b.value*this.use_scale),.3333):1;b.x1=c-this.scalex*d;b.x2=c+this.scalex*d;b.y1=f-this.scaley*d;b.y2=f+this.scaley*d;b.z1=a-this.scalez*d;
b.z2=a+this.scalez*d;b.color=this.tip_color;return b},c.toplevel.add(q),0<N[w]&&(q=this.get_color(this.GetObject().fLineColor),q=new g.LineBasicMaterial({color:q}),y=null,y=1===N[w]?e.Painter.createLineSegments(M[w],q,Y[w]):e.Painter.createLineSegments(I[w],q),c.toplevel.add(y)))}}};Q.prototype.Redraw=function(a){var b=this.frame_painter(),c=this.GetHisto();a?b.Resize3D()&&b.Render3D():(b.Create3DScene(),b.SetAxesRanges(c.fXaxis,this.xmin,this.xmax,c.fYaxis,this.ymin,this.ymax,c.fZaxis,this.zmin,
this.zmax),b.Set3DOptions(this.options),b.DrawXYZ(b.toplevel,{zoom:e.gStyle.Zooming,ndim:3}),this.Draw3DBins(),b.Render3D(),this.UpdateStatWebCanvas(),b.AddKeysHandler());this.DrawTitle()};Q.prototype.FillToolbar=function(){var a=this.pad_painter();a&&(a.AddButton(e.ToolbarIcons.auto_zoom,"Unzoom all axes","ToggleZoom","Ctrl *"),this.draw_content&&a.AddButton(e.ToolbarIcons.statbox,"Toggle stat box","ToggleStatBox"),a.ShowButtons())};Q.prototype.CanZoomIn=function(a,b,c){var d=this.GetHisto();d&&
(d=d["f"+a.toUpperCase()+"axis"]);return!d||1<d.FindBin(c,.5)-d.FindBin(b,0)};Q.prototype.AutoZoom=function(){var a=this.GetSelectIndex("x","left"),b=this.GetSelectIndex("x","right"),c=this.GetSelectIndex("y","left"),d=this.GetSelectIndex("y","right"),e=this.GetSelectIndex("z","left"),g=this.GetSelectIndex("z","right"),r,m,u,p=this.GetObject();if(a!==b&&c!==d&&e!==g){var f=p.getBinContent(a+1,c+1,e+1);for(r=a;r<b;++r)for(m=c;m<d;++m)for(u=e;u<g;++u)f=Math.min(f,p.getBinContent(r+1,m+1,u+1));if(!(0<
f)){var q=b,y=a,k=d,l=c,n=g,h=e;for(r=a;r<b;++r)for(m=c;m<d;++m)for(u=e;u<g;++u)p.getBinContent(r+1,m+1,u+1)>f&&(r<q&&(q=r),r>=y&&(y=r+1),m<k&&(k=m),m>=l&&(l=m+1),u<n&&(n=u),u>=h&&(h=u+1));r=!1;q===y-1&&q>a+1&&y<b-1&&(q--,y++);k===l-1&&k>c+1&&l<d-1&&(k--,l++);n===h-1&&n>e+1&&h<g-1&&(n--,h++);if((q>a||y<b)&&q<y-1){var x=p.fXaxis.GetBinLowEdge(q+1);var t=p.fXaxis.GetBinLowEdge(y+1);r=!0}if((k>c||l<d)&&k<l-1){var D=p.fYaxis.GetBinLowEdge(k+1);var A=p.fYaxis.GetBinLowEdge(l+1);r=!0}if((n>e||h<g)&&n<h-
1){var B=p.fZaxis.GetBinLowEdge(n+1);var K=p.fZaxis.GetBinLowEdge(h+1);r=!0}r&&this.frame_painter().Zoom(x,t,D,A,B,K)}}};Q.prototype.FillHistContextMenu=function(a){var b=e.getDrawSettings("ROOT."+this.GetObject()._typename,"nosame");a.addDrawMenu("Draw with",b.opts,function(a){if("inspect"===a)return this.ShowInspector();this.DecodeOptions(a);this.InteractiveRedraw(!0,"drawopt")})};e.Painter.drawHistogram3D=function(a,b,c){b=new e.TH3Painter(b);b.SetDivId(a,4);b.DecodeOptions(c);b.CheckPadRange();
b.ScanContent();b.Redraw();(a=b.CreateStat())&&e.draw(b.divid,a,"");b.FillToolbar();return b.DrawingReady()};fa.prototype=Object.create(e.TObjectPainter.prototype);fa.prototype.DecodeOptions=function(a){var b=new e.DrawOptions(a);this.options||(this.options={});var c=this.options;c.Color=b.check("COL");c.Line=b.check("LINE");c.Error=b.check("ERR")&&this.MatchObjectType("TGraph2DErrors");c.Circles=b.check("P0");c.Markers=b.check("P");c.Markers||c.Error||c.Circles||c.Line||(c.Markers=!0);c.Markers||
(c.Color=!1);this.OptionsStore(a)};fa.prototype.CreateHistogram=function(){for(var a=this.GetObject(),b=a.fX[0],c=b,d=a.fY[0],g=d,v=a.fZ[0],r=v,m=0;m<a.fNpoints;++m){var u=a.fX[m],p=a.fY[m],f=a.fZ[m],q=this.options.Error?a.fEX[m]:0,y=this.options.Error?a.fEY[m]:0,k=this.options.Error?a.fEZ[m]:0;b=Math.min(b,u-q);c=Math.max(c,u+q);d=Math.min(d,p-y);g=Math.max(g,p+y);v=Math.min(v,f-k);r=Math.max(r,f+k)}b>=c&&(c=b+1);d>=g&&(g=d+1);v>=r&&(r=v+1);m=.02*(c-b);p=.02*(g-d);q=.02*(r-v);a=b-m;m=c+m;u=d-p;p=
g+p;f=v-q;q=r+q;0>a&&0<=b&&(a=.98*b);0<m&&0>=c&&(m=0);0>u&&0<=d&&(u=.98*d);0<p&&0>=g&&(p=0);0>f&&0<=v&&(f=.98*v);0<q&&0>=r&&(q=0);b=this.GetObject();-1111!=b.fMinimum&&(f=b.fMinimum);-1111!=b.fMaximum&&(q=b.fMaximum);c=e.CreateHistogram("TH2I",10,10);c.fName=b.fName+"_h";c.fTitle=b.fTitle;c.fXaxis.fXmin=a;c.fXaxis.fXmax=m;c.fYaxis.fXmin=u;c.fYaxis.fXmax=p;c.fZaxis.fXmin=f;c.fZaxis.fXmax=q;c.fMinimum=f;c.fMaximum=q;c.fBits|=e.TH1StatusBits.kNoStats;return c};fa.prototype.Graph2DTooltip=function(a){if(isNaN(a.index))return console.error("intersect.index not provided, check three.js version",
g.REVISION,"expected r97"),null;var b=Math.floor(a.index/this.nvertex);if(0>b||b>=this.index.length)return null;b=this.index[b];var c=this.painter,d=c.grx(this.graph.fX[b]),e=c.gry(this.graph.fY[b]),v=c.grz(this.graph.fZ[b]);if(this.check_next&&b+1<this.graph.fX.length){var r=function(a){return a*a};a=a.point;var m=c.grx(this.graph.fX[b+1]),u=c.gry(this.graph.fY[b+1]),p=c.grz(this.graph.fZ[b+1]);r(a.x-m)+r(a.y-u)+r(a.z-p)<r(a.x-d)+r(a.y-e)+r(a.z-v)&&(d=m,e=u,v=p,b++)}return{x1:d-this.scale0,x2:d+
this.scale0,y1:e-this.scale0,y2:e+this.scale0,z1:v-this.scale0,z2:v+this.scale0,color:this.tip_color,lines:[this.tip_name,"pnt: "+b,"x: "+c.AxisAsText("x",this.graph.fX[b]),"y: "+c.AxisAsText("y",this.graph.fY[b]),"z: "+c.AxisAsText("z",this.graph.fZ[b])]}};fa.prototype.Redraw=function(){function a(a,b){for(var e=0,f=0;f<d.fNpoints;++f)d.fX[f]<c.scale_xmin||d.fX[f]>c.scale_xmax||d.fY[f]<c.scale_ymin||d.fY[f]>c.scale_ymax||d.fZ[f]<a||d.fZ[f]>=b||++e;return e}var b=this.main_painter(),c=this.frame_painter(),
d=this.GetObject(),z=1;if(d&&b&&c&&c.mode3d){if(0<e.gStyle.OptimizeDraw&&!c.webgl){var v=a(c.scale_zmin,c.scale_zmax);5E4<v&&(z=Math.floor(v/5E4),2>=z&&(z=2))}var r=new e.TAttMarkerHandler(d);v=null;var m=[c.scale_zmin,c.scale_zmax];r=c.size_xy3d/100*r.GetFullSize();this.options.Circles&&(r=.06*c.size_xy3d);c.usesvg&&(r*=.3);this.options.Color&&(m=b.GetContour(),v=b.GetPalette());for(b=0;b<m.length-1;++b){var u=Math.max(m[b],c.scale_zmin),p=Math.min(m[b+1],c.scale_zmax);if(!(u>=p)){var f=Math.floor(a(u,
p)/z),q=null,y=0,k=new Int32Array(f),l=0,n=null,h=null,x=0,t=0;if(this.options.Markers||this.options.Circles)q=new e.Painter.PointsCreator(f,c.webgl,r/3);this.options.Error&&(n=new Float32Array(18*f));this.options.Line&&(h=new Float32Array(6*(f-1)));for(f=0;f<d.fNpoints;++f)if(!(d.fX[f]<c.scale_xmin||d.fX[f]>c.scale_xmax||d.fY[f]<c.scale_ymin||d.fY[f]>c.scale_ymax||d.fZ[f]<u||d.fZ[f]>=p)){if(1<z&&(y=(y+1)%z,0!==y))continue;k[l++]=f;var D=c.grx(d.fX[f]),A=c.gry(d.fY[f]),B=c.grz(d.fZ[f]);q&&q.AddPoint(D,
A,B);n&&(n[x]=c.grx(d.fX[f]-d.fEX[f]),n[x+1]=A,n[x+2]=B,n[x+3]=c.grx(d.fX[f]+d.fEX[f]),n[x+4]=A,n[x+5]=B,x+=6,n[x]=D,n[x+1]=c.gry(d.fY[f]-d.fEY[f]),n[x+2]=B,n[x+3]=D,n[x+4]=c.gry(d.fY[f]+d.fEY[f]),n[x+5]=B,x+=6,n[x]=D,n[x+1]=A,n[x+2]=c.grz(d.fZ[f]-d.fEZ[f]),n[x+3]=D,n[x+4]=A,n[x+5]=c.grz(d.fZ[f]+d.fEZ[f]),x+=6);h&&(6<=t&&(h[t]=h[t-3],h[t+1]=h[t-2],h[t+2]=h[t-1],t+=3),h[t]=D,h[t+1]=A,h[t+2]=B,t+=3)}h&&3<t&&h.length==t&&(u=this.get_color(this.GetObject().fLineColor),u=new g.LineBasicMaterial({color:new g.Color(u)}),
e.browser.isIE||(u.linewidth=this.GetObject().fLineWidth),h=e.Painter.createLineSegments(h,u),c.toplevel.add(h),h.graph=d,h.index=k,h.painter=c,h.scale0=.7*r,h.tip_name=this.GetTipName(),h.tip_color=3===d.fMarkerColor?16711680:65280,h.nvertex=2,h.check_next=!0,h.tooltip=this.Graph2DTooltip);n&&(u=this.get_color(this.GetObject().fLineColor),u=new g.LineBasicMaterial({color:new g.Color(u)}),e.browser.isIE||(u.linewidth=this.GetObject().fLineWidth),n=e.Painter.createLineSegments(n,u),c.toplevel.add(n),
n.graph=d,n.index=k,n.painter=c,n.scale0=.7*r,n.tip_name=this.GetTipName(),n.tip_color=3===d.fMarkerColor?16711680:65280,n.nvertex=6,n.tooltip=this.Graph2DTooltip);q&&(n="blue",this.options.Circles||(n=v?v.calcColor(b,m.length):this.get_color(d.fMarkerColor)),q=q.CreatePoints(n),c.toplevel.add(q),q.graph=d,q.index=k,q.painter=c,q.scale0=.3*r,q.tip_name=this.GetTipName(),q.tip_color=3===d.fMarkerColor?16711680:65280,q.tooltip=this.Graph2DTooltip)}}c.Render3D(100)}};e.Painter.drawGraph2D=function(a,
b,c){var d=new e.TGraph2DPainter(b);d.SetDivId(a,-1);d.DecodeOptions(c);if(d.main_painter())return d.SetDivId(a),d.Redraw(),d.DrawingReady();b.fHistogram||(b.fHistogram=d.CreateHistogram());e.draw(a,b.fHistogram,"lego;axis",function(b){d.ownhisto=!0;d.SetDivId(a);d.Redraw();return d.DrawingReady()});return d};e.Painter.drawPolyMarker3D=function(a,b,c){c=new e.TObjectPainter(b);c.SetDivId(a);c.Redraw=function(){var a=this.frame_painter();if(a&&a.mode3d){for(var c=1,v=0,r=0;r<b.fP.length;r+=3)b.fP[r]<
a.scale_xmin||b.fP[r]>a.scale_xmax||b.fP[r+1]<a.scale_ymin||b.fP[r+1]>a.scale_ymax||b.fP[r+2]<a.scale_zmin||b.fP[r+2]>a.scale_zmax||++v;0<e.gStyle.OptimizeDraw&&5E4<v&&(c=Math.floor(v/5E4),2>=c&&(c=2));r=Math.floor(v/c);v=new e.Painter.PointsCreator(r,a.webgl,a.size_xy3d/100);var m=new Int32Array(r),u=0,p=0;for(r=0;r<b.fP.length;r+=3)if(!(b.fP[r]<a.scale_xmin||b.fP[r]>a.scale_xmax||b.fP[r+1]<a.scale_ymin||b.fP[r+1]>a.scale_ymax||b.fP[r+2]<a.scale_zmin||b.fP[r+2]>a.scale_zmax)){if(1<c&&(u=(u+1)%c,
0!==u))continue;m[p++]=r;v.AddPoint(a.grx(b.fP[r]),a.gry(b.fP[r+1]),a.grz(b.fP[r+2]))}c=v.CreatePoints(this.get_color(b.fMarkerColor));a.toplevel.add(c);c.tip_color=3===b.fMarkerColor?16711680:65280;c.tip_name=b.fName||"Poly3D";c.poly=b;c.painter=a;c.scale0=.7*v.scale;c.index=m;c.tooltip=function(a){if(isNaN(a.index))return console.error("intersect.index not provided, check three.js version",g.REVISION,"expected r97"),null;a=Math.floor(a.index/this.nvertex);if(0>a||a>=this.index.length)return null;
a=this.index[a];var b=this.painter,c=b.grx(this.poly.fP[a]),d=b.gry(this.poly.fP[a+1]),e=b.grz(this.poly.fP[a+2]);return{x1:c-this.scale0,x2:c+this.scale0,y1:d-this.scale0,y2:d+this.scale0,z1:e-this.scale0,z2:e+this.scale0,color:this.tip_color,lines:[this.tip_name,"pnt: "+a/3,"x: "+b.AxisAsText("x",this.poly.fP[a]),"y: "+b.AxisAsText("y",this.poly.fP[a+1]),"z: "+b.AxisAsText("z",this.poly.fP[a+2])]}};a.Render3D(100)}};c.Redraw();return c.DrawingReady()};e.TH3Painter=Q;e.TGraph2DPainter=fa;return e});
